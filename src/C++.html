

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>C++ &mdash; Cheatsheet 1.0.0 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Math" href="Math.html" />
    <link rel="prev" title="CMake" href="CMake.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cheatsheet
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="reStructuresText.html">reStructuresText</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx.html">sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="Encoding.html">Charset and Encoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="Graphviz.html">Graphviz - Graph Visualization Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">git</a></li>
<li class="toctree-l1"><a class="reference internal" href="CMake.html">CMake</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">C++</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">C++ reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">1 语言</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.1 基本概念</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.2 关键字</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">1.3 预处理器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">1.4 表达式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">1.5 声明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">1.6 初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">1.7 函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">1.8 语句</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">1.9 类</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">1.10 重载</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">1.11 模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">1.12 异常</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">1.13 杂项</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">1.14 惯用手法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#c-20">2 功能特性测试宏（C++20）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">3 语言支持库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">4 诊断库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">5 通用工具库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">6 字符串库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#std-basic-string">6.1 std::basic_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#std-basic-string-view-c-17">6.2 std::basic_string_view（C++17）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">6.3 空终止字符串</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id22">7 容器库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id23">7.1 顺序容器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">7.2 关联容器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">7.3 无序关联容器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">7.4 容器适配器</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id27">8 迭代器库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">9 范围库（C++20）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id29">10 算法库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id30">10.1 不修改序列的操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">10.2 修改序列的操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">10.3 划分操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">10.4 排序操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">10.5 二分搜索操作（在已排序范围上）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">10.6 其它已排序范围上的操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">10.7 集合操作（在已排序范围上）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id37">10.8 堆操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id38">10.9 最小、最大操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id39">10.10 比较操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id40">10.11 排列操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id41">10.12 数值运算</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id42">10.13 未初始化内存上的操做</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id43">11 数值库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id44">11.1 数学函数与类型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id49">11.2 数值算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id53">11.3 杂项</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id57">12 输入输出库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id58">13 文件系统库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id59">14 本地化库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id60">15 正则表达式库（C++11）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id61">16 原子操作库（C++11）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id62">17 线程支持库（C++11）</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#c-primer-fifth-edition">C++ Primer, Fifth Edition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id63">C++ 11 的新特性</a></li>
<li class="toctree-l3"><a class="reference internal" href="#i-c">第Ⅰ部分 C++基础</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id64">第2章 变量和基本类型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id103">第3章 字符串、向量和数组</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id104">第4章 表达式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id105">第5章 语句</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id106">第6章 函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id107">第7章 类</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ii-c">第Ⅱ部分 C++标准库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#io">第8章 IO库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id108">第9章 顺序容器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id109">第10章 泛型算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id110">第11章 关联容器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id111">第12章 动态内存</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#iii">第Ⅲ部分 类设计者的工具</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id112">第13章 拷贝控制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id113">第14章 重载运算与类型转换</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id114">第15章 面向对象程序设计</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id115">第16章 模板与泛型编程</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#iv">第Ⅳ部分 高级主题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id116">第17章 标准库特殊设施</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id117">第18章 用于大型程序的工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id118">第19章 特殊工具与技术</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id119">C++ Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id120">个人总结</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preprocessor">预处理器（preprocessor）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id121">1. 预处理器指令（ Preprocessor directives ）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id124">2. 预处理器运算符（ Preprocessor operators ）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id125">3. 预定义的宏（ Predefined macros ）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id126">4. 编译指示（ Pragmas ）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id127">宏的使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id128">1. 如何调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id129">2. 特殊符号</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id130">3. 符号拼接</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id131">4. 自增自减</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id132">5. 逻辑运算</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id133">6. 布尔转换</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id134">7. 条件选择</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id135">8. 惰性求值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id136">9. 变长参数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id137">10. 下标访问</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id138">11. 长度判空</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id139">12. 长度计算</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id140">13. 遍历访问</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id141">14. 符号匹配</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id142">16. 递归重入</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id143">17. 条件循环</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id144">18. 延迟展开</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id145">19. 数值运算</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id146">20. 数值比较</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id147">21. 结合模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id148">一、 #define 的基本用法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id157">二、 #define 中的三个特殊符号： #，##，#&#64;</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id159">三、 常用的一些宏定义</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#const-or-constexpr">const or constexpr</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#effective-c">Effective C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="#more-effective-c">More Effective c++</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-cherno">The Cherno</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#windows-c">1. 在 Windows 系统中设置 C++ 开发环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id160">2. C++ 是如何工作的</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id161">3. C++ 编译器是如何工作的</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id162">4. C++ 链接器是如何工作的</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id163">5. C++ 中的变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id164">6. C++ 中的函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id165">7. C++ 中的头文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visual-studio-c">8. 如何在 Visual Studio 中调试 C++ 程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-if">9. C++ 中的条件和分支（ if语句 ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-visual-studio">10. 关于 C++ 程序最好的 Visual  Studio 设置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-for-while">11. C++ 中的循环（for, while）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-continue-break-return">12. C++ 中的流程控制（continue, break, return）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id166">13. C++ 中的指针</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id167">14. C++ 中的引用</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id168">15. C++ 中的类</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id169">16. C++ 中类和结构体的比较</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id170">17. 如何写一个 C++ 的类</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-static">18. C++ 中的 Static</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id171">19. C++ 类和结构体中的 static</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-local-static">20. C++ 中的 Local Static</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id172">21. C++  中的枚举</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id173">22. C++ 中的构造函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id174">23. C++ 中的析构函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id175">24. C++ 中的继承</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id176">25. C++ 中的虚函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id177">26. C++ 中的接口（纯虚函数）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id178">27. C++ 中的可见性（作用域）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id179">28. C++ 中的数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-stirng">29. C++ 中的 Stirng 是如何工作的</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id180">30. C++ 中的 Stirng 字面量</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id181">31. C++ 中的常量</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-mutable">32. C++ 中的 Mutable 关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id182">33. C++ 中的成员初始化列表（构造函数初始化器列表）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id183">34. 三元运算符</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id184">35. C++ 中如何创建并初始化对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-new">36. C++ 中的 NEW 关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-explict">37. C++ 中的隐式转换和 Explict 关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id185">38. C++ 中的操作符和操作符重载</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-this">39. C++ 中的 this 关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id186">40. C++ 中的对象生命周期</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id187">41. C++ 中的智能指针</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copying-and-copy-constructors-in-c">42. Copying and Copy Constructors in C++</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id188">43. C++ 中的箭头（-&gt;）操作符</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id189">44. C++ 中的动态数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-std-vector">45. C++ 中的 std-vector 使用优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id190">46. C++ 中库的使用（静态链接）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id191">47. C++ 中使用动态链接库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id192">48. 创建和使用 C++ 库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id193">49. C++ 中如何处理多个返回值</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id194">50. C++ 中的模板</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id195">51. C++ 中的栈和堆</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id196">52. C++ 中的宏</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-auto">53. C++ 中的 auto 关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id197">54. C++ 中的静态数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id198">55. C++ 中的函数指针</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-lambda">56. C++ 中的 Lambda 表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#std">57. 为什么不使用 std 命名空间</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id199">58. C++ 中的命名空间</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id200">59. C++ 中的线程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-timing">60. C++ 中的计时（Timing）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id201">61. C++ 中的多维数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id202">62. C++ 中的排序</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-type-punning">63. C++ 中的（Type Punning）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-unions">64. C++ 中的 Unions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id203">65. C++ 中的虚构造函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id204">66. C++ 中的类型转换</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id205">67. C++ 中的条件和动作断点</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id206">68. 现代 C++ 中的安全</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id207">69. C++ 中的预编译头文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-dynamic-casting">70. C++ 中的动态类型转换（Dynamic Casting）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id208">71. C++ 中的性能测试（如何测量性能）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-17-structured-bindings">72. C++ 17 中的结构化绑定（Structured Bindings）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-17-optional-data">73. C++ 17 中如何处理可选数据（Optional Data）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id209">74. C++ 17 中让一个变量拥有多种类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-17-how-to-store-any-data-in-c">75. C++ 17 How to store ANY data in C++</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-std-async">76. 如何让 C++ 运行更快（std-async）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-17-string">77. C++ 17 如何让 String 更快</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id210">78. C++ 中让性能测试可视化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id211">79. C++ 中的单例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id212">80. C++ 中对短字符串的优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id213">81. C++ 中以最简单的方式对内存分配进行跟踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id214">82. C++ 的左值和右值</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id215">83. C++ 中的持续集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id216">84. C++ 中的静态分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-evaluation">85. C++ 中参数 evaluation 顺序</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-move-semantics">86. C++ 中的 Move 含义（semantics）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-move-move-assigment">87. C++ 中的 Move 和 move assigment 操作符</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-array">88. C++ 中的设计数据结构 -  ARRAY</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vector-dynamic-array">89. VECTOR DYNAMIC ARRAY - 设计数据结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id217">90. C++ 中的迭代器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id218">91. 在 C++ 中写一个迭代器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id219">92. 如何学习 C++</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#stl">STL 源码剖析</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id220">第一章 STL 概论与版本简介</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id221">可能令你困惑的 C++ 语法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id222">临时对象的产生与运用</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class">静态常量整数成员在 class 内部直接初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#increment-decrement-dereference">increment / decrement / dereference 操作符</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id223">前闭后开区间表示法 [)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fucntion-call-operator">fucntion call 操作符 （operator ()）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id224">第二章 空间配置器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id225">2.1 空间配置器的标准接口</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sub-allocation-sgi">2.2 具备次层配置力（sub-allocation）的 SGI 空间配置器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id226">2.3 内存基本处理工具</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#iterators-traits">第三章 迭代器（iterators）概念与 traits 编程技法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id227">3.1 迭代器设计思维 —— STL 关键所在</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iterator-smart-pointer">3.2 迭代器（iterator）是一种 smart pointer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#associated-types">3.3 迭代器相应类型（associated types）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#traits-stl">3.4 Traits 编程技法 —— STL 源代码门钥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#std-iterator">3.5 std::iterator 的保证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iterator">3.6 iterator 源代码完整重列</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sgi-stl-type-traits">3.7 SGI STL 的私房菜： __type_traits</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id228">第四章 序列式容器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id229">4.1 容器的概观与分类</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vector">4.2 vector</a></li>
<li class="toctree-l4"><a class="reference internal" href="#list">4.3 list</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#open-source-projects">Open Source Projects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id240">olcPixelGameEngine</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#c-templates">C++ Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#i">第Ⅰ部分 基础</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id241">第2章 函数模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id242">第3章 类模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id243">第4章 非类型模板参数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id244">第5章 技巧性基础知识</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id245">第6章 模板实战</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id246">第7章 模板术语</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ii">第Ⅱ部分 深入模板</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id247">第8章 深入模板基础</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id248">第9章 模板中的名称</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id249">第10章 实例化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id250">第11章 模板实参演绎</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id251">第12章 特化与重载</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id252">第13章 未来的方向</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id253">第Ⅲ部分 模板与设计</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id254">第14章 模板的多态威力</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trait-policy">第15章 trait 与 policy 类</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id255">第16章 模板与继承</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metaprogram">第17章 metaprogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id256">第18章 表示式模板</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id257">第Ⅳ部分 高级应用程序</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id258">第19章 类型区分</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id259">第20章 智能指针</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tuple">第21章 tuple</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id260">第22章 函数对象和回调</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Math.html">Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImageProcessing.html">Image Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenCV.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenGL.html">OpenGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="GameEngine.html">GameEngine</a></li>
<li class="toctree-l1"><a class="reference internal" href="DTD.html">DTD</a></li>
<li class="toctree-l1"><a class="reference internal" href="XSD.html">XSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="WSDL.html">WSDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="dotnet.html">dotnet</a></li>
<li class="toctree-l1"><a class="reference internal" href="cmd.html">cmd</a></li>
<li class="toctree-l1"><a class="reference internal" href="SSH.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="Python.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="WindowsTerminal.html">Windows Terminal</a></li>
<li class="toctree-l1"><a class="reference internal" href="manim.html">manim</a></li>
<li class="toctree-l1"><a class="reference internal" href="NSIS.html">nullsoft scriptable install system 3.0.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="Algorithm.html">Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="Vocabulary.html">Vocabulary</a></li>
<li class="toctree-l1"><a class="reference internal" href="ECFDeploy.html">ECF AutoDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lua.html">Lua</a></li>
<li class="toctree-l1"><a class="reference internal" href="LaTeX.html">LaTeX</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ubuntu.html">Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="MEF.html">MEF in .NET Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="EMail.html">Relative Concepts of EMail</a></li>
<li class="toctree-l1"><a class="reference internal" href="FFmpeg.html">FFmpeg</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenSourceProjects.html">Open Source Projects</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cheatsheet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>C++</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/src/C++.rst.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="c">
<h1>C++<a class="headerlink" href="#c" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2><a class="reference external" href="https://en.cppreference.com/w/">C++ reference</a><a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="section" id="id2">
<h3>1 语言<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<div class="section" id="id3">
<h4>1.1 基本概念<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id4">
<h4>1.2 关键字<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id5">
<h4>1.3 预处理器<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id6">
<h4>1.4 表达式<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id7">
<h4>1.5 声明<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id8">
<h4>1.6 初始化<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id9">
<h4>1.7 函数<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id10">
<h4>1.8 语句<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id11">
<h4>1.9 类<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id12">
<h4>1.10 重载<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id13">
<h4>1.11 模板<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id14">
<h4>1.12 异常<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id15">
<h4>1.13 杂项<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id16">
<h4>1.14 惯用手法<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="c-20">
<h3>2 功能特性测试宏（C++20）<a class="headerlink" href="#c-20" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id17">
<h3>3 语言支持库<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id18">
<h3>4 诊断库<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id19">
<h3>5 通用工具库<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id20">
<h3>6 字符串库<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h3>
<p>C++ 字符串库支持三种通用字符串类型：</p>
<ul class="simple">
<li><p>std::basic_string —— 为操作任何字符类型的字符串设计的模板类。</p></li>
<li><p>std::basic_string_view（C++17）—— 对于字符串子序列的轻量无所有权的只读视图。</p></li>
<li><p>空终止字符串 —— 以特殊的空字符终止的字符数组。</p></li>
</ul>
<div class="section" id="std-basic-string">
<h4>6.1 std::basic_string<a class="headerlink" href="#std-basic-string" title="永久链接至标题">¶</a></h4>
<div class="figure align-center" id="id261">
<div class="graphviz"><object data="../_images/graphviz-1d43c3ac48778cb7f4b94d2d5d3b54be285ee34d.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    abc [shape = none, margin = 0, label = &lt;
        &lt;TABLE BORDER = '1' CELLBORDER = '0' CELLSPACING = '0' CELLPADDING = '8'&gt;
        &lt;TR&gt;&lt;TD BGCOLOR = 'lightgray'&gt;类型&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;定义&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;std::string&lt;/TD&gt;&lt;TD&gt;std::basic_string&amp;lt;char&amp;gt;&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;std::wstring&lt;/TD&gt;&lt;TD&gt;std::basic_string&amp;lt;wchar_t&amp;gt;&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;std::u8string（C++20 起）&lt;/TD&gt;&lt;TD&gt;std::basic_string&amp;lt;char8_t&amp;gt;&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;std::u16string（C++11 起）&lt;/TD&gt;&lt;TD&gt;std::basic_string&amp;lt;char16_t&amp;gt;&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;std::u32string（C++11 起）&lt;/TD&gt;&lt;TD&gt;std::basic_string&amp;lt;char32_t&amp;gt;&lt;/TD&gt;&lt;/TR&gt;
        &lt;/TABLE&gt;&gt;];
}</p></object></div>
<p class="caption"><span class="caption-text">标准提供 std::basic_string 对常用类型的数种特化</span><a class="headerlink" href="#id261" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="std-basic-string-view-c-17">
<h4>6.2 std::basic_string_view（C++17）<a class="headerlink" href="#std-basic-string-view-c-17" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id21">
<h4>6.3 空终止字符串<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="id22">
<h3>7 容器库<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h3>
<div class="section" id="id23">
<h4>7.1 顺序容器<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>array</p></li>
<li><p>vector</p></li>
<li><p>deque</p></li>
<li><p>forward_list（C++11 起）</p></li>
<li><p>list</p></li>
</ol>
</div>
<div class="section" id="id24">
<h4>7.2 关联容器<a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>set</p></li>
<li><p>map</p></li>
<li><p>multiset</p></li>
<li><p>multimap</p></li>
</ol>
</div>
<div class="section" id="id25">
<h4>7.3 无序关联容器<a class="headerlink" href="#id25" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>unordered_set（C++11 起）</p></li>
<li><p>unordered_map（C++11 起）</p></li>
<li><p>unordered_multiset（C++11 起）</p></li>
<li><p>unordered_multimap（C++11 起）</p></li>
</ol>
</div>
<div class="section" id="id26">
<h4>7.4 容器适配器<a class="headerlink" href="#id26" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>stack</p></li>
<li><p>queue</p></li>
<li><p>priority_queue</p></li>
<li><p>span（C++20）</p></li>
</ol>
</div>
</div>
<div class="section" id="id27">
<h3>8 迭代器库<a class="headerlink" href="#id27" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id28">
<h3>9 范围库（C++20）<a class="headerlink" href="#id28" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id29">
<h3>10 算法库<a class="headerlink" href="#id29" title="永久链接至标题">¶</a></h3>
<div class="section" id="id30">
<h4>10.1 不修改序列的操作<a class="headerlink" href="#id30" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id31">
<h4>10.2 修改序列的操作<a class="headerlink" href="#id31" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id32">
<h4>10.3 划分操作<a class="headerlink" href="#id32" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id33">
<h4>10.4 排序操作<a class="headerlink" href="#id33" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id34">
<h4>10.5 二分搜索操作（在已排序范围上）<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id35">
<h4>10.6 其它已排序范围上的操作<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id36">
<h4>10.7 集合操作（在已排序范围上）<a class="headerlink" href="#id36" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id37">
<h4>10.8 堆操作<a class="headerlink" href="#id37" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id38">
<h4>10.9 最小、最大操作<a class="headerlink" href="#id38" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id39">
<h4>10.10 比较操作<a class="headerlink" href="#id39" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id40">
<h4>10.11 排列操作<a class="headerlink" href="#id40" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id41">
<h4>10.12 数值运算<a class="headerlink" href="#id41" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id42">
<h4>10.13 未初始化内存上的操做<a class="headerlink" href="#id42" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="id43">
<h3>11 数值库<a class="headerlink" href="#id43" title="永久链接至标题">¶</a></h3>
<div class="section" id="id44">
<h4>11.1 数学函数与类型<a class="headerlink" href="#id44" title="永久链接至标题">¶</a></h4>
<div class="section" id="id45">
<h5>11.1.1 常用数学函数<a class="headerlink" href="#id45" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="c-17">
<h5>11.1.2 数学特殊函数（C++17 起）<a class="headerlink" href="#c-17" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id46">
<h5>11.1.3 数学常数（C++20 起）<a class="headerlink" href="#id46" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id47">
<h5>11.1.4 复数运算<a class="headerlink" href="#id47" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id48">
<h5>11.1.5 数值数组<a class="headerlink" href="#id48" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id49">
<h4>11.2 数值算法<a class="headerlink" href="#id49" title="永久链接至标题">¶</a></h4>
<div class="section" id="id50">
<h5>11.2.1 因数运算<a class="headerlink" href="#id50" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id51">
<h5>11.2.2 插值运算<a class="headerlink" href="#id51" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id52">
<h5>11.2.3 数值运算<a class="headerlink" href="#id52" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id53">
<h4>11.3 杂项<a class="headerlink" href="#id53" title="永久链接至标题">¶</a></h4>
<div class="section" id="id54">
<h5>11.3.1 伪随机数生成<a class="headerlink" href="#id54" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="c-11">
<h5>11.3.2 编译时有理数算术（C++11 起）<a class="headerlink" href="#c-11" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id55">
<h5>11.3.3 浮点环境（C++11 起）<a class="headerlink" href="#id55" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id56">
<h5>11.3.4 位操纵（C++20 起）<a class="headerlink" href="#id56" title="永久链接至标题">¶</a></h5>
</div>
</div>
</div>
<div class="section" id="id57">
<h3>12 输入输出库<a class="headerlink" href="#id57" title="永久链接至标题">¶</a></h3>
<div class="figure align-center" id="id262">
<div class="graphviz"><object data="../_images/graphviz-47ac5fedc52459b1be52f3a4ad408aceab6d1d8f.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    bgcolor = &quot;transparent&quot;
    rankdir = TB;
    node [shape=&quot;record&quot;];
    edge [dir=&quot;back&quot; arrowtail=&quot;empty&quot;];

    subgraph cluster_0 {
        l1 [label = &quot;ios_base&quot;];

        l2 [label = &quot;basic_ios\n\&lt;CharT, Traits\&gt;&quot;];

        l31 [label = &quot;basic_ostream\n\&lt;CharT, Traits\&gt;&quot;];
        l32 [label = &quot;basic_istream\n\&lt;CharT, Traits\&gt;&quot;];

        l4 [label = &quot;basic_iostream\n\&lt;CharT, Traits\&gt;&quot;];

        l51 [label = &quot;basic_ostringstream\n\&lt;CharT, Traits\&gt;&quot;];
        l52 [label = &quot;basic_stringstream\n\&lt;CharT, Traits\&gt;&quot;];
        l53 [label = &quot;basic_istringstream\n\&lt;CharT, Traits\&gt;&quot;];

        l61 [label = &quot;basic_oftringstream\n\&lt;CharT, Traits\&gt;&quot;];
        l62 [label = &quot;basic_fstream\n\&lt;CharT, Traits\&gt;&quot;];
        l63 [label = &quot;basic_ifstream\n\&lt;CharT, Traits\&gt;&quot;];

        l1-&gt;l2;
        l2-&gt;{l31 l32};
        {l31 l32}-&gt;l4;

        l31-&gt;l51;
        l31-&gt;l61:ne;

        l4-&gt;l52;
        l4-&gt;l62:ne;

        l32-&gt;{l53 l63};

        l4 -&gt; l51 [color = &quot;transparent&quot;];
        l4 -&gt; l53 [color = &quot;transparent&quot;];

        l51 -&gt; l61 [color = &quot;transparent&quot;];
        l52 -&gt; l62 [color = &quot;transparent&quot;];
        l53 -&gt; l63 [color = &quot;transparent&quot;];
    }
}</p></object></div>
<p class="caption"><span class="caption-text">继承图</span><a class="headerlink" href="#id262" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="id58">
<h3>13 文件系统库<a class="headerlink" href="#id58" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id59">
<h3>14 本地化库<a class="headerlink" href="#id59" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id60">
<h3>15 正则表达式库（C++11）<a class="headerlink" href="#id60" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id61">
<h3>16 原子操作库（C++11）<a class="headerlink" href="#id61" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id62">
<h3>17 线程支持库（C++11）<a class="headerlink" href="#id62" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="c-primer-fifth-edition">
<h2>C++ Primer, Fifth Edition<a class="headerlink" href="#c-primer-fifth-edition" title="永久链接至标题">¶</a></h2>
<div class="section" id="id63">
<h3>C++ 11 的新特性<a class="headerlink" href="#id63" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>long long 类型</p></li>
<li><p>列表初始化</p></li>
<li><p>nullptr 常量</p></li>
<li><p>constexpr 变量</p></li>
<li><p>类型别名声明</p></li>
<li><p>auto 类型指示符</p></li>
<li><p>decltype 类型指示符</p></li>
<li><p>类内初始化</p></li>
<li><p>使用 auto 或 decltype 缩写类型</p></li>
<li><p>范围 for 语句</p></li>
<li><p>定义 vector 对象的vector</p></li>
<li><p>vector 对象的列表初始化</p></li>
<li><p>容器的 cbegin 和 cend 函数</p></li>
<li><p>标准库的 begin 和 end 函数</p></li>
<li><p>使用 auto 和 decltype 简化声明</p></li>
<li><p>除法的舍入规则</p></li>
<li><p>用大括号包围的值列表赋值</p></li>
<li><p>将 sizeof 用于类成员</p></li>
<li><p>范围 for 语句</p></li>
<li><p>标准库 initializer_list 类</p></li>
<li><p>列表初始化返回值</p></li>
<li><p>定义尾置返回类型</p></li>
<li><p>使用 decltype 简化返回类型定义</p></li>
<li><p>constexpr 函数</p></li>
<li><p>用 string 对象处理文件名</p></li>
<li><p>array 和 forward_list 容器</p></li>
<li><p>容器的 cbegin 和 cend 函数</p></li>
<li><p>容器的列表初始化</p></li>
<li><p>容器的非成员函数 swap</p></li>
<li><p>容器 insert 成员的返回类型</p></li>
<li><p>容器的 emplace 成员</p></li>
<li><p>shrink_to_fit</p></li>
<li><p>string 的数值转换函数</p></li>
<li><p>lambda 表达式</p></li>
<li><p>lambda 表达式中的尾置返回类型</p></li>
<li><p>标准库 bind 函数</p></li>
<li><p>关联容器的列表初始化</p></li>
<li><p>列表初始化 pair 的返回类型</p></li>
<li><p>pair 的列表初始化</p></li>
<li><p>无序容器</p></li>
<li><p>智能指针</p></li>
<li><p>shared_ptr 类</p></li>
<li><p>动态分配对象的列表初始化</p></li>
<li><p>auto 和动态分配</p></li>
<li><p>unique_ptr 类</p></li>
<li><p>weak_ptr 类</p></li>
<li><p>范围 for 语句不能应用于动态分配数组</p></li>
<li><p>动态分配数组的列表初始化</p></li>
<li><p>auto 不能用于分配数组</p></li>
<li><p>allocator::construct 可使用任意构造函数</p></li>
<li><p>将=default 用于拷贝控制成员</p></li>
<li><p>使用=delete 阻止拷贝类对象</p></li>
<li><p>用移动类对象代替拷贝类对象</p></li>
<li><p>右值引用</p></li>
<li><p>标准库 move 函数</p></li>
<li><p>移动构造函数和移动赋值</p></li>
<li><p>移动构造函数通常应该是 noexcept</p></li>
<li><p>移动迭代器</p></li>
<li><p>引用限定成员函数</p></li>
<li><p>function 类模板</p></li>
<li><p>explicit 类型转换运算符</p></li>
<li><p>虚函数的 override 指示符</p></li>
<li><p>通过定义类为 final 来阻止继承</p></li>
<li><p>虚函数的 override 和 final 指示符</p></li>
<li><p>删除的拷贝控制和继承</p></li>
<li><p>继承的构造函数</p></li>
<li><p>声明模板类型形参为友元</p></li>
<li><p>模板类型别名</p></li>
<li><p>模板函数的默认模板参数</p></li>
<li><p>实例化的显示控制</p></li>
<li><p>模板函数与尾置返回类型</p></li>
<li><p>引用折叠规则</p></li>
<li><p>用 static_cast 将左值转换为右值</p></li>
<li><p>标准库 forward 函数</p></li>
<li><p>可变参数模板</p></li>
<li><p>sizeof…运算符</p></li>
<li><p>可变参数模板与转发</p></li>
<li><p>标准库 tuple 类模板</p></li>
<li><p>新的 bitset 运算</p></li>
<li><p>正则表达式库</p></li>
<li><p>随机数库</p></li>
<li><p>浮点数格式控制</p></li>
<li><p>noexcept 异常指示符</p></li>
<li><p>noexcept 运算符</p></li>
<li><p>内联命名空间</p></li>
<li><p>继承的构造函数与多重继承</p></li>
<li><p>有作用域的 enum</p></li>
<li><p>说明类型用于保存 enum 对象</p></li>
<li><p>enum 的前置声明</p></li>
<li><p>标准库 eme_fn 类模板</p></li>
<li><p>类类型的 union 成员</p></li>
</ul>
</div>
<div class="section" id="i-c">
<h3>第Ⅰ部分 C++基础<a class="headerlink" href="#i-c" title="永久链接至标题">¶</a></h3>
<div class="section" id="id64">
<h4>第2章 变量和基本类型<a class="headerlink" href="#id64" title="永久链接至标题">¶</a></h4>
<div class="section" id="id65">
<h5>2.1 基本内置类型<a class="headerlink" href="#id65" title="永久链接至标题">¶</a></h5>
<p>C++ 定义了一套包括 <strong>算术类型</strong> 和 <strong>空类型（void）</strong> 在内的基本数据类型。其中，
算术类型包含了布尔值（布尔类型）、整型数（整型）、字符（整型）和浮点数（浮点型）。
空类型不对应具体的值，仅用于一些特殊的场合，例如最常见的是，当函数不返回任何值时
使用空类型作为返回类型。</p>
<div class="section" id="id66">
<h6>2.1.1 算术类型<a class="headerlink" href="#id66" title="永久链接至标题">¶</a></h6>
<p>算术类型分为两类： <strong>整型</strong> 和 <strong>浮点型</strong>。</p>
<p>算术类型的尺寸（也就是该类型数据所占的比特数）在不同机器上有所差别。下表列出了
C++ 标准规定的尺寸的最小值，同时允许编译器赋予这些类型更大的尺寸。</p>
<div class="figure align-center" id="id263">
<div class="graphviz"><object data="../_images/graphviz-d85466df14ec32ec1a1a2495e1dd54fc388e35f9.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    abc [shape = none, margin = 0, label = &lt;
        &lt;TABLE BORDER = '1' CELLBORDER = '0' CELLSPACING = '0' CELLPADDING = '8'&gt;
        &lt;TR&gt;&lt;TD BGCOLOR = 'lightgray'&gt;类型&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;含义&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;最小尺寸&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;bool&lt;/TD&gt;&lt;TD&gt;布尔类型 [整型]&lt;/TD&gt;&lt;TD&gt;未定义&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;char&lt;/TD&gt;&lt;TD&gt;字符 [整型] [有无符号的]&lt;/TD&gt;&lt;TD&gt;8 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;wchar_t&lt;/TD&gt;&lt;TD&gt;宽字符 [整型]&lt;/TD&gt;&lt;TD&gt;16 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;char16_t&lt;/TD&gt;&lt;TD&gt;Unicode 字符 [整型]&lt;/TD&gt;&lt;TD&gt;16 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;char32_t&lt;/TD&gt;&lt;TD&gt;Unicode 字符 [整型]&lt;/TD&gt;&lt;TD&gt;32 位&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;short&lt;/TD&gt;&lt;TD&gt;短整型 [整型] [有无符号的]&lt;/TD&gt;&lt;TD&gt;16 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;int&lt;/TD&gt;&lt;TD&gt;整型 [整型] [有无符号的]&lt;/TD&gt;&lt;TD&gt;16 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;long&lt;/TD&gt;&lt;TD&gt;长整型 [整型] [有无符号的]&lt;/TD&gt;&lt;TD&gt;32 位&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;long long&lt;/TD&gt;&lt;TD&gt;长整型 [整型] [有无符号的]（C++11）&lt;/TD&gt;&lt;TD&gt;64 位&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;float&lt;/TD&gt;&lt;TD&gt;单精度浮点数 [浮点型]&lt;/TD&gt;&lt;TD&gt;6 位有效数字&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;double&lt;/TD&gt;&lt;TD&gt;双精度浮点数 [浮点型]&lt;/TD&gt;&lt;TD&gt;10 位有效数字&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;long double&lt;/TD&gt;&lt;TD&gt;扩展精度浮点数 [浮点型]&lt;/TD&gt;&lt;TD&gt;10 位有效数字&lt;/TD&gt;&lt;/TR&gt;
        &lt;/TABLE&gt;&gt;];
}</p></object></div>
<p class="caption"><span class="caption-text">C++ 算术类型</span><a class="headerlink" href="#id263" title="永久链接至图片">¶</a></p>
</div>
<ul>
<li><p>布尔类型的取值是真（true）或者假（false）。</p></li>
<li><p>基本的字符类型 char ，一个 char 的空间应确保可以存放机器基本字符集中任意字符
对应的数字值。也就是说，一个 char 的大小和一个机器字节一样。</p></li>
<li><p>其他字符类型用于扩展字符集：</p>
<blockquote>
<div><ul class="simple">
<li><p>wchar_t：用于确保可以存放机器最大扩展字符集中的任意一个字符。</p></li>
<li><p>char16_t 和 char32_t：为 Unicode 字符集服务（ Unicode 是用于表示所有
自然语言中字符的标准）。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>除字符和布尔类型之外，其他整型用于表示（可能）不同尺寸的整数。C++ 语言规定一
个 int 至少和一个 short 一样大，一个 long 至少和一个 int 一样大，一个
long long 至少和一个 long 一样大（long long &gt;= long &gt;= int &gt;= int &gt;= short）。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>计算机以比特序列存储数据，大多数计算机以2的整数次幂个比特作为块来处理内存，可
寻址的最小内存块称为“字节（byte）”，存储的基本单元称为“字（word）”，它通常由
几个字节组成。</p>
<p>大多数机器的字节由8比特构成，字则由32或64比特构成，也就是4或8字节。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>C++ 标准指定了一个浮点数有效位数的最小值，然而大多数编译器都实现了更高的精度。
通常，float 以 1 个字（32 比特）来表示，double 以 2 个字（64 比特）来表示，
long double 以 3 或 4 个字（96 或 128 比特）来表示。</p>
<p>一般来说，float 和 double 分别有 7 和 16 个有效位；类型 long double 的具体实
现不同，精度也各不相同。</p>
</div>
<div class="section" id="id67">
<h7>带符号类型和无符号类型<a class="headerlink" href="#id67" title="永久链接至标题">¶</a></h7>
<p>除去布尔类型和扩展的字符型之外，其他整型可以划分为 <strong>带符号的（signed）</strong> 和
<strong>无符号的（unsigned）</strong> 两种。带符号的类型可以表示正数、负数或 0，无符号类型则
仅能表示大于等于 0 的值。</p>
<p>类型 short、int、long 和 long long 都是带符号的，通过在这些类型名前添加 unsigned
就可以得到无符号的类型。类型 unsigned int 可以缩写为 unsigned 。</p>
<p>与其他整型不同，字符型被划分为了三种：char、signed char 和 unsigned char。尽管字
符型有三种，但是字符的表现形式却只有两种：带符号的和无符号的。类型 char 实际上会
表现为上述两种形式中的一种，具体是哪种由编译器决定。</p>
</div>
</div>
<div class="section" id="id68">
<h6>2.1.2 类型转换<a class="headerlink" href="#id68" title="永久链接至标题">¶</a></h6>
<p>对象的类型定义了对象能包含的数据和能参与的运算，其中一种运算被大多数类型支持，就
是将对象从一种给定的类型 <strong>转换（convert）</strong> 为另一种相关类型。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w">            </span><span class="c1">// b 为真</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">              </span><span class="c1">// i 的值为 1</span>
<span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14</span><span class="p">;</span><span class="w">               </span><span class="c1">// i 的值为 3</span>
<span class="kt">double</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">          </span><span class="c1">// pi 的值为 3.0</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">   </span><span class="c1">// 假设 c 占 8 比特，c 的值为 255 —— (-1) % 256 = 255</span>
<span class="kt">char</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w">          </span><span class="c1">// 假设 c 占 8 比特，c2 的值是未定义的 —— 赋给带符号</span>
<span class="w">                        </span><span class="c1">// 类型一个超出它表示范围的值时，结果是未定义的（undefined）。</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>赋给带符号类型一个超出它表示范围的值时，结果是 <strong>未定义的（undefined）</strong> 。</p>
</div>
<div class="section" id="id69">
<h7>含有无符号类型的表达式<a class="headerlink" href="#id69" title="永久链接至标题">¶</a></h7>
<p>当一个算术表达式中既有无符号数又有 int 时，那个 int 值就会转换成无符号数。把 int
转换成无符号数的过程和把 int 直接赋给无符号变量一样。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w">  </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-42</span><span class="p">;</span><span class="w"></span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">    </span><span class="c1">// 输出 -84</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">    </span><span class="c1">// 如果 int 占 32 位，输出 4294967264 —— (-32) % (2^32)</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="n">u2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// 正确，输出 32</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">u2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// 正确，不过结果是取模后的值 4294967264 —— (-32) % (2^32)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id70">
<h6>2.1.3 字面值常量<a class="headerlink" href="#id70" title="永久链接至标题">¶</a></h6>
<p>一个形如 42 的值被称作 <strong>字面值常量（literal）</strong> 。每个字面值常量都对应一种数据
类型，字面值常量的 <strong>形式</strong> 和 <strong>值</strong> 决定了它的 <strong>数据类型</strong> 。</p>
<div class="section" id="id71">
<h7>整型和浮点型字面值<a class="headerlink" href="#id71" title="永久链接至标题">¶</a></h7>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">        </span><span class="c1">// 使用十进制来表示十进制数 20</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">024</span><span class="p">;</span><span class="w">       </span><span class="c1">// 使用八进制（以 0 开头）来表示十进制数 20</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span><span class="w">      </span><span class="c1">// 使用十六进制（以 0x 或 0X 开头）来表示十进制数 20</span>
</pre></div>
</div>
<ul>
<li><p>整型字面值具体的数据类型由它的 <strong>值</strong> 和 <strong>符号</strong> 决定。</p>
<ul>
<li><p>默认情况下，十进制字面值是带符号数，八进制和十六进制字面值既可能是带符号的也
可能是无符号的。</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>十进制字面值的类型是 int 、 long 和 long long 中尺寸最小的那个，前提
是这种类型要能容纳下当前的值。</p></li>
<li><p>八进制和十六进制字面值的类型是能容纳其数值的 int 、 unsigned int 、
long 、 unsigned long 、 long long 和 unsigned long long 中尺寸最小者。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>如果一个字面值连与之关联的最大的数据类型都放不下，将产生错误。</p></li>
<li><p>类型 short 没有对应的字面值。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>尽管整型字面值可以存储在带符号数据类型中，但严格来说，十进制字面值不会是
负数。如果我们使用了一个形如 -42 的负十进制字面值，那个符号并不在字面值
之内，它的作用仅仅是对字面值取负而已。</p>
</div>
</li>
<li><p>浮点型字面值表现为一个小数或以科学计数法表示的指数，其中指数部分用 E 或 e 标识：</p>
<blockquote>
<div><ul class="simple">
<li><p>3.14159</p></li>
<li><p>3.14159E0</p></li>
<li><ol class="arabic simple" start="0">
<li></li>
</ol>
</li>
<li><p>0e0</p></li>
<li><p>.001</p></li>
</ul>
</div></blockquote>
<p>默认的，浮点型字面值是一个 double 数据类型。</p>
</li>
</ul>
</div>
<div class="section" id="id72">
<h7>字符和字符串字面值<a class="headerlink" href="#id72" title="永久链接至标题">¶</a></h7>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="sc">&#39;a&#39;</span><span class="w">             </span><span class="c1">// 字符字面值</span>
<span class="s">&quot;Hello World!&quot;</span><span class="w">  </span><span class="c1">// 字符串字面值</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>字符串此面值的类型实际上是由常量字符构成的数组（array）。编译器在每个字符串
的结尾处添加一个 <strong>空字符（’\0’）</strong> ，因此，字符串字面值的实际长度要比它的内
容多 1 。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果两个字符串字面值位置紧邻且仅由空格、缩进和换行符分隔，则它们实际上是一个
整体。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 分多行书写的字符串字面值</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;a really, really long string literal &quot;</span><span class="w"></span>
<span class="w">             </span><span class="s">&quot;that spans two lines&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id73">
<h7>转义序列<a class="headerlink" href="#id73" title="永久链接至标题">¶</a></h7>
<p>有两类字符程序员不能直接使用：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><strong>不可打印（nonprintable）</strong> 的字符，如退格或其他控制字符。</p></li>
<li><p>在 C++ 语言中有特殊含义的字符（单引号、双引号、问号、反斜线）。</p></li>
</ol>
</div></blockquote>
<p>在这些情况下需要用到  <strong>转义序列（escape sequence）</strong> ，转义序列均以反斜线作为开
始，C++ 语言规定的转义序列包括：</p>
<blockquote>
<div><ul class="simple">
<li><p>换行符 <code class="docutils literal notranslate"><span class="pre">\n</span></code></p></li>
<li><p>横向制表符 <code class="docutils literal notranslate"><span class="pre">\t</span></code></p></li>
<li><p>报警（响铃）符 <code class="docutils literal notranslate"><span class="pre">\a</span></code></p></li>
<li><p>纵向制表符 <code class="docutils literal notranslate"><span class="pre">\v</span></code></p></li>
<li><p>退格符 <code class="docutils literal notranslate"><span class="pre">\b</span></code></p></li>
<li><p>双引号 <code class="docutils literal notranslate"><span class="pre">\&quot;</span></code></p></li>
<li><p>反斜线 <code class="docutils literal notranslate"><span class="pre">\\</span></code></p></li>
<li><p>问号 <code class="docutils literal notranslate"><span class="pre">\?</span></code></p></li>
<li><p>单引号 <code class="docutils literal notranslate"><span class="pre">\'</span></code></p></li>
<li><p>回车符 <code class="docutils literal notranslate"><span class="pre">\r</span></code></p></li>
<li><p>进纸符 <code class="docutils literal notranslate"><span class="pre">\f</span></code></p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在程序中，上述转义序列被当作一个字符使用。</p>
</div>
<p>我们也可以使用 <strong>泛化的转义序列</strong> ，其形式是 <code class="docutils literal notranslate"><span class="pre">\x</span></code> 后紧跟 1 个或多个十六进制数
字，或者 <code class="docutils literal notranslate"><span class="pre">\</span></code> 后紧跟 1 个、2 个或 3 个八进制数字， <em>其中数字部分表示的是字符对应
的数值。</em></p>
<p>假设使用的是 Latin-1 字符集，以下是一些示例：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\7</span></code> （响铃）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\12</span></code> （换行符）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\40</span></code> （空格）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\0</span></code> （空字符）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\115</span></code> （字符 M）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\x4d</span></code> （字符 M）</p></li>
</ul>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果反斜线 <code class="docutils literal notranslate"><span class="pre">\</span></code> 后面跟着的八进制数字超过 3 个，只有前 3 个数字与 <code class="docutils literal notranslate"><span class="pre">\</span></code> 构成
转义序列。</p>
<p>相反， <code class="docutils literal notranslate"><span class="pre">\x</span></code> 要用到后面跟着的所有数字。例如， <code class="docutils literal notranslate"><span class="pre">\xx1234</span></code> 表示一个 16 位的
字符，该字符由这 4 个十六进制数所对应的比特唯一确定。因为大多数机器的 char
型数据占 8 位，所以上面这个例子可能会报错。一般来说，超过 8 位的十六进制字符
都与某个扩展字符集一起使用的。</p>
</div>
</div>
<div class="section" id="id74">
<h7>指定字面值的类型<a class="headerlink" href="#id74" title="永久链接至标题">¶</a></h7>
<div class="figure align-center" id="id264">
<div class="graphviz"><object data="../_images/graphviz-6eaa1058fcb356385838a8d178de6819f5df27f7.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    abc [shape = none, margin = 0, label = &lt;
        &lt;TABLE BORDER = '1' CELLBORDER = '0' CELLSPACING = '0' CELLPADDING = '8'&gt;
        &lt;TR&gt;&lt;TD BGCOLOR = 'lightgray'&gt;前缀&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;含义&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;类型&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;u&lt;/TD&gt;&lt;TD&gt;Unicode 16 字符&lt;/TD&gt;&lt;TD&gt;char_16&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;U&lt;/TD&gt;&lt;TD&gt;Unicode 32 字符&lt;/TD&gt;&lt;TD&gt;char_32&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;L&lt;/TD&gt;&lt;TD&gt;宽字符&lt;/TD&gt;&lt;TD&gt;wchar_16&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;u8&lt;/TD&gt;&lt;TD&gt;UTF-8（仅用于字符串字面常量）&lt;/TD&gt;&lt;TD&gt;char&lt;/TD&gt;&lt;/TR&gt;
        &lt;/TABLE&gt;&gt;];
}</p></object></div>
<p class="caption"><span class="caption-text">指定字面值的类型 - 字符和字符串字面值</span><a class="headerlink" href="#id264" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id265">
<div class="graphviz"><object data="../_images/graphviz-bcd33bc2d098952303604fce317a2041f0ea876f.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    abc [shape = none, margin = 0, label = &lt;
        &lt;TABLE BORDER = '1' CELLBORDER = '0' CELLSPACING = '0' CELLPADDING = '8'&gt;
        &lt;TR&gt;&lt;TD BGCOLOR = 'lightgray'&gt;后缀&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;最小匹配类型&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;u or U&lt;/TD&gt;&lt;TD&gt;unsigned&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;l or L&lt;/TD&gt;&lt;TD&gt;long&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;ll or LL&lt;/TD&gt;&lt;TD&gt;long long&lt;/TD&gt;&lt;/TR&gt;
        &lt;/TABLE&gt;&gt;];
}</p></object></div>
<p class="caption"><span class="caption-text">指定字面值的类型 - 整型字面值</span><a class="headerlink" href="#id265" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id266">
<div class="graphviz"><object data="../_images/graphviz-236e13ac299c95d5b5be66b3955ba273d049a3cf.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    abc [shape = none, margin = 0, label = &lt;
        &lt;TABLE BORDER = '1' CELLBORDER = '0' CELLSPACING = '0' CELLPADDING = '8'&gt;
        &lt;TR&gt;&lt;TD BGCOLOR = 'lightgray'&gt;后缀&lt;/TD&gt;&lt;TD BGCOLOR = 'lightgray'&gt;类型&lt;/TD&gt;&lt;/TR&gt;

        &lt;TR&gt;&lt;TD&gt;f or F&lt;/TD&gt;&lt;TD&gt;float&lt;/TD&gt;&lt;/TR&gt;
        &lt;TR&gt;&lt;TD&gt;l or L&lt;/TD&gt;&lt;TD&gt;long double&lt;/TD&gt;&lt;/TR&gt;
        &lt;/TABLE&gt;&gt;];
}</p></object></div>
<p class="caption"><span class="caption-text">指定字面值的类型 - 浮点型字面值</span><a class="headerlink" href="#id266" title="永久链接至图片">¶</a></p>
</div>
<p>通过上面表中所列的前缀和后缀，可以改变整型、浮点型和字符型字面值的默认类型。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="sa">L</span><span class="sc">&#39;a&#39;</span><span class="w">        </span><span class="c1">// 宽字符型字面值，类型是 wchar_t</span>
<span class="sa">u8</span><span class="s">&quot;hi&quot;</span><span class="w">      </span><span class="c1">// utf-8 字符串字面值（utf-8 用 8 位编码一个 unicode 字符）</span>
<span class="mi">42ULL</span><span class="w">       </span><span class="c1">// 无符号整型字面值，类型是 unsigned long long</span>
<span class="mf">1E-3F</span><span class="w">       </span><span class="c1">// 单精度浮点型字面值，类型是 float</span>
<span class="mf">3.14159L</span><span class="w">    </span><span class="c1">// 扩展精度浮点型字面值，类型是 long double</span>
</pre></div>
</div>
</div>
<div class="section" id="id75">
<h7>布尔字面值和指针字面值<a class="headerlink" href="#id75" title="永久链接至标题">¶</a></h7>
<p>true 和 false 是布尔类型字面值，nullptr 是指针字面值。</p>
</div>
</div>
</div>
<div class="section" id="id76">
<h5>2.2 变量<a class="headerlink" href="#id76" title="永久链接至标题">¶</a></h5>
<div class="section" id="id77">
<h6>2.2.1 变量定义<a class="headerlink" href="#id77" title="永久链接至标题">¶</a></h6>
<p>变量定义的基本形式是：首先是 <strong>类型说明符（type specifier）</strong>，随后紧跟一个或多
个变量名组成的列表，其中变量名以逗号分隔，最后以分号结束。</p>
<p>当对象在创建时获得了一个特定的值，我们说这个对象被 <strong>初始化（initialized）</strong> 了。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>初始化不是赋值，初始化的含义是创建变量时赋予其一个初始值，而赋值的含义是把对
象的当前值擦除，而以一个新值来替代。</p>
</div>
<p>用花括号来初始化变量的形式称为 <strong>列表初始化（list initialization）</strong> 。</p>
<p>如果定义变量时没有指定初始值，则变量被 <strong>默认初始化（default initialized）</strong> ，
此时变量被赋予了 “默认值”。默认值到底是什么由变量类型决定，同时定义变量的位置对
此也会由影响。</p>
<blockquote>
<div><ul class="simple">
<li><p>定义在函数体之外的未被显示初始化的内置类型变量，被初始化为 0 。</p></li>
<li><p>定义在函数体之内的未被显示初始化的内置类型变量，将不被初始化（uninitialized） 。
一个未被初始化的内置类型变量的值是未定义的，如果试图拷贝或以其他形式访问
此类值将引发错误。</p></li>
<li><p>每个类各自决定其初始化对象的方式。而且，是否允许不经初始化就定义对象也由
类自己决定。</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>定义于函数体内的内置类型的对象如果没有初始化，则其值未定义。类的对象如果没有
被显示的初始化，则其值由类确定。</p>
</div>
</div>
<div class="section" id="id78">
<h6>2.2.2 变量声明和定义的关系<a class="headerlink" href="#id78" title="永久链接至标题">¶</a></h6>
<p><strong>声明（declaration）</strong> 使得名字为程序所知，一个文件如果想使用别处定义的名字则必
须包含对那个名字的声明。</p>
<p><strong>定义（definition）</strong> 负责创建与名字关联的试体。</p>
<p>变量声明规定了变量的类型和名字，定义在此之外还申请存储空间，也可能为变量赋一个初
始值。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">   </span><span class="c1">// 声明 i 而非定义 i</span>
<span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">          </span><span class="c1">// 声明并定义 j</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.1416</span><span class="p">;</span><span class="w">          </span><span class="c1">// 定义，抵消了 extern 的作用</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>在函数体内部，如果试图初始化一个由 extern 关键字标记的变量，将引发错误。</p>
<p>变量能且只能被定义一次，但是可以被多次声明。</p>
</div>
</div>
<div class="section" id="id79">
<h6>2.2.3 标识符<a class="headerlink" href="#id79" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id80">
<h6>2.2.4 名字的作用域<a class="headerlink" href="#id80" title="永久链接至标题">¶</a></h6>
<p><strong>作用域（scope）</strong> 是程序的一部分，在其中名字有其特定的含义。C++ 语言中大多数作
用域都已花括号分隔。</p>
<p>名字的有效区域始于名字的声明语句，以声明语句所在的作用域末端为结束。</p>
<p>函数 main 和其它大多数定义在函数体之外的名字一样拥有 <strong>全局作用域（global scope）</strong>.</p>
<p>函数体之内定义的变量拥有 <strong>块作用域（block scope）</strong> 。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">::variableName</span></code> 访问全局作用域的变量。</p>
</div>
</div>
<div class="section" id="id81">
<h5>2.3 复合类型<a class="headerlink" href="#id81" title="永久链接至标题">¶</a></h5>
<p><strong>复合类型（compound type）</strong> 是指基于其他类型定义的类型。C++ 语言有几种复合类型，
本章将介绍其中的两种：引用和指针。</p>
<p>关于变量声明更通用的描述应该是：一条声明语句由一个 <strong>基本数据类型（base type）</strong>
和紧随其后的一个 <strong>声明符（declarator）</strong> 列表组成。每个声明符命名了一个变量并指
定该变量为与基本数据类型有关的某种类型。</p>
<div class="section" id="id82">
<h6>2.3.1 引用<a class="headerlink" href="#id82" title="永久链接至标题">¶</a></h6>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>C++ 11 中新增了一种引用——右值引用（rvalue reference），严格来说，当我们使用
术语“引用（reference）”时，指的其实是“左值引用（lvalue reference）”。</p>
</div>
<p><strong>引用（reference）</strong> 给对象起了另外一个名字，引用类型引用（refers to）另外一种
类型。通过将 <strong>声明符</strong> 写成 &amp;d 的形式来定义引用类型，其中 d 是声明的变量名。</p>
<p>一般在初始化变量时，初始值会被拷贝到新建的对象中。然而定义引用时，程序把引用和它
的初始值 <strong>绑定（bind）</strong> 在一起，而不是将初始值拷贝给引用。一旦初始化完成，引用
将和它的初始值对象一直绑定在一起。因为无法令引用重新绑定到另外一个对象，因此引用
必须初始化。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>引用并非对象，相反，它只是为一个已存在的对象所起的另外一个名字。</p>
<p>因为引用本身不是一个对象，所以不能定义引用的引用。</p>
</div>
<p>除以下 <strong>两种</strong> 情况外，其他所有引用的类型都要和与之绑定的对象严格匹配。而且，引
用只能绑定到 <strong>对象</strong> 上，而不能与 <strong>字面值</strong> 或某个 <strong>表达式的计算结果</strong> 绑定在
一起：</p>
<blockquote>
<div><ol class="arabic">
<li><p>在初始化 <strong>常量引用</strong> 时允许用 <strong>任意表达式</strong> 作为初始值，只要该表达式的
结果能转换成引用的类型即可。尤其，允许为一个常量引用绑定 <strong>非常量的对象</strong> 、
<strong>字面值</strong> ，甚至是个 <strong>一般表达式</strong> ：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">i</span><span class="p">;</span><span class="w">         </span><span class="c1">//  允许将 const int&amp; 绑定到一个普通 int 对象上</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">42</span><span class="p">;</span><span class="w">        </span><span class="c1">//  正确：r2 是一个常量引用</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">r1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">    </span><span class="c1">//  正确：r3 是一个常量引用</span>
<span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">r1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">          </span><span class="c1">//  错误：r4 是一个普通的非常量引用</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>待阅读</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id83">
<h6>2.3.2 指针<a class="headerlink" href="#id83" title="永久链接至标题">¶</a></h6>
<p><strong>指针（pointer）</strong> 是“指向（point to）”另外一种类型的复合类型。与引用类似，指针
也实现了对其他对象的间接访问。然而指针与引用相比又有很多不同点。</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>指针本身就是一个对象，允许对指针赋值和拷贝，而且在指针的生命周期内它可以
先后指向几个不同的对象。</p></li>
<li><p>指针无须在定义时赋值。和其他内置类型一样，在块作用域内定义的指针如果没有
被初始化，也将拥有一个不确定的值。</p></li>
</ol>
</div></blockquote>
<p>定义指针类型的方法是将声明符写成 <a href="#id84"><span class="problematic" id="id85">*</span></a>d 的形式，其中 d 是变量名。</p>
<p>指针存放某个对象的地址，使用 <strong>取地址符（操作符 &amp;）</strong> 获取该地址。</p>
<p>引用不是对象，没有实际地址，所以不能定义指向引用的指针。</p>
<p>除以下了 <strong>两种</strong> 情况外，其他所有指针的类型都要和它所指向的对象严格匹配：</p>
<blockquote>
<div><ol class="arabic">
<li><p>允许一个指向常量的指针指向非常量：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">dval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">cptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dval</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>待阅读</p></li>
</ol>
</div></blockquote>
<p>如果指针指向了一个对象，则允许使用 <strong>解引用符（操作符 *）</strong> 来访问该对象。</p>
<p><strong>空指针（null pointer）</strong> 不指向任何对象，在试图使用一个指针之前代码可以首先检
查它是否为空。以下为生成空指针的方法：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w">          </span><span class="c1">// 等价于 int *p1 = 0;</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                </span><span class="c1">// 直接将 p2 初始化为字面常量 0</span>
<span class="c1">// 需要 #include&lt;cstdlib&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">             </span><span class="c1">// 等价于 int *p3 = 0;</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>把 int 变量直接赋给指针是错误的操作，即使 int 变量的值恰好等于 0 也不行：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span><span class="p">;</span><span class="w">              </span><span class="c1">// 错误：不能把 int 变量直接赋给指针</span>
</pre></div>
</div>
</div>
<p>任何非 0 指针对应的条件值都是 true 。</p>
<p><strong>void*</strong> 是一种特殊的指针类型，可用于存放任意对象的地址。</p>
</div>
<div class="section" id="id86">
<h6>2.3.3 理解符合类型的声明<a class="headerlink" href="#id86" title="永久链接至标题">¶</a></h6>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// i 是一个 int 型的数，p 是一个 int 型指针，r 是一个 int 型引用</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><a href="#id87"><span class="problematic" id="id88">**</span></a>表示指向指针的指针，<a href="#id89"><span class="problematic" id="id90">**</span></a><a href="#id91"><span class="problematic" id="id92">*</span></a>表示指向指针的指针的指针。</p>
<p>引用本身不是对象，因此不存在指向引用的指针。但是指针是对象，所以存在指向指针的引
用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w">         </span><span class="c1">// p 是一个指向 int 的指针</span>
<span class="kt">int</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w">    </span><span class="c1">// r 是一个对指针 p 的引用</span>

<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">;</span><span class="w">         </span><span class="c1">// r 引用了一个指针，因此给 r 赋值 &amp;i 就是令 p 指向 i</span>
<span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">         </span><span class="c1">// 解引用 r 得到 i，也就是 p 指向的对象，将 i 的值改为 0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="const">
<h5>2.4 const 限定符<a class="headerlink" href="#const" title="永久链接至标题">¶</a></h5>
<p>因为 const 对象一旦创建后其值就不能在改变，所以 const 对象必须初始化：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_size</span><span class="p">();</span><span class="w">       </span><span class="c1">// 正确：运行时初始化</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w">               </span><span class="c1">// 正确：编译时初始化</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w">                    </span><span class="c1">// 错误：k 是一个为经初始化的常量</span>
</pre></div>
</div>
</div></blockquote>
<p>对象的类型决定了其上的操作，与非 const 类型所能参与的操作相比，const 类型的对象
能完成其中大部分，但也不是所有的操作都合适。主要的限制就是只能在 const 类型的对
象上执行 <strong>不改变其内容</strong> 的操作。</p>
<p>在不改变 const 对象的操作中还有一种是初始化，如果利用一个对象去初始化另外一个对
象，则它们是不是 const 都无关紧要：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">       </span><span class="c1">// 正确：i 的值被拷贝给了 ci</span>
<span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">;</span><span class="w">             </span><span class="c1">// 正确：ci 的值被拷贝给了 j</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>默认状态下，const 对象仅在文件内有效。</strong></p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果想在多个文件之间共享 cosnt 对象，必须在变量的定义之前添加 extern 关键字。</p>
</div>
<div class="section" id="id93">
<h6>2.4.1 const 的引用<a class="headerlink" href="#id93" title="永久链接至标题">¶</a></h6>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">dval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dval</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>为了让 ri 绑定到一个整数，编译器把上述代码变成了如下形式：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">dval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dval</span><span class="p">;</span><span class="w">  </span><span class="c1">// 由双精度浮点数生成一个临时的整型常量</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w">   </span><span class="c1">// 让 ri 绑定到这个临时量</span>
</pre></div>
</div>
<p>在这种情况下，ri 绑定了一个 <strong>临时量（tempory）</strong> 对象。所谓临时量对象，就是当编
译器需要一个空间来暂存表达式的求值结果时临时创建的一个未命名的对象。</p>
<p>常量引用仅对引用 <strong>可参与的操作</strong> 做出了限定，对于引用的对象本身是不是一个常量未
作限定。</p>
</div>
<div class="section" id="id94">
<h6>2.4.2 指针和 const<a class="headerlink" href="#id94" title="永久链接至标题">¶</a></h6>
<p><strong>指向常量的指针（pointer to const）</strong> 不能用于改变其所指对象的值。</p>
<p>允许令一个指向常量的指针指向一个非常量对象。</p>
<div class="section" id="id95">
<h7>const 指针<a class="headerlink" href="#id95" title="永久链接至标题">¶</a></h7>
<p>指针是对象而引用不是，因此就像其他对象类型一样，允许把指针本身定为常量。 <strong>常量
指针（const pointer）</strong> 必须初始化，而且一旦初始化，则它的值（也就是存放在指针中
那个地址）就不能再改变了。</p>
<p>把 <strong>*</strong> 放在 const 关键字之前用以说明指针是一个常量。</p>
</div>
</div>
<div class="section" id="id96">
<h6>2.4.3 顶层 const<a class="headerlink" href="#id96" title="永久链接至标题">¶</a></h6>
<p>顶层 const 可以表示任意的对象是常量，这一点对任何数据类型都适用，如算术类型、类、
指针等。</p>
<p>底层 const 则与指针和引用等复合类型的基本类型部分有关。</p>
</div>
<div class="section" id="constexpr">
<h6>2.4.4 constexpr 和常量表达式<a class="headerlink" href="#constexpr" title="永久链接至标题">¶</a></h6>
<p><strong>常量表达式</strong> 是指 <strong>值不会改变</strong> 并且 <strong>在编译过程</strong> 就能得到计算结果的表达式。</p>
<ul class="simple">
<li><p>字面值属于常量表达式。</p></li>
<li><p>用常量表达式初始化的 const 对象也是常量表达式。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>一个对象（或表达式）是不是常量表达式由它的 <strong>数据类型</strong> 和 <strong>初始值</strong> 共同决
定。</p>
</div>
<div class="section" id="id97">
<h7>constexpr 变量<a class="headerlink" href="#id97" title="永久链接至标题">¶</a></h7>
<p>由于在一个复杂的系统中，很难（几乎肯定不能）分辨一个初始值是不是常量表达式。尽管
可以定义一个 const 变量并把它的初始值设为 <strong>我们认为的某个常量表达式</strong> ，但在实
际使用时，尽管要求如此却常常发现初始值并非常量表达式的情况。</p>
<p>C++ 11 新标准规定，允许将变量声明为 <strong>constexpr</strong> 类型以便由编译器来验证变量的值
是否是一个常量表达式。声明为 constexpr 的变量一定是一个常量，而且必须用常量表达
式初始化。</p>
<p>尽管不能使用普通函数作为 constexpr 变量的初始值，但是新标准允许定义一种特殊的
<strong>constexpr 函数</strong> 。这种函数应该足够简单以使得编译时就可以计算其结果，这样就能
使用 constexpr 函数去初始化 constexpr 变量了。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>一般来说，如果你认定变量是一个常量表达式，那就把它声明成 constexpr 类型。</p>
</div>
</div>
</div>
</div>
<div class="section" id="id98">
<h5>2.5 处理类型<a class="headerlink" href="#id98" title="永久链接至标题">¶</a></h5>
<div class="section" id="id99">
<h6>2.5.1 类型别名<a class="headerlink" href="#id99" title="永久链接至标题">¶</a></h6>
<p><strong>类型别名（type alias）</strong> 是一个名字，它是某种类型的同义词。</p>
<p>定义类型别名的两种方式：</p>
<blockquote>
<div><ul>
<li><p>使用关键字 <strong>typedef</strong>：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">wages</span><span class="p">;</span><span class="w">       </span><span class="c1">// wages 是 double 的同义词</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">wages</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w">     </span><span class="c1">// base 是 double 的同义词，p 是 double* 的同义词</span>
</pre></div>
</div>
<p>其中，关键字 typedef 作为声明语句中的基本数据类型的一部分出现。</p>
<p>含有 typedef 的声明语句定义的不再是变量而是类型别名。</p>
<p>这里的声明符也可以包含类型修饰，从而也能由基本数据类型构造出复合类型来。</p>
</li>
<li><p>使用 <strong>别名声明（alias declaration）</strong></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sales_item</span><span class="p">;</span><span class="w">      </span><span class="c1">// SI 是 Sales_item 的同义词</span>
</pre></div>
</div>
<p>使用关键字 using 作为声明的开始，其作用是把等号左侧的名字规定成等号右侧
的类型的别名。</p>
<p>类型别名和类型的名字等价，只要是类型的名字能出现的地方，就能使用类型别名。</p>
</li>
</ul>
</div></blockquote>
<div class="section" id="id100">
<h7>指针、常量和类型别名<a class="headerlink" href="#id100" title="永久链接至标题">¶</a></h7>
<p>如果某个类型别名指代的是 <strong>复合类型</strong> 或 <strong>常量</strong> ，那么把它们用到声明语句里就会
产生意想不到的后果。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pstring</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">pstring</span><span class="w"> </span><span class="n">cstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">     </span><span class="c1">// cstr 是指向 char 的常量指针</span>
<span class="k">const</span><span class="w"> </span><span class="n">pstring</span><span class="w"> </span><span class="o">*</span><span class="n">ps</span><span class="p">;</span><span class="w">          </span><span class="c1">//  ps 是一个指针，它的对象是指向 char 的常量指针</span>
</pre></div>
</div>
</div></blockquote>
<p>上述两条声明语句的基本数据类型都是 const pstring ， 和过去一样， <strong>const 是对给
定类型的修饰</strong> 。pstring 实际上是指向 char 的指针，因此，const pstring 就是指向
char 的常量指针，而非指向常量字符的指针。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// 是对 const pstring cstr 的错误理解</span>
</pre></div>
</div>
</div></blockquote>
<p>声明语句中用到 pstring 时，其基本数据类型是指针。可是用 char * 重写了声明语句后，
数据类型就变成了 char ，* 成了声明符的一部分。这样改写的结果是，const char 成了
基本数据类型。前后两种声明含义截然不同，前者声明了一个指向 char 的常量指针，改写
后的形式则声明了一个指向 const char 的指针。</p>
</div>
</div>
<div class="section" id="auto">
<h6>2.5.2 auto 类型说明符<a class="headerlink" href="#auto" title="永久链接至标题">¶</a></h6>
<p>C++ 11 新标准引入了 <strong>auto</strong> 类型说明符，auto 让编译器通过初始值来推算变量的类型。
显然， auto 定义的变量必须有初始值。</p>
<p>使用 auto 也能在一条语句中声明多个变量。因为一条声明语句只能有一个基本数据类型，
所以该语句中的所有变量的初始基本数据类型都必须一样。</p>
<div class="section" id="id101">
<h7>复合类型、常量和 auto<a class="headerlink" href="#id101" title="永久链接至标题">¶</a></h7>
<p>编译器推断出来的 auto 类型有时候和初始值的类型并不完全一样，编译器会适当地改变结
果类型使其更符合初始化规则。</p>
</div>
</div>
<div class="section" id="decltype">
<h6>2.5.3 decltype 类型指示符<a class="headerlink" href="#decltype" title="永久链接至标题">¶</a></h6>
</div>
</div>
<div class="section" id="id102">
<h5>2.6 自定义数据结构<a class="headerlink" href="#id102" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id103">
<h4>第3章 字符串、向量和数组<a class="headerlink" href="#id103" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id104">
<h4>第4章 表达式<a class="headerlink" href="#id104" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id105">
<h4>第5章 语句<a class="headerlink" href="#id105" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id106">
<h4>第6章 函数<a class="headerlink" href="#id106" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id107">
<h4>第7章 类<a class="headerlink" href="#id107" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="ii-c">
<h3>第Ⅱ部分 C++标准库<a class="headerlink" href="#ii-c" title="永久链接至标题">¶</a></h3>
<div class="section" id="io">
<h4>第8章 IO库<a class="headerlink" href="#io" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id108">
<h4>第9章 顺序容器<a class="headerlink" href="#id108" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id109">
<h4>第10章 泛型算法<a class="headerlink" href="#id109" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id110">
<h4>第11章 关联容器<a class="headerlink" href="#id110" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id111">
<h4>第12章 动态内存<a class="headerlink" href="#id111" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="iii">
<h3>第Ⅲ部分 类设计者的工具<a class="headerlink" href="#iii" title="永久链接至标题">¶</a></h3>
<div class="section" id="id112">
<h4>第13章 拷贝控制<a class="headerlink" href="#id112" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id113">
<h4>第14章 重载运算与类型转换<a class="headerlink" href="#id113" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id114">
<h4>第15章 面向对象程序设计<a class="headerlink" href="#id114" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id115">
<h4>第16章 模板与泛型编程<a class="headerlink" href="#id115" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="iv">
<h3>第Ⅳ部分 高级主题<a class="headerlink" href="#iv" title="永久链接至标题">¶</a></h3>
<div class="section" id="id116">
<h4>第17章 标准库特殊设施<a class="headerlink" href="#id116" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id117">
<h4>第18章 用于大型程序的工具<a class="headerlink" href="#id117" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id118">
<h4>第19章 特殊工具与技术<a class="headerlink" href="#id118" title="永久链接至标题">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="id119">
<h2><a class="reference external" href="http://www.cplusplus.com/doc/tutorial/">C++ Tutorial</a><a class="headerlink" href="#id119" title="永久链接至标题">¶</a></h2>
</div>
<div class="section" id="id120">
<h2>个人总结<a class="headerlink" href="#id120" title="永久链接至标题">¶</a></h2>
<div class="section" id="preprocessor">
<h3>预处理器（preprocessor）<a class="headerlink" href="#preprocessor" title="永久链接至标题">¶</a></h3>
<div class="section" id="id121">
<h4>1. 预处理器指令（ <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/preprocessor-directives?view=msvc-160">Preprocessor directives</a> ）<a class="headerlink" href="#id121" title="永久链接至标题">¶</a></h4>
<p>预处理器指令，如 <code class="docutils literal notranslate"><span class="pre">#define</span></code> 和 <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> ，通常用于使源程序易于更改和易于在不同的执
行环境中编译。源文件中的指令告诉预处理器采取特定的操作。例如，预处理器可以替换文本中的标
记，将其他文件的内容插入到源文件中，或者通过删除部分文本来跳过该部分文件的编译。识别并执
行预处理器行发生在宏展开之前。因此，如果一个宏展开成类似预处理器命令的东西，预处理器将不
会识别它。</p>
<p>预处理语句使用与源文件语句相同的字符集，但不支持转义序列。预处理语句中使用的字符集与执行
字符集相同。预处理程序还能识别负的字符值。</p>
<p>预处理器识别以下指令:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><a class="reference internal" href="#define"><span class="std std-ref">#define</span></a></p></li>
<li><p><a class="reference internal" href="#error"><span class="std std-ref">#error</span></a></p></li>
<li><p><a class="reference internal" href="#import"><span class="std std-ref">#import</span></a></p></li>
<li><p><a class="reference internal" href="#pragma"><span class="std std-ref">#pragma</span></a></p></li>
<li><p><a class="reference internal" href="#elif"><span class="std std-ref">#elif</span></a></p></li>
<li><p><a class="reference internal" href="#if"><span class="std std-ref">#if</span></a></p></li>
<li><p><a class="reference internal" href="#include"><span class="std std-ref">#include</span></a></p></li>
<li><p><a class="reference internal" href="#undef"><span class="std std-ref">#undef</span></a></p></li>
<li><p><a class="reference internal" href="#else"><span class="std std-ref">#else</span></a></p></li>
<li><p><a class="reference internal" href="#ifdef"><span class="std std-ref">#ifdef</span></a></p></li>
<li><p><a class="reference internal" href="#line"><span class="std std-ref">#line</span></a></p></li>
<li><p><a class="reference internal" href="#using"><span class="std std-ref">#using</span></a></p></li>
<li><p><a class="reference internal" href="#endif"><span class="std std-ref">#endif</span></a></p></li>
<li><p><a class="reference internal" href="#ifndef"><span class="std std-ref">#ifndef</span></a></p></li>
</ol>
</div></blockquote>
<p>数字符号（ <code class="docutils literal notranslate"><span class="pre">#</span></code> ）必须是包含指令的行上的第一个非空格字符。空格字符可以出现在指令的数字
符号和第一个字母之间。某些指令包含参数或值。指令后面的任何文本（作为指令一部分的参数或值
除外）必须被注释起来（以单行注释分隔符 <code class="docutils literal notranslate"><span class="pre">//</span></code> 开头，或用注释分隔符 <code class="docutils literal notranslate"><span class="pre">/**/</span></code> 括起来）。
包含预处理器指令的行可以通过在行尾标记前面加反斜杠（ <code class="docutils literal notranslate"><span class="pre">\</span></code> ）来继续。</p>
<p><em>预处理器指令可以出现在源文件的任何地方，但它们只在源文件中其出现以后的代码中生效。</em></p>
<div class="section" id="define">
<h5>1.1 #define<a class="headerlink" href="#define" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">#define</span></code> 创建宏，宏是 <strong>标识符</strong> (或参数化标识符)与 <strong>标记字符串</strong> （token string）
的关联。定义宏后，编译器可以用 <strong>标记字符串</strong> 替换源文件中 <strong>标识符</strong> 的每次出现。</p>
<p>语法：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define identifier token-string_opt</span>
<span class="cp">#define identifier ( identifier_opt, ... , identifier_opt ) token-string_opt</span>
</pre></div>
</div>
<p>没有标记字符串的 <code class="docutils literal notranslate"><span class="pre">#define</span></code> 将从源文件中删除出现的标识符。该标识符仍然是已定义的，可以
使用 <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined</span></code> 和 <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> 指令进行测试。</p>
</div>
<div class="section" id="error">
<h5>1.2 #error<a class="headerlink" href="#error" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">#error</span></code> 指令在编译时发出用户指定的错误消息，然后终止编译。</p>
<p>此指令发出的错误消息包含标记字符串参数。标记字符串参数 <em>不会进行宏展开</em> 。此指令在预处
理期间最有用，用于通知开发人员程序不一致或违反约束。以下示例演示预处理期间的错误处理：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#if !defined(__cplusplus)</span>
<span class="cp">#error C++ compiler required.</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<div class="section" id="import">
<h5>1.3 #import<a class="headerlink" href="#import" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="pragma">
<h5>1.4 #pragma<a class="headerlink" href="#pragma" title="永久链接至标题">¶</a></h5>
<p>Pragma指令指定特定于机器或特定于操作系统的编译器特性。 <code class="docutils literal notranslate"><span class="pre">__pragma</span></code> 关键字是特定
于Microsoft编译器的，它允许你在宏定义中编写pragma指令。C99中引入了标准的
<code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> 预处理操作符，并被 C++ 11采用。</p>
<p>语法：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma token-string</span>
<span class="n">__pragma</span><span class="p">(</span><span class="w"> </span><span class="n">token</span><span class="o">-</span><span class="n">string</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="c1">// two leading underscores - Microsoft specific extension</span>
<span class="k">_Pragma</span><span class="p">(</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">literal</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c1">// C99</span>
</pre></div>
</div>
<p>C和C++的每个实现都支持其主机或操作系统特有的一些特性。例如，有些程序必须精确控制
数据在内存中的位置，或控制某些函数接收参数的方式。 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> 指令支持让每个编
译器提供特定于机器和操作系统的特性，同时保持与C和c++语言的整体兼容性。</p>
<p>根据定义，Pragma指令是特定于机器或特定于操作系统的，并且对于每个编译器通常是不同
的。Pragma可以用在条件指令中，以提供新的预处理器功能。或者，使用一个来向编译器提
供实现定义的信息。</p>
<p>标记字符串（ <em>token-string</em> ）用于表示特定于编译器的指令和参数(如果有的话)的一系
列字符。数字符号( <code class="docutils literal notranslate"><span class="pre">#</span></code> )必须是包含pragma指令的行中的第一个非空白字符。空白字符
可以分隔数字符号和单词“pragma”。在 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> 之后，编写可以被翻译程序当作预处
理标记（preprocessing tokens）进行解析的任何文本。 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> 指令的参数受宏扩
展的影响。</p>
<p><em>string-literal</em> 是 <code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> 的输入。删除外部引号和前/后空格。 <code class="docutils literal notranslate"><span class="pre">\&quot;</span></code> 被替换
为 <code class="docutils literal notranslate"><span class="pre">&quot;</span></code> ， <code class="docutils literal notranslate"><span class="pre">\\</span></code> 被替换为 <code class="docutils literal notranslate"><span class="pre">\</span></code> 。</p>
<p>当编译器发现无法识别的 pragma 时，会发出警告，并继续编译。</p>
<p>The Microsoft C and C++ compilers recognize the following pragma directives:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>alloc_text</p></li>
<li><p>detect_mismatch</p></li>
<li><p>intrinsic</p></li>
<li><p>pop_macro</p></li>
<li><p>auto_inline</p></li>
<li><p>endregion</p></li>
<li><p>loop</p></li>
<li><p>push_macro</p></li>
<li><p>bss_seg</p></li>
<li><p>fenv_access</p></li>
<li><p>make_public</p></li>
<li><p>region</p></li>
<li><p>check_stack</p></li>
<li><p>float_control</p></li>
<li><p>managed</p></li>
<li><p>runtime_checks</p></li>
<li><p>code_seg</p></li>
<li><p>fp_contract</p></li>
<li><p>message</p></li>
<li><p>section</p></li>
<li><p>comment</p></li>
<li><p>function</p></li>
<li><p>omp</p></li>
<li><p>setlocale</p></li>
<li><p>component</p></li>
<li><p>hdrstop</p></li>
<li><p>once</p></li>
<li><p>strict_gs_check</p></li>
<li><p>conform</p></li>
<li><p>include_alias</p></li>
<li><p>optimize</p></li>
<li><p>unmanaged</p></li>
<li><p>const_seg</p></li>
<li><p>init_seg</p></li>
<li><p>pack</p></li>
<li><p>vtordisp</p></li>
<li><p>data_seg</p></li>
<li><p>inline_depth</p></li>
<li><p>pointers_to_members</p></li>
<li><p>warning</p></li>
<li><p>deprecated</p></li>
<li><p>line_recursion</p></li>
</ol>
</div></blockquote>
<div class="section" id="id122">
<h6>Pragma指令和编译器选项<a class="headerlink" href="#id122" title="永久链接至标题">¶</a></h6>
<p>一些 pragma 指令提供与编译器选项相同的功能。当在源代码中到达一个 pragma 时，它将
覆盖编译器选项指定的行为。例如，如果在编译器选项中指定了 <em>/Zp8</em> ，你可以用
<em>pack</em> 覆盖特定代码段的编译器设置:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>cl /Zp8 some_file.cpp
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// some_file.cpp - packing is 8</span>
<span class="c1">// ...</span>
<span class="cp">#pragma pack(push, 1) - packing is now 1</span>
<span class="c1">// ...</span>
<span class="cp">#pragma pack(pop) - packing is 8 again</span>
<span class="c1">// ...</span>
</pre></div>
</div>
</div>
<div class="section" id="id123">
<h6>__pragma() 关键字<a class="headerlink" href="#id123" title="永久链接至标题">¶</a></h6>
<p>编译器还支持特定于Microsoft的 <code class="docutils literal notranslate"><span class="pre">__pragma</span></code> 关键字，该关键字的功能与 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code>
指令相同。不同的是， <code class="docutils literal notranslate"><span class="pre">__pragma</span></code> 关键字可以在宏定义中内联使用。 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> 指
令在宏定义中不可用，因为编译器将指令中的数字符号字符（ <em>#</em> ）解释为 <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/stringizing-operator-hash?view=msvc-160">Stringizing operator (#)</a> 。</p>
<p>下面的代码示例演示了如何在宏中使用 <code class="docutils literal notranslate"><span class="pre">__pragma</span></code> 关键字。这段代码摘自
“Compiler COM Support Samples”中的ACDUAL示例中的 <em>mfcdul .h</em> 头文件:</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CATCH_ALL_DUAL \</span>
<span class="cp">CATCH(COleException, e) \</span>
<span class="cp">{ \</span>
<span class="cp">_hr = e-&gt;m_sc; \</span>
<span class="cp">} \</span>
<span class="cp">AND_CATCH_ALL(e) \</span>
<span class="cp">{ \</span>
<span class="cp">__pragma(warning(push)) \</span>
<span class="cp">__pragma(warning(disable:6246)) </span><span class="cm">/*disable _ctlState prefast warning*/</span><span class="cp"> \</span>
<span class="cp">AFX_MANAGE_STATE(pThis-&gt;m_pModuleState); \</span>
<span class="cp">__pragma(warning(pop)) \</span>
<span class="cp">_hr = DualHandleException(_riidSource, e); \</span>
<span class="cp">} \</span>
<span class="cp">END_CATCH_ALL \</span>
<span class="cp">return _hr; \</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="pragma-c99-c-11">
<h6>_Pragma 预处理运算符（C99, C++11）<a class="headerlink" href="#pragma-c99-c-11" title="永久链接至标题">¶</a></h6>
<p><code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> 类似于Microsoft特定的 <code class="docutils literal notranslate"><span class="pre">__pragma</span></code> 关键字，只是它是标准的一部分。
它是在C99中为C语言引入的。对于C++，它是在 C++ 11中引入的。</p>
<p>它允许您将 pragma 指令放入宏定义中。它有一个前导下划线，并且第一个字母是大写的。</p>
<p>字符串字面量应该是你放在 <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> 语句后面的内容。例如:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma message(&quot;the #pragma way&quot;)</span>
<span class="k">_Pragma</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;message( </span><span class="se">\&quot;</span><span class="s">the _Pragma way</span><span class="se">\&quot;</span><span class="s">)&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>引号和反斜杠应该被转义，如上所示。未被识别的 pragma 字符串将被忽略。</p>
<p>下面的代码示例演示了如何在条件表达式碰巧是常量时，当您不想得到警告时，在类似断言
的宏中使用 <code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> 关键字。</p>
<p>The macro definition uses the do-while(0) idiom for multi-statement macros so
that it can be used as though it were one statement. See <a class="reference external" href="https://stackoverflow.com/questions/1067226/c-multi-line-macro-do-while0-vs-scope-block">C multi-line macro</a>
on Stack Overflow for more info. The _Pragma statement only applies to the line of code that follows it.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Compile with /W4</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#define MY_ASSERT(BOOL_EXPRESSION) \</span>
<span class="cp">    do { \</span>
<span class="cp">        _Pragma(&quot;warning(suppress: 4127)&quot;) </span><span class="cm">/* C4127 conditional expression is constant */</span><span class="cp">  \</span>
<span class="cp">        if (!(BOOL_EXPRESSION)) {   \</span>
<span class="cp">            printf(&quot;MY_ASSERT FAILED: \&quot;&quot; #BOOL_EXPRESSION &quot;\&quot; on %s(%d)&quot;, __FILE__, __LINE__); \</span>
<span class="cp">            exit(-1); \</span>
<span class="cp">        } \</span>
<span class="cp">    } while (0)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">MY_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Note that there is no warning: C4127 conditional expression is constant&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="elif">
<h5>1.5 #elif<a class="headerlink" href="#elif" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="if">
<h5>1.6 #if<a class="headerlink" href="#if" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="include">
<h5>1.7 #include<a class="headerlink" href="#include" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="undef">
<h5>1.8 #undef<a class="headerlink" href="#undef" title="永久链接至标题">¶</a></h5>
<p>删除(取消定义)先前用 <code class="docutils literal notranslate"><span class="pre">#define</span></code> 创建的名称。</p>
<p>语法：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#undef identifier</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">#unde</span></code> 指令删除标识符的当前定义。因此，标识符的后续出现被预处理器忽略。要使用
<code class="docutils literal notranslate"><span class="pre">#undef</span></code> 删除宏定义，请仅提供宏标识符，而不是参数列表。</p>
<p>您也可以将 <code class="docutils literal notranslate"><span class="pre">#undef</span></code> 指令应用于没有先前定义的标识符。这确保标识符是未定义的。宏替换不
会在 <code class="docutils literal notranslate"><span class="pre">#undef</span></code> 语句中执行。</p>
<p><code class="docutils literal notranslate"><span class="pre">#unde</span></code> 指令通常与 <code class="docutils literal notranslate"><span class="pre">#define</span></code> 指令配对，以在源程序中创建一个标识符具有特殊含义的区
域。例如，源程序的特定函数可以使用manifest常量来定义不影响程序其余部分的特定于环境的值。
<code class="docutils literal notranslate"><span class="pre">#unde</span></code> 指令还与 <code class="docutils literal notranslate"><span class="pre">#if</span></code> 指令一起工作，以控制源程序的条件编译。</p>
<p>在下面的例子中， <code class="docutils literal notranslate"><span class="pre">#undef</span></code> 指令删除了符号常量和宏的定义。注意，只给出了宏的标识符。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define WIDTH 80</span>
<span class="cp">#define ADD( X, Y ) ((X) + (Y))</span>
<span class="p">.</span><span class="w"></span>
<span class="p">.</span><span class="w"></span>
<span class="p">.</span><span class="w"></span>
<span class="cp">#undef WIDTH</span>
<span class="cp">#undef ADD</span>
</pre></div>
</div>
</div>
<div class="section" id="else">
<h5>1.9 #else<a class="headerlink" href="#else" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="ifdef">
<h5>1.10 #ifdef<a class="headerlink" href="#ifdef" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="line">
<h5>1.11 #line<a class="headerlink" href="#line" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">#line</span></code> 指令告诉预处理器将编译器报告的行号和文件名值设置为给定的行号和文件名。</p>
<p>语法：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#line digit-sequence [&quot;filename&quot;]</span>
</pre></div>
</div>
<p>编译器使用行号和可选文件名来指示编译期间发现的错误。行号通常指当前输入行，文件名指当前输
入文件。行号在处理每一行后递增。</p>
<p><em>digit-sequence</em> 可以是任何整数常量。宏替换可以用于预处理标记，但结果必须符合正确的语
法。文件名可以是任意字符组合，并且必须用双引号（” “）括起来。如果省略文件名，则前一个文件
名保持不变。</p>
<p>您可以通过编写 <code class="docutils literal notranslate"><span class="pre">#line</span></code> 指令来更改源行号和文件名。 <code class="docutils literal notranslate"><span class="pre">#line</span></code> 指令设置源文件中紧跟该指
令的行的值。转换器使用行号和文件名来确定预定义宏 <code class="docutils literal notranslate"><span class="pre">__FILE__</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__LINE__</span></code> 的值。
可以使用这些宏在程序文本中插入自描述性错误消息。</p>
<p><code class="docutils literal notranslate"><span class="pre">__FILE__</span></code> 宏展开为一个字符串，其内容是由双引号(” “)括起来的文件名。</p>
<p>如果您更改了行号和文件名，编译器将忽略以前的值，并继续处理新的值。 <code class="docutils literal notranslate"><span class="pre">#line</span></code> 指令通常用
于程序生成器。它用于指示原始源文件中产生错误消息的地方，而不是用于生成的程序。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// line_directive.cpp</span>
<span class="c1">// Compile by using: cl /W4 /EHsc line_directive.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;This code is on line %d, in file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="cp">#line 10</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;This code is on line %d, in file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="cp">#line 20 &quot;hello.cpp&quot;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;This code is on line %d, in file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;This code is on line %d, in file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">7</span><span class="p">,</span> <span class="ow">in</span> <span class="n">file</span> <span class="n">line_directive</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">This</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">10</span><span class="p">,</span> <span class="ow">in</span> <span class="n">file</span> <span class="n">line_directive</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">This</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">20</span><span class="p">,</span> <span class="ow">in</span> <span class="n">file</span> <span class="n">hello</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">This</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">21</span><span class="p">,</span> <span class="ow">in</span> <span class="n">file</span> <span class="n">hello</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define ASSERT(cond) if( !(cond) )\</span>
<span class="cp">{printf( &quot;assertion error line %d, file(%s)\n&quot;, \</span>
<span class="cp">__LINE__, __FILE__ );}</span>
</pre></div>
</div>
</div>
<div class="section" id="using">
<h5>1.12 #using<a class="headerlink" href="#using" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="endif">
<h5>1.13 #endif<a class="headerlink" href="#endif" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="ifndef">
<h5>1.14 #ifndef<a class="headerlink" href="#ifndef" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id124">
<h4>2. 预处理器运算符（ <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/preprocessor-operators?view=msvc-160">Preprocessor operators</a> ）<a class="headerlink" href="#id124" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id125">
<h4>3. 预定义的宏（ <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/predefined-macros?view=msvc-160">Predefined macros</a> ）<a class="headerlink" href="#id125" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id126">
<h4>4. 编译指示（ <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/pragma-directives-and-the-pragma-keyword?view=msvc-160">Pragmas</a> ）<a class="headerlink" href="#id126" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="id127">
<h3>宏的使用<a class="headerlink" href="#id127" title="永久链接至标题">¶</a></h3>
<p>Visual Studio 中注意相关配置的设置：</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/cpp/build/reference/zc-conformance?view=msvc-160">/Zc (Conformance)</a></p></li>
<li><p>Project Properties -&gt; Configurarion Properties -&gt; C/C++ -&gt; Preprocessor -&gt; Use Standsrd Conforming Preprocessor : Yes (/Zc:preprocessor)
或 <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/build/reference/zc-preprocessor?view=msvc-160">/Zc:preprocessor (Enable preprocessor conformance mode)</a></p></li>
</ul>
</div></blockquote>
<div class="section" id="id128">
<h4>1. 如何调试<a class="headerlink" href="#id128" title="永久链接至标题">¶</a></h4>
<p>很多人因为 “宏编程” 无法调试，而直接 “从入门到放弃” —— 不经意的符号拼写错误、参数个数错
误，导致文本不能正确替换，从而带来满屏的编译错误，最后难以定位问题所在。</p>
<p>由于宏代码会在编译前全部展开，我们可以：</p>
<ul class="simple">
<li><p>让编译器 仅输出预处理结果；</p></li>
<li><p>gcc -E 让编译器 在预处理结束后停止，不进行编译、链接；</p></li>
<li><p>gcc -P 屏蔽编译器 输出预处理结果的 行标记 (linemarker)，减少干扰；</p></li>
<li><p>屏蔽无关的头文件；</p></li>
<li><p>临时删掉不影响宏展开的 #include 行；</p></li>
<li><p>避免多余的引用展开，导致实际关注的宏代码 “被淹没”；</p></li>
<li><p>Visual Studio 中右键 .cpp 文件，Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Preprocessor -&gt; Preprocess to a File: Yes (/P)</p></li>
</ul>
</div>
<div class="section" id="id129">
<h4>2. 特殊符号<a class="headerlink" href="#id129" title="永久链接至标题">¶</a></h4>
<p>和模板元编程不一样，宏编程没有类型的概念，输入和输出都是符号 —— 不涉及编译时的 C++ 语法，
只进行编译前的文本替换：</p>
<blockquote>
<div><ul>
<li><p>一个 <strong>宏参数</strong> 是一个任意的符号序列(token sequence)，不同宏参数之间用逗号分隔；</p></li>
<li><p>每个参数可以是空序列，且空白字符会被忽略（例如 a + 1 和 a+1 相同）；</p></li>
<li><p>在一个参数内，不能出现逗号或不配对的括号（例如 <code class="docutils literal notranslate"><span class="pre">FOO(bool,</span> <span class="pre">std::pair&lt;int,</span> <span class="pre">int&gt;)</span></code>
被认为是 FOO() 有三个参数： <code class="docutils literal notranslate"><span class="pre">bool</span></code>  <code class="docutils literal notranslate"><span class="pre">std::pair&lt;int</span></code> <code class="docutils literal notranslate"><span class="pre">int&gt;</span></code> ）：</p>
<p>如何让 <code class="docutils literal notranslate"><span class="pre">FOO(bool,</span> <span class="pre">std::pair&lt;int,</span> <span class="pre">int&gt;)</span></code> 成为一个参数？</p>
<blockquote>
<div><ol class="arabic">
<li><p>使用类型别名，避免参数中出现逗号：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(A, B) int foo(A x, B y)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">intPair</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>展开后为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>使用括号对封装每个参数（ <strong>元组</strong> ），并在最终展开式移
除括号（ <strong>元组解包</strong> ）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_REMOVE_PARENS(T) PP_REMOVE_PARENS_IMPL T</span>
<span class="cp">#define PP_REMOVE_PARENS_IMPL(...) __VA_ARGS__</span>

<span class="cp">#define FOO(A, B) int foo(A x, B y)</span>
<span class="cp">#define BAR(A, B) FOO(PP_REMOVE_PARENS(A), PP_REMOVE_PARENS(B))</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BAR</span><span class="p">((</span><span class="kt">bool</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS(T)</span></code> 展开为 <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL</span> <span class="pre">T</span></code>
的形式</p></li>
<li><p>如果参数 <code class="docutils literal notranslate"><span class="pre">T</span></code> 是一个 <strong>括号对</strong> ，那么展开结果会变成
<strong>调用宏函数</strong> <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL</span> <span class="pre">(...)</span></code> 的形式</p></li>
<li><p>接着 <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL(...)</span></code> 再展开为参数本身
<code class="docutils literal notranslate"><span class="pre">__VA_ARGS__</span></code> （ 见下文中的 <a class="reference internal" href="#id136"><span class="std std-ref">变长参数</span></a> ），
即元组 <code class="docutils literal notranslate"><span class="pre">T</span></code> 的内容</p></li>
</ul>
</div></blockquote>
<p>展开后为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>另外，常用宏函数代替特殊符号，用于下文中的 <a class="reference internal" href="#id135"><span class="std std-ref">惰性求值</span></a> :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_COMMA() ,</span>
<span class="cp">#define PP_LPAREN() (</span>
<span class="cp">#define PP_RPAREN() )</span>
<span class="cp">#define PP_EMPTY()</span>
</pre></div>
</div>
</div>
<div class="section" id="id130">
<h4>3. 符号拼接<a class="headerlink" href="#id130" title="永久链接至标题">¶</a></h4>
<p>在宏编程中， 通过 <code class="docutils literal notranslate"><span class="pre">##</span></code> 可以获取宏函数的参数的字面量或将其拼接成其它符号，再进一步展开
为目标结果，是宏编程的实现基础。</p>
<p>下文中出现的 <strong>符号拼接</strong> 等同于 <strong>获取宏函数的参数的字面量或将其拼接成其它符号</strong> 。</p>
<p>注意事项：</p>
<blockquote>
<div><ul>
<li><p>如果一个宏参数用于符号拼接，那么它不会被展开：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(SYMBOL) foo_ ## SYMBOL</span>
<span class="cp">#define BAR() bar</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="n">BAR</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>展开后为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo_BAR</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>延迟拼接操作（即在宏参数用于符号拼接之前，先对其进行展开 – 调用一个非符号拼接操
作的宏函数）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define FOO(N) PP_CONCAT(foo_, N)</span>
<span class="cp">#define BAR() bar</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="n">BAR</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>或简单一点的：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(SYMBOL) FOO_IMPL(SYMBOL)</span>
<span class="cp">#define FOO_IMPL(SYMBOL) foo_ ## SYMBOL</span>
<span class="cp">#define BAR() bar</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="n">BAR</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>展开后均为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo_bar</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<p>总结：</p>
<blockquote>
<div><ul>
<li><p>在进入宏函数前，会对所有宏参数进行一次预扫描（prescan），把不是用于符号拼接的所
有参数完全展开；</p></li>
<li><p>在宏函数展开时，用前面预扫描展开后的参数展开目标里面的同名符号；</p></li>
<li><p>在宏函数展开后，替换后的文本会进行二次扫描（scan twice），继续对里面出现的宏进
行展开;</p></li>
<li><p>在预扫描前后，宏函数都要求参数个数必须匹配，否则无法展开（ <strong>需要注意有的编译器
并不会报错</strong> ）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define TwoArgsMacro(x,y) x + y</span>
<span class="cp">#define PP_COMMA() ,</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">TwoArgsMacro</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">PP_COMMA</span><span class="p">()</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w">   </span><span class="c1">// 预扫描前，只有一个参数 &quot;x PP_COMMA() y&quot;</span>
<span class="w">    </span><span class="n">TwoArgsMacro</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">PP_COMMA</span><span class="p">());</span><span class="w">    </span><span class="c1">// 预扫描后，有三个参数 &quot;x,,&quot;</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id131">
<h4>4. 自增自减<a class="headerlink" href="#id131" title="永久链接至标题">¶</a></h4>
<p>借助 <code class="docutils literal notranslate"><span class="pre">PP_CONCAT()</span></code> ，我们可以实现 非负整数增减（即 <em>INC(N) = N + 1 / DEC(N) = N - 1</em> ）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define PP_INC(N) PP_CONCAT(PP_INC_, N)</span>
<span class="cp">#define PP_INC_0 1</span>
<span class="cp">#define PP_INC_1 2</span>
<span class="c1">// ...</span>
<span class="cp">#define PP_INC_254 255</span>
<span class="cp">#define PP_INC_255 256</span>

<span class="cp">#define PP_DEC(N) PP_CONCAT(PP_DEC_, N)</span>
<span class="cp">#define PP_DEC_256 255</span>
<span class="cp">#define PP_DEC_255 254</span>
<span class="c1">// ...</span>
<span class="cp">#define PP_DEC_2 1</span>
<span class="cp">#define PP_DEC_1 0</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PP_INC</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 2</span>
<span class="w">    </span><span class="n">PP_DEC</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 1</span>
<span class="w">    </span><span class="n">PP_INC</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; PP_INC_256 (overflow)</span>
<span class="w">    </span><span class="n">PP_DEC</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; PP_DEC_0  (underflow)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_INC(N)</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_DEC(N)</span></code> 先展开为 <code class="docutils literal notranslate"><span class="pre">PP_INC_N</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_DEC_N</span></code> ，再经
过二次扫描展开为对应数值 <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">+</span> <span class="pre">1</span></code> / <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">-</span> <span class="pre">1</span></code> 的符号；</p></li>
<li><p>但上述操作有上限，若超出则无法继续展开（例如 <a class="reference external" href="https://www.boost.org/doc/libs/master/libs/preprocessor/doc/ref/limit_mag.html">BOOST_PP 数值操作的上限是 256</a> ）。</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id132">
<h4>5. 逻辑运算<a class="headerlink" href="#id132" title="永久链接至标题">¶</a></h4>
<p>借助 <code class="docutils literal notranslate"><span class="pre">PP_CONCAT()</span></code> ，我们可以实现 布尔类型（0 和 1）的 逻辑运算（与/或/非/异或/同或）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define PP_NOT(N) PP_CONCAT(PP_NOT_, N)</span>
<span class="cp">#define PP_NOT_0 1</span>
<span class="cp">#define PP_NOT_1 0</span>

<span class="cp">#define PP_AND(A, B) PP_CONCAT(PP_AND_, PP_CONCAT(A, B))</span>
<span class="cp">#define PP_AND_00 0</span>
<span class="cp">#define PP_AND_01 0</span>
<span class="cp">#define PP_AND_10 0</span>
<span class="cp">#define PP_AND_11 1</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PP_AND</span><span class="p">(</span><span class="n">PP_NOT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; 1</span>
<span class="w">    </span><span class="n">PP_AND</span><span class="p">(</span><span class="n">PP_NOT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; PP_AND_PP_NOT_20</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p>原理和 <code class="docutils literal notranslate"><span class="pre">PP_INC()</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_DEC()</span></code> 类似（符号拼接 + 二次展开）；</p></li>
<li><p>但上述操作不支持 非负整数 的通用逻辑运算（仅支持 0 和 1）；</p></li>
<li><p>如果通过定义 <code class="docutils literal notranslate"><span class="pre">PP_NOT_2</span></code> 来支持 <code class="docutils literal notranslate"><span class="pre">PP_NOT(2)</span></code> ，宏代码会急剧膨胀。一元运算
<code class="docutils literal notranslate"><span class="pre">PP_NOT()</span></code> 需要考虑 <em>N</em> 种组合，二元运算 <code class="docutils literal notranslate"><span class="pre">PP_AND()</span></code> 则要考虑 <em>N^2</em> 种组
合。</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id133">
<h4>6. 布尔转换<a class="headerlink" href="#id133" title="永久链接至标题">¶</a></h4>
<p>为了支持更通用的非负整数的逻辑运算，可以先将整数转换成布尔类型，而不是扩展布尔类型的逻辑
运算：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="linenos"> 2</span><span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#define PP_NOT(N) PP_CONCAT(PP_NOT_, N)</span>
<span class="linenos"> 5</span><span class="cp">#define PP_NOT_0 1</span>
<span class="linenos"> 6</span><span class="cp">#define PP_NOT_1 0</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#define PP_AND(A, B) PP_CONCAT(PP_AND_, PP_CONCAT(A, B))</span>
<span class="linenos"> 9</span><span class="cp">#define PP_AND_00 0</span>
<span class="linenos">10</span><span class="cp">#define PP_AND_01 0</span>
<span class="linenos">11</span><span class="cp">#define PP_AND_10 0</span>
<span class="linenos">12</span><span class="cp">#define PP_AND_11 1</span>
<span class="linenos">13</span>
<span class="hll"><span class="linenos">14</span><span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
</span><span class="hll"><span class="linenos">15</span><span class="cp">#define PP_BOOL_0 0</span>
</span><span class="hll"><span class="linenos">16</span><span class="cp">#define PP_BOOL_1 1</span>
</span><span class="hll"><span class="linenos">17</span><span class="cp">#define PP_BOOL_2 1</span>
</span><span class="hll"><span class="linenos">18</span><span class="c1">// ...</span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">PP_AND</span><span class="p">(</span><span class="n">PP_NOT</span><span class="p">(</span><span class="n">PP_BOOL</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"> </span><span class="n">PP_BOOL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w">  </span><span class="c1">// -&gt; 0</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">PP_NOT</span><span class="p">(</span><span class="n">PP_BOOL</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span><span class="w">                   </span><span class="c1">// -&gt; PP_NOT_PP_BOOL_1000</span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p>原理和 <code class="docutils literal notranslate"><span class="pre">PP_INC()</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_DEC()</span></code> 类似（符号拼接 + 二次展开）；</p></li>
<li><p>同理，上述操作也有上限，若超出则无法继续展开。</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id134">
<h4>7. 条件选择<a class="headerlink" href="#id134" title="永久链接至标题">¶</a></h4>
<p>借助 <code class="docutils literal notranslate"><span class="pre">PP_CONCAT()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">PP_BOOL()</span></code> ，我们可以实现通用的条件选择表达式
<code class="docutils literal notranslate"><span class="pre">(PRED</span> <span class="pre">?</span> <span class="pre">THEN</span> <span class="pre">:</span> <span class="pre">ELSE)</span></code> ，其中 PRED 可以是 任意非负整数）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define PP_DEC(N) PP_CONCAT(PP_DEC_, N)</span>
<span class="cp">#define PP_DEC_256 255</span>
<span class="cp">#define PP_DEC_255 254</span>
<span class="c1">// ...</span>
<span class="cp">#define PP_DEC_2 1</span>
<span class="cp">#define PP_DEC_1 0</span>

<span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
<span class="cp">#define PP_BOOL_0 0</span>
<span class="cp">#define PP_BOOL_1 1</span>
<span class="cp">#define PP_BOOL_2 1</span>
<span class="c1">// ...</span>

<span class="cp">#define PP_IF(PRED, THEN, ELSE) PP_CONCAT(PP_IF_, PP_BOOL(PRED))(THEN, ELSE)</span>
<span class="cp">#define PP_IF_1(THEN, ELSE) THEN</span>
<span class="cp">#define PP_IF_0(THEN, ELSE) ELSE</span>

<span class="cp">#define DEC_SAFE(N) PP_IF(N, PP_DEC(N), 0)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">DEC_SAFE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 1</span>
<span class="w">    </span><span class="n">DEC_SAFE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">DEC_SAFE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 0</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_IF()</span></code> 先会根据转换后的条件 <code class="docutils literal notranslate"><span class="pre">PP_BOOL(PRED)</span></code> 选择 <code class="docutils literal notranslate"><span class="pre">PP_IF_1</span></code> 或
<code class="docutils literal notranslate"><span class="pre">PP_IF_0</span></code> 符号</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PP_IF_1()</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_IF_0()</span></code> 接受相同的参数，但分别展开为 <code class="docutils literal notranslate"><span class="pre">THEN</span></code> 或
<code class="docutils literal notranslate"><span class="pre">ELSE</span></code> 参数</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id135">
<h4>8. 惰性求值<a class="headerlink" href="#id135" title="永久链接至标题">¶</a></h4>
<p>需要注意 <code class="docutils literal notranslate"><span class="pre">PP_IF()</span></code> 的参数会在预扫描阶段被完全展开，例如 <code class="docutils literal notranslate"><span class="pre">PP_COMMA()</span></code> 会被立即展开
为逗号，从而导致参数个数错误（ Visual Studio 2019 中并未产生错误）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="linenos"> 2</span><span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#define PP_DEC(N) PP_CONCAT(PP_DEC_, N)</span>
<span class="linenos"> 5</span><span class="cp">#define PP_DEC_256 255</span>
<span class="linenos"> 6</span><span class="cp">#define PP_DEC_255 254</span>
<span class="linenos"> 7</span><span class="c1">// ...</span>
<span class="linenos"> 8</span><span class="cp">#define PP_DEC_2 1</span>
<span class="linenos"> 9</span><span class="cp">#define PP_DEC_1 0</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
<span class="linenos">12</span><span class="cp">#define PP_BOOL_0 0</span>
<span class="linenos">13</span><span class="cp">#define PP_BOOL_1 1</span>
<span class="linenos">14</span><span class="cp">#define PP_BOOL_2 1</span>
<span class="linenos">15</span><span class="c1">// ...</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#define PP_IF(PRED, THEN, ELSE) PP_CONCAT(PP_IF_, PP_BOOL(PRED))(THEN, ELSE)</span>
<span class="linenos">18</span><span class="cp">#define PP_IF_1(THEN, ELSE) THEN</span>
<span class="linenos">19</span><span class="cp">#define PP_IF_0(THEN, ELSE) ELSE</span>
<span class="linenos">20</span>
<span class="hll"><span class="linenos">21</span><span class="cp">#define PP_COMMA() ,</span>
</span><span class="hll"><span class="linenos">22</span><span class="cp">#define PP_LPAREN() (</span>
</span><span class="hll"><span class="linenos">23</span><span class="cp">#define PP_RPAREN() )</span>
</span><span class="hll"><span class="linenos">24</span><span class="cp">#define PP_EMPTY()</span>
</span><span class="linenos">25</span>
<span class="hll"><span class="linenos">26</span><span class="cp">#define PP_COMMA_IF(N) PP_IF(N, PP_COMMA(), PP_EMPTY())</span>
</span><span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">29</span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">PP_COMMA_IF</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>常用的技巧是惰性求值 (lazy evaluation)，即条件选择先返回宏函数，再传递参数延迟调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="linenos"> 2</span><span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#define PP_DEC(N) PP_CONCAT(PP_DEC_, N)</span>
<span class="linenos"> 5</span><span class="cp">#define PP_DEC_256 255</span>
<span class="linenos"> 6</span><span class="cp">#define PP_DEC_255 254</span>
<span class="linenos"> 7</span><span class="c1">// ...</span>
<span class="linenos"> 8</span><span class="cp">#define PP_DEC_2 1</span>
<span class="linenos"> 9</span><span class="cp">#define PP_DEC_1 0</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
<span class="linenos">12</span><span class="cp">#define PP_BOOL_0 0</span>
<span class="linenos">13</span><span class="cp">#define PP_BOOL_1 1</span>
<span class="linenos">14</span><span class="cp">#define PP_BOOL_2 1</span>
<span class="linenos">15</span><span class="c1">// ...</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#define PP_IF(PRED, THEN, ELSE) PP_CONCAT(PP_IF_, PP_BOOL(PRED))(THEN, ELSE)</span>
<span class="linenos">18</span><span class="cp">#define PP_IF_1(THEN, ELSE) THEN</span>
<span class="linenos">19</span><span class="cp">#define PP_IF_0(THEN, ELSE) ELSE</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="cp">#define PP_COMMA() ,</span>
<span class="linenos">22</span><span class="cp">#define PP_LPAREN() (</span>
<span class="linenos">23</span><span class="cp">#define PP_RPAREN() )</span>
<span class="linenos">24</span><span class="cp">#define PP_EMPTY()</span>
<span class="linenos">25</span>
<span class="hll"><span class="linenos">26</span><span class="cp">#define PP_COMMA_IF(N) PP_IF(N, PP_COMMA, PP_EMPTY)()</span>
</span><span class="linenos">27</span>
<span class="hll"><span class="linenos">28</span><span class="cp">#define SURROUND(N) PP_IF(N, PP_LPAREN, [PP_EMPTY)() \</span>
</span><span class="hll"><span class="linenos">29</span><span class="cp">                    N                                 \</span>
</span><span class="hll"><span class="linenos">30</span><span class="cp">                    PP_IF(N, PP_RPAREN, ] PP_EMPTY)()</span>
</span><span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">33</span><span class="p">{</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="n">PP_COMMA_IF</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// (empty)</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">PP_COMMA_IF</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; ,</span>
<span class="linenos">36</span><span class="w">    </span><span class="n">PP_COMMA_IF</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; ,</span>
<span class="linenos">37</span>
<span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="n">SURROUND</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; [0]</span>
</span><span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="n">SURROUND</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; (1)</span>
</span><span class="hll"><span class="linenos">40</span><span class="w">    </span><span class="n">SURROUND</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; (2)</span>
</span><span class="linenos">41</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_COMMA_IF()</span></code> 先借助 <code class="docutils literal notranslate"><span class="pre">PP_IF()</span></code> 返回 <code class="docutils literal notranslate"><span class="pre">PP_COMMA</span></code> 或 <code class="docutils literal notranslate"><span class="pre">PP_EMPTY</span></code> 符
号；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PP_COMMA</span></code> / <code class="docutils literal notranslate"><span class="pre">PP_EMPTY</span></code> 和后边的括号对组成 <code class="docutils literal notranslate"><span class="pre">PP_COMMA()</span></code> /
<code class="docutils literal notranslate"><span class="pre">PP_EMPTY()</span></code> ，再继续展开为逗号或空；</p></li>
<li><p>如果需要展开为其他符号 <code class="docutils literal notranslate"><span class="pre">SYMBOL</span></code> ，可以使用 <code class="docutils literal notranslate"><span class="pre">SYMBOL</span></code> <code class="docutils literal notranslate"><span class="pre">PP_EMPTY</span></code> 作为参
数，和后边的括号对组成 <code class="docutils literal notranslate"><span class="pre">PP_EMPTY()</span></code> （例如 <code class="docutils literal notranslate"><span class="pre">SURROUND()</span></code> 使用的 <code class="docutils literal notranslate"><span class="pre">[</span></code> 和
<code class="docutils literal notranslate"><span class="pre">]</span></code> ）。</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id136">
<h4>9. 变长参数<a class="headerlink" href="#id136" title="永久链接至标题">¶</a></h4>
<p>从 C++ 11 开始，宏函数支持了变长参数 <code class="docutils literal notranslate"><span class="pre">...</span></code> ，接受任意个宏参数（用逗号分隔）：</p>
<blockquote>
<div><ul class="simple">
<li><p>传入的变长参数可以用 <code class="docutils literal notranslate"><span class="pre">__VA_ARGS__</span></code> 获取（也可以通过 <code class="docutils literal notranslate"><span class="pre">#__VA_ARGS__</span></code> 获取
逗号+空格分隔的参数字面量）；</p></li>
<li><p>另外，允许传递空参数，即 <code class="docutils literal notranslate"><span class="pre">__VA_ARGS__</span></code> 替换为空。</p></li>
</ul>
</div></blockquote>
<p>对于空参数，展开时需要处理多余逗号的问题（Visual Studio 2019 中测试时并未有产生该错误，
可通过对编译器进行相关的设置 <a class="reference external" href="https://docs.microsoft.com/en-us/cpp/preprocessor/variadic-macros?view=msvc-160">/Zc:preprocessor</a>）：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#define log(format, ...) printf(format, __VA_ARGS__)</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;%d%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mf">.2</span><span class="p">);</span><span class="w">      </span><span class="c1">// -&gt; printf(&quot;%d%f&quot;, 1, .2);</span>
<span class="hll"><span class="linenos">6</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span><span class="w">     </span><span class="c1">// -&gt; printf(&quot;hello world&quot;, );</span>
</span><span class="hll"><span class="linenos">7</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">);</span><span class="w">   </span><span class="c1">// -&gt; printf(&quot;hello world&quot;, );</span>
</span><span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>后两种调用 分别对应 不传变长参数、变长参数为空 的情况</p></li>
<li><p>展开结果会 多出一个逗号，导致 C/C++ 编译错误（而不是 宏展开错误）</p></li>
</ul>
<p>以下是在 Visual Studio 2019 中的没有错误的输出：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mf">.2</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>为了解决这个问题，一些编译器（例如 gcc/clang）扩展了 , <code class="docutils literal notranslate"><span class="pre">##</span> <span class="pre">__VA_ARGS__</span></code> 的用法 ——
如果 <strong>不传变长参数</strong> ，则省略前面的逗号：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#define log(format, ...) printf(format, ##__VA_ARGS__)</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;%d%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">.2</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; printf(&quot;%d%f&quot;, 1, .2);</span>
<span class="hll"><span class="linenos">6</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; printf(&quot;hello world&quot;);</span>
</span><span class="hll"><span class="linenos">7</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; printf(&quot;hello world&quot;, );</span>
</span><span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>以下是在 Visual Studio 2019 中的没有错误的输出：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d%f&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">.2</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>为了进一步处理 <strong>变长参数为空</strong> 的情况，C++ 20 引入了 <code class="docutils literal notranslate"><span class="pre">__VA_OPT__</span></code> 标识符 —— 如果变
长参数是空参数，不展开该符号（不仅限于逗号）：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#define log(format, ...) printfformat __VA_OPT__(,) __VA_ARGS__)</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;%d%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">.2</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; printf(&quot;%d%f&quot;, 1, .2);</span>
<span class="hll"><span class="linenos">6</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; printf(&quot;hello world&quot;);</span>
</span><span class="hll"><span class="linenos">7</span><span class="w">    </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; printf(&quot;hello world&quot;);</span>
</span><span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>下文将借助 <a class="reference internal" href="#id138"><span class="std std-ref">长度判空</span></a> 和 <a class="reference internal" href="#id140"><span class="std std-ref">遍历访问</span></a>，
实现 __VA_OPT__(,) 的功能。</p>
</div>
<div class="section" id="id137">
<h4>10. 下标访问<a class="headerlink" href="#id137" title="永久链接至标题">¶</a></h4>
<p>借助 PP_CONCAT()，我们可以通过 下标访问 变长参数的 特定元素：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define PP_GET_N(N, ...) PP_CONCAT(PP_GET_N_, N)(__VA_ARGS__)</span>
<span class="cp">#define PP_GET_N_0(_0, ...) _0</span>
<span class="cp">#define PP_GET_N_1(_0, _1, ...) _1</span>
<span class="cp">#define PP_GET_N_2(_0, _1, _2, ...) _2</span>
<span class="c1">// ...</span>
<span class="cp">#define PP_GET_N_8(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...) _8</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PP_GET_N</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">);</span><span class="w">       </span><span class="c1">// -&gt; foo</span>
<span class="w">    </span><span class="n">PP_GET_N</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; bar</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>注意以下代码：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="linenos"> 2</span><span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#define PP_GET_N(N, ...) PP_CONCAT(PP_GET_N_, N)(__VA_ARGS__)</span>
<span class="linenos"> 5</span><span class="cp">#define PP_GET_N_0(_0, ...) _0</span>
<span class="linenos"> 6</span><span class="cp">#define PP_GET_N_1(_0, _1, ...) _1</span>
<span class="linenos"> 7</span><span class="cp">#define PP_GET_N_2(_0, _1, _2, ...) _2</span>
<span class="linenos"> 8</span><span class="c1">// ...</span>
<span class="linenos"> 9</span><span class="cp">#define PP_GET_N_8(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...) _8</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
<span class="linenos">14</span><span class="w">    </span><span class="cp">#define PP_BOOL_0 0</span>
<span class="linenos">15</span><span class="w">    </span><span class="cp">#define PP_BOOL_1 1</span>
<span class="linenos">16</span><span class="w">   </span><span class="c1">// ...</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="cp">#define PP_IF(PRED, THEN, ELSE) PP_CONCAT(PP_IF_, PP_BOOL(PRED))(THEN, ELSE)</span>
<span class="linenos">19</span><span class="w">    </span><span class="cp">#define PP_IF_1(THEN, ELSE) THEN</span>
<span class="linenos">20</span><span class="w">    </span><span class="cp">#define PP_IF_0(THEN, ELSE) ELSE</span>
<span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="cp">#define FOO(P, ...) PP_IF(P, PP_GET_N(1,__VA_ARGS__), PP_GET_N(0, __VA_ARGS__))</span>
</span><span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>第 22 行展开时，虽然目标是对 <code class="docutils literal notranslate"><span class="pre">PP_GET_N(0,</span> <span class="pre">__VA_ARGS__)</span></code> 这部分进行处理，但是注
意此时这里的 <code class="docutils literal notranslate"><span class="pre">PP_GET_N(1,__VA_ARGS__)</span></code> 仍然会进行展开，因此在调用 <code class="docutils literal notranslate"><span class="pre">FOO(0,</span> <span class="pre">foo)</span></code>
时会因为参数过少而展开失败：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span> <span class="n">C4003</span><span class="p">:</span> <span class="ow">not</span> <span class="n">enough</span> <span class="n">arguments</span> <span class="k">for</span> <span class="n">function</span><span class="o">-</span><span class="n">like</span> <span class="n">macro</span> <span class="n">invocation</span> <span class="s1">&#39;PP_GET_N_1&#39;</span>
</pre></div>
</div>
<p>可以通过上文中提到的 <a class="reference internal" href="#id135"><span class="std std-ref">惰性求值</span></a> 来解决该问题：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="linenos"> 2</span><span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#define PP_GET_N(N, ...) PP_CONCAT(PP_GET_N_, N)(__VA_ARGS__)</span>
<span class="linenos"> 5</span><span class="cp">#define PP_GET_N_0(_0, ...) _0</span>
<span class="linenos"> 6</span><span class="cp">#define PP_GET_N_1(_0, _1, ...) _1</span>
<span class="linenos"> 7</span><span class="cp">#define PP_GET_N_2(_0, _1, _2, ...) _2</span>
<span class="linenos"> 8</span><span class="c1">// ...</span>
<span class="linenos"> 9</span><span class="cp">#define PP_GET_N_8(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...) _8</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="cp">#define PP_BOOL(N) PP_CONCAT(PP_BOOL_, N)</span>
<span class="linenos">14</span><span class="w">    </span><span class="cp">#define PP_BOOL_0 0</span>
<span class="linenos">15</span><span class="w">    </span><span class="cp">#define PP_BOOL_1 1</span>
<span class="linenos">16</span><span class="w">   </span><span class="c1">// ...</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="cp">#define PP_IF(PRED, THEN, ELSE) PP_CONCAT(PP_IF_, PP_BOOL(PRED))(THEN, ELSE)</span>
<span class="linenos">19</span><span class="w">    </span><span class="cp">#define PP_IF_1(THEN, ELSE) THEN</span>
<span class="linenos">20</span><span class="w">    </span><span class="cp">#define PP_IF_0(THEN, ELSE) ELSE</span>
<span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="cp">#define FOO(P, ...) PP_IF(P, PP_CONCAT(PP_GET_N_,1),PP_CONCAT(PP_GET_N_,0))(__VA_ARGS__)</span>
</span><span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; foo</span>
<span class="linenos">25</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>实现下标访问的另外一个版本：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define metamacro_concat_(A, B) A ## B</span>

<span class="cm">/**</span>
<span class="cm"> * Returns A and B concatenated after full macro expansion.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="cp">#define metamacro_concat(A, B) \</span>
<span class="cp">        metamacro_concat_(A, B)</span>

<span class="w"> </span><span class="cm">/**</span>
<span class="cm">  * Returns the Nth variadic argument (starting from zero). At least</span>
<span class="cm">  * N + 1 variadic arguments must be given. N must be between zero and twenty,</span>
<span class="cm">  * inclusive.</span>
<span class="cm">  */</span><span class="w"></span>
<span class="cp">#define metamacro_at(N, ...) \</span>
<span class="cp">        metamacro_concat(metamacro_at, N)(__VA_ARGS__)</span>

<span class="hll"><span class="cp">#define metamacro_head(...) metamacro_head_(__VA_ARGS__, 0)</span>
</span><span class="cp">#define metamacro_head_(FIRST, ...) FIRST</span>

<span class="w">  </span><span class="c1">// metamacro_at expansions</span>
<span class="cp">#define metamacro_at0(...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at1(_0, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at2(_0, _1, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at3(_0, _1, _2, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at4(_0, _1, _2, _3, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at5(_0, _1, _2, _3, _4, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at6(_0, _1, _2, _3, _4, _5, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at7(_0, _1, _2, _3, _4, _5, _6, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at8(_0, _1, _2, _3, _4, _5, _6, _7, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at9(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at10(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at11(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at12(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at13(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at14(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at15(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at16(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at17(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at18(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at19(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, ...) metamacro_head(__VA_ARGS__)</span>
<span class="cp">#define metamacro_at20(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, _19, ...) metamacro_head(__VA_ARGS__)</span>

<span class="cm">/**</span>
<span class="cm"> * Returns the number of arguments (up to twenty) provided to the macro. At</span>
<span class="cm"> * least one argument must be provided.</span>
<span class="cm"> *</span>
<span class="cm"> * Inspired by P99: http://p99.gforge.inria.fr</span>
<span class="cm"> */</span><span class="w"></span>
<span class="cp">#define metamacro_argcount(...) \</span>
<span class="cp">        metamacro_at(20, __VA_ARGS__, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">metamacro_at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">);</span><span class="w">      </span><span class="c1">// -&gt; foo</span>
<span class="w">    </span><span class="n">metamacro_at</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">);</span><span class="w">      </span><span class="c1">// -&gt; bar</span>

<span class="w">    </span><span class="n">metamacro_argcount</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w">       </span><span class="c1">// -&gt; 2</span>
<span class="w">    </span><span class="n">metamacro_argcount</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 3</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id138">
<h4>11. 长度判空<a class="headerlink" href="#id138" title="永久链接至标题">¶</a></h4>
<p>借助 PP_GET_N()，我们可以检查 变长参数是否为空：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_CONCAT(A, B) PP_CONCAT_IMPL(A, B)</span>
<span class="cp">#define PP_CONCAT_IMPL(A, B) A##B</span>

<span class="cp">#define PP_NOT(N) PP_CONCAT(PP_NOT_, N)</span>
<span class="cp">#define PP_NOT_0 1</span>
<span class="cp">#define PP_NOT_1 0</span>

<span class="cp">#define PP_AND(A, B) PP_CONCAT(PP_AND_, PP_CONCAT(A, B))</span>
<span class="cp">#define PP_AND_00 0</span>
<span class="cp">#define PP_AND_01 0</span>
<span class="cp">#define PP_AND_10 0</span>
<span class="cp">#define PP_AND_11 1</span>

<span class="cp">#define PP_GET_N(N, ...) PP_CONCAT(PP_GET_N_, N)(__VA_ARGS__)</span>
<span class="cp">#define PP_GET_N_0(_0, ...) _0</span>
<span class="cp">#define PP_GET_N_1(_0, _1, ...) _1</span>
<span class="cp">#define PP_GET_N_2(_0, _1, _2, ...) _2</span>
<span class="c1">// ...</span>
<span class="cp">#define PP_GET_N_8(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...) _8</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#define PP_COMMA_V(...) ,</span>
<span class="w">    </span><span class="cp">#define PP_HAS_COMMA(...) PP_GET_N_8(__VA_ARGS__, 1, 1, 1, 1, 1, 1, 1, 0, 0)</span>

<span class="w">    </span><span class="cp">#define PP_IS_EMPTY(...)                                      \</span>
<span class="cp">      PP_AND(PP_AND(PP_NOT(PP_HAS_COMMA(__VA_ARGS__)),            \</span>
<span class="cp">                    PP_NOT(PP_HAS_COMMA(__VA_ARGS__()))),         \</span>
<span class="cp">             PP_AND(PP_NOT(PP_HAS_COMMA(PP_COMMA_V __VA_ARGS__)), \</span>
<span class="cp">                    PP_HAS_COMMA(PP_COMMA_V __VA_ARGS__())))</span>

<span class="w">    </span><span class="cp">#define PP_COMMA() ,</span>
<span class="w">    </span><span class="cp">#define PP_LPAREN() (</span>
<span class="w">    </span><span class="cp">#define PP_RPAREN() )</span>
<span class="w">    </span><span class="cp">#define PP_EMPTY()</span>



<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">();</span><span class="w">          </span><span class="c1">// -&gt; 1</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w">       </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(</span><span class="n">foo</span><span class="p">());</span><span class="w">     </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(());</span><span class="w">        </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(()</span><span class="n">foo</span><span class="p">);</span><span class="w">     </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(</span><span class="n">PP_EMPTY</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(</span><span class="n">PP_COMMA</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(,</span><span class="w"> </span><span class="p">);</span><span class="w">        </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">);</span><span class="w">  </span><span class="c1">// -&gt; 0</span>
<span class="w">    </span><span class="n">PP_IS_EMPTY</span><span class="p">(,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">);</span><span class="w">    </span><span class="c1">// -&gt; 0</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>说明：</p>
<blockquote>
<div><p>先定义两个辅助宏：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_HAS_COMMA()</span></code> 用于检查变长参数里 有没有逗号；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PP_COMMA_V()</span></code> 用于吃掉(eat) 变长参数，并返回一个逗号。</p></li>
</ul>
</div></blockquote>
<p>如果变长参数为空，需要满足以下条件：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_COMMA_V</span> <span class="pre">__VA_ARGS__()</span></code> 展开为逗号，即构成 PP_COMMA_V() 的形式；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__VA_ARGS__</span></code> 、 <code class="docutils literal notranslate"><span class="pre">__VA_ARGS__()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">PP_COMMA_V</span> <span class="pre">__VA_ARGS__</span></code>
展开结果里 没有逗号，排除对上一个条件的干扰。</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id139">
<h4>12. 长度计算<a class="headerlink" href="#id139" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id140">
<h4>13. 遍历访问<a class="headerlink" href="#id140" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id141">
<h4>14. 符号匹配<a class="headerlink" href="#id141" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id142">
<h4>16. 递归重入<a class="headerlink" href="#id142" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id143">
<h4>17. 条件循环<a class="headerlink" href="#id143" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id144">
<h4>18. 延迟展开<a class="headerlink" href="#id144" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id145">
<h4>19. 数值运算<a class="headerlink" href="#id145" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id146">
<h4>20. 数值比较<a class="headerlink" href="#id146" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id147">
<h4>21. 结合模板<a class="headerlink" href="#id147" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id148">
<h4>一、 #define 的基本用法<a class="headerlink" href="#id148" title="永久链接至标题">¶</a></h4>
<div class="section" id="id149">
<h5>1.1 #define 命令解析<a class="headerlink" href="#id149" title="永久链接至标题">¶</a></h5>
<div class="section" id="id150">
<h6>1.1.1 #define 的概念<a class="headerlink" href="#id150" title="永久链接至标题">¶</a></h6>
<p><strong>#define</strong> 命令是C语言中的一个宏定义命令，它用来将一个 <strong>标识符</strong> 定义为一个
<strong>字符串</strong> ，该标识符被称为 <strong>宏名</strong> ，被定义的字符串称为 <strong>替换文本</strong> 。</p>
<p>该命令有两种格式：简单的宏定义和带参数的宏定义。</p>
<ol class="arabic">
<li><p>简单的宏定义</p>
<p>格式： <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">&lt;宏名&gt;</span> <span class="pre">&lt;替换文本&gt;</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PI 3.1415926</span>
</pre></div>
</div>
</li>
<li><p>带参数的宏定义</p>
<p>格式： <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">&lt;宏名&gt;(&lt;参数列表&gt;)</span> <span class="pre">&lt;替换文本&gt;</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define A(x) x</span>
</pre></div>
</div>
<p>注意事项：</p>
<blockquote>
<div><ol class="arabic">
<li><p>一个宏参数是一个任意的符号序列（token sequence），不同宏参数之
间用逗号分隔；</p></li>
<li><p>一个宏参数可以是空序列；</p></li>
<li><p>一个宏参数内不能出现逗号或不匹配的括号。</p>
<p>例如： <code class="docutils literal notranslate"><span class="pre">FOO(bool,</span> <span class="pre">std::pair&lt;int,</span> <span class="pre">int&gt;)</span></code> 被认为是 FOO() 有三个参
数： <code class="docutils literal notranslate"><span class="pre">bool</span></code> <code class="docutils literal notranslate"><span class="pre">std::pair&lt;int</span></code> <code class="docutils literal notranslate"><span class="pre">int</span></code></p>
<p>如何让 <code class="docutils literal notranslate"><span class="pre">FOO(bool,</span> <span class="pre">std::pair&lt;int,</span> <span class="pre">int&gt;)</span></code> 成为一个参数？</p>
<blockquote>
<div><ol class="arabic">
<li><p>使用类型别名，避免参数中出现逗号：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(A, B) int foo(A x, B y)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">intPair</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>展开后为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">intPair</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>使用括号对封装每个参数（ <strong>元组</strong> ），并在最终展开式移
除括号（ <strong>元组解包</strong> ）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PP_REMOVE_PARENS(T) PP_REMOVE_PARENS_IMPL T</span>
<span class="cp">#define PP_REMOVE_PARENS_IMPL(...) __VA_ARGS__</span>

<span class="cp">#define FOO(A, B) int foo(A x, B y)</span>
<span class="cp">#define BAR(A, B) FOO(PP_REMOVE_PARENS(A), PP_REMOVE_PARENS(B))</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BAR</span><span class="p">((</span><span class="kt">bool</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS(T)</span></code> 展开为 <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL</span> <span class="pre">T</span></code>
的形式</p></li>
<li><p>如果参数 <code class="docutils literal notranslate"><span class="pre">T</span></code> 是一个 <strong>括号对</strong> ，那么展开结
果会变成 <strong>调用宏函数</strong> <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL</span> <span class="pre">(...)</span></code> 的形式</p></li>
<li><p>接着 <code class="docutils literal notranslate"><span class="pre">PP_REMOVE_PARENS_IMPL(...)</span></code> 再展开
为参数本身 <code class="docutils literal notranslate"><span class="pre">__VA_ARGS__</span></code> （ <strong>变长参数</strong> ），
即元组 <code class="docutils literal notranslate"><span class="pre">T</span></code> 的内容</p></li>
</ul>
</div></blockquote>
<p>展开后为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
</ol>
<p>一个标识符被宏定义后，该标识符便是一个宏名。这时，在程序中出现的是宏名，在该程序
被编译前，先将宏名用被定义的字符串替换，这称为 <strong>宏替换</strong> ，替换后才进行编译，宏
替换是简单的替换</p>
</div>
<div class="section" id="id151">
<h6>1.1.2 宏替换发生的时机<a class="headerlink" href="#id151" title="永久链接至标题">¶</a></h6>
<p>在 build 一份 C++ 源代码时，主要经过了预处理、编译、汇编和链接几个过程。</p>
</div>
</div>
<div class="section" id="id152">
<h5>1.2 #define 使用中的常见问题解析<a class="headerlink" href="#id152" title="永久链接至标题">¶</a></h5>
<div class="section" id="id153">
<h6>1.2.1 简单宏定义使用中出现的问题<a class="headerlink" href="#id153" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id154">
<h6>1.2.2 带参数宏定义使用中出现的问题<a class="headerlink" href="#id154" title="永久链接至标题">¶</a></h6>
</div>
</div>
<div class="section" id="id155">
<h5>1.3 宏定义的优点<a class="headerlink" href="#id155" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id156">
<h5>1.4 结语<a class="headerlink" href="#id156" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id157">
<h4>二、 #define 中的三个特殊符号： #，##，#&#64;<a class="headerlink" href="#id157" title="永久链接至标题">¶</a></h4>
<div class="section" id="x-y">
<h5>2.1 x##y<a class="headerlink" href="#x-y" title="永久链接至标题">¶</a></h5>
<p>将参数x展开后的文本和参数y展开后的文本直接拼接在一起。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define A(x,y) x##y     </span><span class="c1">// A(123, 456)  -&gt;  123456</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="x">
<h5>2.2 #&#64;x<a class="headerlink" href="#x" title="永久链接至标题">¶</a></h5>
<p>使用单引号将x参数展开后的内文本包围起来。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define B(x) #@x     </span><span class="c1">// B(123)  -&gt;  &#39;123&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id158">
<h5>2.3 #x<a class="headerlink" href="#id158" title="永久链接至标题">¶</a></h5>
<p>使用双引号将x参数展开后的文本包围起来。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define C(x) #x     </span><span class="c1">// C(123)  -&gt;  &quot;123&quot;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="id159">
<h4>三、 常用的一些宏定义<a class="headerlink" href="#id159" title="永久链接至标题">¶</a></h4>
<ol class="arabic">
<li><p>防止一个头文件被重复 include</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#ifndef SAMPLE_H</span>
<span class="linenos">2</span><span class="cp">#define SAMPLE_H</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="c1">// header file content</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p>得到指定地址上的一个字节或字</p></li>
<li><p>得到一个 field 在结构体（struct）中的偏移量</p></li>
<li><p>得到一个结构体中 field 所占用的字节数</p></li>
<li><p>得到一个变量的地址（word宽度）</p></li>
<li><p>将一个字母转换为大写</p></li>
<li><p>判断字符是否是十进制的数字</p></li>
<li><p>判断字符是否是十六进制的数字</p></li>
<li><p>防止溢出的方法</p></li>
<li><p>返回数组元素的个数</p></li>
<li><p>使用一些宏跟踪调试</p></li>
</ol>
</div>
</div>
<div class="section" id="const-or-constexpr">
<h3>const or constexpr<a class="headerlink" href="#const-or-constexpr" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="effective-c">
<h2>Effective C++<a class="headerlink" href="#effective-c" title="永久链接至标题">¶</a></h2>
<blockquote>
<div><ol class="arabic">
<li><p>视 <em>C++</em> 为一个语言联邦（ <em>C</em> 、 <em>Object-Oriented C++</em> 、
<em>Template C++</em> 、<em>STL</em> ）</p></li>
<li><p>宁可以编译器替换预处理器（ 尽量以 <strong>const</strong> 、<strong>enum</strong> 、<strong>inline</strong>
替换 <strong>#define</strong> ）</p></li>
<li><p>尽可能使用 <strong>const</strong></p></li>
<li><p>确定对象被使用前已先被初始化 —— 构造时赋值（copy 构造函数）比 default
构造后赋值（copy assignment）效率高</p></li>
<li><p>了解 C++ 默默编写并调用哪些函数（编译器暗自为 class 创建 default
构造函数、copy 构造函数、copy assignment 操作符、析构函数）</p></li>
<li><p>若不想使用编译器自动生成的函数，就应该明确拒绝（将不想使用的成员函数
声明为 private，并且不予实现）</p></li>
<li><p>为多态基类声明 virtual 析构函数（如果 class 带有任何 virtual 函数，
它就应该拥有一个 virtual 析构函数</p></li>
<li><p>别让异常逃离析构函数（析构函数应该吞下不传播异常，或者结束程序，而不
是吐出异常；如果要处理异常应该在非析构的普通函数处理）</p></li>
<li><p>绝不在构造和析构过程中调用 virtual 函数（因为这类调用从不下降至
derived class）</p></li>
<li><p>令 <strong>operator=</strong> 返回一个 <em>reference to *this</em> （用于连锁赋值）</p></li>
<li><p>在 <strong>operator=</strong> 中处理 “自我赋值”</p></li>
<li><p>赋值对象时应确保复制 “对象内的所有成员变量” 及 “所有 base class 成
分”（调用基类复制构造函数）</p></li>
<li><p>以对象管理资源（资源在构造函数获得，在析构函数释放，建议使用智能指针，
资源取得时机便是初始化时机（Resource Acquisition Is Initialization，
RAII））</p></li>
<li><p>在资源管理类中小心 copying 行为（普遍的 RAII class copying 行为是：
抑制 copying、引用计数、深度拷贝、转移底部资源拥有权（类似 <strong>auto_ptr</strong> ））</p></li>
<li><p>在资源管理类中提供对原始资源（raw resources）的访问（对原始资源的访
问可能经过显式转换或隐式转换，一般而言显示转换比较安全，隐式转换对客
户比较方便）</p></li>
<li><p>成对使用 <strong>new</strong> 和 <strong>delete</strong> 时要采取相同形式（new 中使用 [] 则
delete []，new 中不使用 [] 则 delete）</p></li>
<li><p>以独立语句将 newed 对象存储于（置入）智能指针（如果不这样做，可能会
因为编译器优化，导致难以察觉的资源泄漏）</p></li>
<li><p>让接口容易被正确使用，不易被误用（促进正常使用的办法：接口的一致性、
内置类型的行为兼容；阻止误用的办法：建立新类型，限制类型上的操作，
约束对象值、消除客户的资源管理责任）</p></li>
<li><p>设计 class 犹如设计 type，需要考虑对象创建、销毁、初始化、赋值、值
传递、合法值、继承关系、转换、一般化等等。</p></li>
<li><p>宁以 pass-by-reference-to-const 替换 pass-by-value （前者通常更
高效、避免切割问题（slicing problem），但不适用于内置类型、STL迭代
器、函数对象）</p></li>
<li><p>必须返回对象时，别妄想返回其 reference（绝不返回 pointer 或 reference
指向一个 local stack 对象，或返回 reference 指向一个 heap-allocated
对象，或返回 pointer 或 reference 指向一个 local static 对象而有
可能同时需要多个这样的对象。）</p></li>
<li><p>将成员变量声明为 <em>private</em> （为了封装、一致性、对其读写精确控制等）</p></li>
<li><p>宁以 non-member、non-friend 替换 member 函数（可增加封装性、包裹
弹性（packaging flexibility）、机能扩充性）</p></li>
<li><p>若所有参数（包括被this指针所指的那个隐喻参数）皆须要类型转换，请为此
采用 non-member 函数</p></li>
<li><p>考虑写一个不抛异常的 swap 函数</p></li>
<li><p>尽可能延后变量定义式的出现时间（可增加程序清晰度并改善程序效率）</p></li>
<li><p>尽量少做转型动作</p>
<p>旧式： <strong>(T)expression</strong> 、<strong>T(expression)</strong> ；</p>
<p>新式： <strong>const_cast&lt;T&gt;(expression)</strong> 、 <strong>dynamic_cast&lt;T&gt;(expression)</strong> 、
<strong>reinterpret_cast&lt;T&gt;(expression)</strong> 、 <strong>static_cast&lt;T&gt;(expression)</strong> ；</p>
<p>尽量避免转型、注重效率避免 <strong>dynamic_casts</strong> 、尽量设计成无需转型、
可把转型封装成函数、宁可用新式转型</p>
</li>
<li><p>避免使用 handles（包括 引用、指针、迭代器）指向对象内部（以增加封装
性、使 const 成员函数的行为更像 const、降低 “虚吊号码牌”（dangling
handles，如悬空指针等）的可能性）</p></li>
<li><p>为 “异常安全” 而努力是值得的（异常安全函数（Exception-safe functions）
即使发生异常也不会泄露资源或允许任何数据结构败坏，分为三种可能的保证：
基本型、强列型、不抛异常型）</p></li>
<li><p>透彻了解 inlining 的里里外外（inlining 在大多数 C++ 程序中是编译期
的行为；inline 函数是否真正 inline，取决于编译器；大部分编译器拒绝
太过复杂（如带有循环或递归）的函数 inlining，而所有对 virtual 函数
的调用（除非是最平淡无奇的）也都会使 inlining 落空；inline 造成的
代码膨胀可能带来效率损失；inline 函数无法随着程序库的升级而升级）</p></li>
<li><p>将文件间的编译依存关系降至最低（如果使用 object references 或
object pointers 可以完成任务，就不要使用 objects；如果能够，尽量以
class 声明式替换 class 定义式；为声明式和定义式提供不同的头文件）</p></li>
<li><p>确定你的 public 继承塑模出 is-a（是一种）关系（适用于 base classes
身上的每一件事情一定适用于 derived classes 身上，因为每一个 derived
class 对象也都是一个 base class 对象）</p></li>
<li><p>避免遮掩继承而来的名字（可使用 using 声明式或转交函数（forwarding
functions）来让被遮掩的名字再见天日）</p></li>
<li><p>区分接口继承和实现继承（在 public 继承之下，derived classes 总是
继承 base class 的接口；pure virtual 函数只具体指定接口继承；非纯
impure virtual 函数具体指定接口继承及缺省实现继承；non-virtual 函
数具体指定接口继承以及强制性实现继承）</p></li>
<li><p>考虑 virtual 函数以外的其他选择（如 Template Method 设计模式的
non-virtual interface（NVI）手法，将 virtual 函数替换为 “函数指针
成员变量”，以 tr1::function 成员变量替换 virtual 函数，将继承体系
内的 virtual 函数替换为另一个继承体系内的 virtual 函数）</p></li>
<li><p>绝不重新定义继承而来的 non-virtual 函数</p></li>
<li><p>绝不重新定义继承而来的缺省参数值，因为缺省参数值是静态绑定（statically
bound），而 virtual 函数却是动态绑定（dynamically bound）</p></li>
<li><p>通过复合塑模 has-a（有一个）或 “根据某物实现出”（在应用域（application
domain），复合意味 has-a（有一个）；在实现域（implementation domain），
复合意味着 is-implemented-in-terms-of（根据某物实现出））</p></li>
<li><p>明智而审慎地使用 private 继承（private 继承意味着 is-implemented-in-terms-of
（根据某物实现出），尽可能使用复合，当 derived class 需要访问 protected
base class 的成员，或需要重新定义继承而来的时候 virtual 函数，或需
要 empty base 最优化时，才使用 private 继承）</p></li>
<li><p>明智而审慎地使用多重继承（多继承比单一继承复杂，可能导致新的歧义性，
以及对 virtual 继承的需要，但确有正当用途，如 “public 继承某个
interface class” 和 “private 继承某个协助实现的 class”；virtual
继承可解决多继承下菱形继承的二义性问题，但会增加大小、速度、初始化及
赋值的复杂度等等成本）</p></li>
<li><p>了解隐式接口和编译期多态（class 和 templates 都支持接口（interfaces）
和多态（polymorphism）；class 的接口是以签名为中心的显式的（explicit），
多态则是通过 virtual 函数发生于运行期；template 的接口是奠基于有效
表达式的隐式的（implicit），多态则是通过 template 具现化和函数重载
解析（function overloading resolution）发生于编译期）</p></li>
<li><p>了解 typename 的双重意义（声明 template 类型参数是，前缀关键字 class
和 typename 的意义完全相同；请使用关键字 typename 标识嵌套从属类型
名称，但不得在基类列（base class lists）或成员初值列（member
initialization list）内以它作为 base class 修饰符）</p></li>
<li><p>学习处理模板化基类内的名称（可在 derived class templates 内通过
this-&gt; 指涉 base class templates 内的成员名称，或藉由一个明白写出
的 “base class 资格修饰符” 完成）</p></li>
<li><p>将与参数无关的代码抽离 templates（因类型模板参数（non-type template
parameters）而造成代码膨胀往往可以通过函数参数或 class 成员变量替换
template 参数来消除；因类型参数（type parameters）而造成的代码膨胀
往往可以通过让带有完全相同二进制表述（binary representations）的实
现类型（instantiation types）共享实现码）</p></li>
<li><p>运用成员函数模板接受所有兼容类型（请使用成员函数模板（member function
templates）生成 “可接受所有兼容类型” 的函数；声明 member templates
用于 “泛化 copy 构造” 或 “泛化 assignment 操作” 时还需要声明正常的
copy 构造函数和 copy assignment 操作符）</p></li>
<li><p>需要类型转换时请为模板定义非成员函数（当我们编写一个 class template，
而它所提供之 “与此 template 相关的” 函数支持 “所有参数之隐式类型转换”
时，请将那些函数定义为 “class template 内部的 friend 函数”）</p></li>
<li><p>请使用 traits classes 表现类型信息（traits classes 通过 templates
和 “templates 特化” 使得 “类型相关信息” 在编译期可用，通过重载技术
（overloading）实现在编译期对类型执行 if…else 测试）</p></li>
<li><p>认识 template 元编程（模板元编程（TMP，template metaprogramming）
可将工作由运行期移往编译期，因此得以实现早期错误侦测和更高的执行效率；
TMP 可被用来生成 “给予政策选择组合”（based on combinations of policy
choices）的客户定制代码，也可用来避免生成对某些特殊类型并不适合的代
码）</p></li>
<li><p>了解 new-handler 的行为（set_new_handler 允许客户指定一个在内存分
配无法获得满足时被调用的函数；nothrow new 是一个颇具局限的工具，因
为它只适用于内存分配（operator new），后继的构造函数调用还是可能抛
出异常）</p></li>
<li><p>了解 new 和 delete 的合理替换时机（为了检测运用错误、收集动态分配内
存之使用统计信息、增加分配和归还速度、降低缺省内存管理器带来的空间额
外开销、弥补缺省分配器中的非最佳齐位、将相关对象成簇集中、获得非传统
的行为）</p></li>
<li><p>编写 new 和 delete 时需固守常规（operator new 应该内涵一个无穷循环，
并在其中尝试分配内存，如果它无法满足内存需求，就应该调用 new-handler，
它也应该有能力处理 0 bytes 申请，class 专属版本则还应该处理 “比正
确大小更大的（错误）申请”；operator delete 应该在收到 null 指针时
不做任何事，class 专属版本则还应该处理 “比正确大小更大的（错误）申
请”）</p></li>
<li><p>写了 placement new 也要写 placement delete（当你写一个 placement
operator new，请确定也写出了对应的 placement operator delete，否
则可能会发生隐微而时断时续的内存泄漏；当你声明 placement new 和
placement delete，请确定不要无意识（非故意）地遮掩了它们地正常版本）</p></li>
<li><p>不要轻忽编译器的警告</p></li>
<li><p>让自己熟悉包括 TR1 在内的标准程序库（TR1，C++ Technical Report 1，
C++11 标准的草稿文件）</p></li>
<li><p>让自己熟悉 Boost（准标准库）</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="more-effective-c">
<h2>More Effective c++<a class="headerlink" href="#more-effective-c" title="永久链接至标题">¶</a></h2>
<blockquote>
<div><ol class="arabic simple">
<li><p>仔细区别 <em>pointers</em> 和 <em>references</em> （当你知道你需要指向某个东西，
而且绝不会改变指向其他东西，或是当你实现一个操作符而其语法需求无法由
pointers 达成，你就应该选择 references；任何其他时候，请采用
pointers）</p></li>
<li><p>最好使用 C++ 转型操作符（ <strong>static_cast</strong> 、 <strong>const_cast</strong> 、
<strong>dynamic_cast</strong> 、 <strong>reinterpret_cast</strong> ）</p></li>
<li><p>绝不要以多态（polymorphically）方式处理数组（多态（polymorphism）
和指针算术不能混用；数组对象几乎总是会涉及指针的算术运算，所以数组和
多态不要混用）</p></li>
<li><p>非必要不提供 default constructor（避免对象中的字段被无意义地初始化）</p></li>
<li><p>对定制的 “类型转换函数” 保持警觉（单自变量 constructors 可通过简易
法（explicit 关键字）或代理类（proxy classes）来避免编译器误用；
隐式类型转换操作符可改为显式的 member function 来避免非预期行为）</p></li>
<li><p>区别 increment/decrement 操作符的前置（prefix）和后置（postfix）
形式（前置式累加后取出，返回一个 reference；后置式取出后累加，返回
一个 const 对象；处理用户定制类型时，应该尽可能使用前置式 increment；
后置式的实现应以其前置式兄弟为基础）</p></li>
<li><p>千万不要重载 &amp;&amp;，|| 和 , 操作符（&amp;&amp; 与 || 的重载会用 “函数调用语义”
取代 “骤死式语义”；, 的重载导致不能保证左侧表达式一定比右侧表达式更
早被评估）</p></li>
<li><p>了解各种不同意义的 new 和 delete（new operator、operator new、
placement new、operator new[]；delete operator、operator delete、
destructor、operator delete[]）</p></li>
<li><p>利用 destructors 避免泄漏资源（在 destructors 释放资源可以避免异常
时的资源泄漏）</p></li>
<li><p>在 constructors 内阻止资源泄漏（由于 C++ 只会析构已构造完成的对象，
因此在构造函数可以使用 try…catch 或者 auto_ptr（以及与之相似的
classes） 处理异常时资源泄露问题）</p></li>
<li><p>禁止异常流出 destructors 之外（原因：一、避免 terminate 函数在
exception 传播过程的栈展开（stack-unwinding）机制种被调用；二、协
助确保 destructors 完成其应该完成的所有事情）</p></li>
<li><p>了解 “抛出一个 exception” 与 “传递一个参数” 或 “调用一个虚函数” 之
间的差异（第一，exception objects 总是会被复制（by pointer 除外），
如果以 by value 方式捕捉甚至被复制两次，而传递给函数参数的对象则不
一定得复制；第二，“被抛出成为 exceptions” 的对象，其被允许的类型转
换动作比 “被传递到函数去” 的对象少；第三，catch 子句以其 “出现于源
代码的顺序” 被编译器检验对比，其中第一个匹配成功者便执行，而调用一个
虚函数，被选中执行的是那个 “与对象类型最佳吻合” 的函数）</p></li>
<li><p>以 by reference 方式捕获 exceptions（可避免对象删除问题、exception
objects 的切割问题，可保留捕捉标准 exceptions 的能力，可约束 exception
object 需要复制的次数）</p></li>
<li><p>明智运用 exception specifications（exception specifications 对
“函数希望抛出什么样的 exceptions” 提供了卓越的说明；也有一些缺点，
包括编译器只对它们做局部性检验而很容易不经意地违反，与可能会妨碍更上
层的 exception 处理函数处理未预期的 exceptions）</p></li>
<li><p>了解异常处理的成本（粗略估计，如果使用 try 语句块，代码大约整体膨胀
5%-10%，执行速度亦大约下降这个数；因此请将你对 try 语句块和 exception
specifications 的使用限制于非用不可的地点，并且在真正异常的情况下才
抛出 exceptions）</p></li>
<li><p>谨记 80-20 法则（软件的整体性能几乎总是由其构成要素（代码）的一小部
分决定的，可使用程序分析器（program profiler）识别出消耗资源的代码）</p></li>
<li><p>考虑使用 lazy evaluation（缓式评估）（可应用于：Reference Counting
（引用计数）来避免非必要的对象复制、区分 operator[] 的读和写动作来
做不同的事情、Lazy Fetching（缓式取出）来避免非必要的数据库读取动作、
Lazy Expression Evaluation（表达式缓评估）来避免非必要的数值计算
动作）</p></li>
<li><p>分期摊还预期的计算成本（当你必须支持某些运算而其结构几乎总是被需要，
或其结果常常被多次需要的时候，over-eager evaluation（超急评估）可
以改善程序效率）</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="the-cherno">
<h2>The Cherno<a class="headerlink" href="#the-cherno" title="永久链接至标题">¶</a></h2>
<div class="section" id="windows-c">
<h3>1. 在 Windows 系统中设置 C++ 开发环境<a class="headerlink" href="#windows-c" title="永久链接至标题">¶</a></h3>
<div class="figure align-center" id="id267">
<div class="graphviz"><object data="../_images/graphviz-eabfe9491e9a1ffaf4d39bce0dcb8c07a5d5aba0.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph example0{
    bgcolor = &quot;transparent&quot;
    rankdir = LR;

    a-&gt;b;
    c-&gt;a [dir = &quot;back&quot;];
}</p></object></div>
<p class="caption"><span class="caption-text">pipline</span><a class="headerlink" href="#id267" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id268">
<div class="graphviz"><object data="../_images/graphviz-dd46de21ed501d227716f608d099c73a5273179b.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    bgcolor = &quot;transparent&quot;
    rankdir = LR;
    node [shape=&quot;record&quot;];
    edge [style=&quot;dashed&quot;];
    a [label = &quot;\&lt;memory\&gt;&quot;];
    b [label = &quot;\&lt;stl_construct.h\&gt;&quot;];
    c [label = &quot;\&lt;stl_aloc.h\&gt;&quot;];
    d [label = &quot;\&lt;stl_uninitialized.h\&gt;&quot;];

    a:e-&gt;b:w;
    a:e-&gt;c:w;
    a:e-&gt;d:w;
}</p></object></div>
<p class="caption"><span class="caption-text">pipline2</span><a class="headerlink" href="#id268" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="id160">
<h3>2. C++ 是如何工作的<a class="headerlink" href="#id160" title="永久链接至标题">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id269">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id269" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello World!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">7</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>第1行代码中以 <code class="docutils literal notranslate"><span class="pre">#</span></code> 开头的是 <cite>预处理语句</cite> ,预处理语句将会在编译之前进行评估（be evaluated）。
这里的 <code class="docutils literal notranslate"><span class="pre">include</span></code> 表示将 <code class="docutils literal notranslate"><span class="pre">iostream</span></code> 这个 <cite>头文件</cite> 中的内容拷贝到当前源
代码文件中。</p>
<p>第3行是 <cite>mian</cite> 函数，通常 <cite>main</cite> 函数是程序的入口（entry point）, <code class="docutils literal notranslate"><span class="pre">int</span></code>
表示该函数返回的类型是整型。 <cite>main</cite> 函数中如果没有显示使用 <cite>return someIntValue;</cite>
编译器会假设为 <cite>return 0;</cite> ，只有 <cite>main</cite> 函数是这样的个例。</p>
<p>每一个 <cite>.cpp</cite> 源文件都会被编译，头文件不会被编译，只能使用 <code class="docutils literal notranslate"><span class="pre">include</span></code> 预处
理指令被包含到 <cite>.cpp</cite> 文件中进行编译。经过预处理后对每个 <cite>.cpp</cite> 文件进行 <strong>单独</strong>
地编译，每个 <cite>.cpp</cite> 文件编译后输出一个对应的 <cite>.obj</cite> 文件。最后通过链接器将
这些 <cite>.obj</cite> 文件链接成一个 <cite>.exe</cite> 可执行文件。</p>
<div class="figure align-center" id="id270">
<div class="graphviz"><object data="../_images/graphviz-b38c477298dc636730393668841d575da9f07a50.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph example {
    bgcolor = &quot;transparent&quot;
    rankdir = LR;

    a1 [label=&quot;a1.cpp&quot;];
    a2 [label=&quot;a2.cpp&quot;];
    an [label=&quot;an.cpp&quot;];
    b1 [label=&quot;b1.obj&quot;];
    b2 [label=&quot;b2.obj&quot;];
    bn [label=&quot;bn.obj&quot;];
    c [label=&quot;output.exe&quot;];
    a1 -&gt; b1;
    a2 -&gt; b2;
    an -&gt; bn;
    b1 -&gt; c;
    b2 -&gt; c;
    bn -&gt; c;
}</p></object></div>
<p class="caption"><span class="caption-text">pipline</span><a class="headerlink" href="#id270" title="永久链接至图片">¶</a></p>
</div>
<p>Visual Studio 中 <code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">F7</span></code> 进行编译（compile）。</p>
<p>下面看一下存在多个 <cite>.cpp</cite> 源文件时 C++ 是如何工作的：</p>
<div class="literal-block-wrapper docutils container" id="id271">
<div class="code-block-caption"><span class="caption-text">Log.cpp</span><a class="headerlink" href="#id271" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id272">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id272" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="linenos">7</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>在上面的代码中，如果移除 <cite>Main.cpp</cite> 中的第3行，build 整个解决方案将会出现以
下错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span> <span class="n">C3861</span><span class="p">:</span> <span class="s1">&#39;Log&#39;</span><span class="p">:</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>此时如果我们加上第3行代码，就算没有 <cite>Log.cpp</cite> 文件，单独编译 <cite>Main.cpp</cite> 文
件也不会报错。这是因为这个第3行代码是一个 <cite>声明</cite> （表示某个 symbol 或 function 是
存在的），告诉编译器存在一个这样签名的 <cite>Log</cite> 函数（像是一个承诺，而编译器总
是选择相信我们）。</p>
<p>当我们再次 build 整个解决方案时，编译阶段没有错误，然后链接器开始工作，主要
就是 resolve symbol。如果在 <cite>Log.cpp</cite> 中没有 <cite>Log</cite> 函数的定义，将会出现以
下链接错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Main.obj : error LNK2019: unresolved external symbol &quot;void __cdecl Log(char const *)&quot; (?Log@@YAXPBD@Z) referenced in function _main
1&gt;C:\dev\CppTemp\Debug\Main.exe : fatal error LNK1120: 1 unresolved externals
</pre></div>
</div>
</div>
<div class="section" id="id161">
<h3>3. C++ 编译器是如何工作的<a class="headerlink" href="#id161" title="永久链接至标题">¶</a></h3>
<p>阶段：</p>
<blockquote>
<div><ol class="arabic">
<li><p>预处理</p>
<blockquote>
<div><p>evaluate 每条预处理指令；</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>预处理指令</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>#include &lt;iostream&gt;</p></td>
<td><p>拷贝头文件中的内容到使用该指令的地方</p>
<p>Visual Studio 中在</p>
<p>Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Preprocessor:</p>
<p>Preprocess to a File: No/Yes</p>
<p>修改该选项为 Yes 可输出预处理后的文件</p>
</td>
</tr>
<tr class="row-odd"><td><p>#define INTEGER int</p></td>
<td><p>将后续代码中出现的 INTEGER 替换为 int</p></td>
</tr>
<tr class="row-even"><td><p>#if #elif #else #endif</p></td>
<td><p>根据条件确定是否使用代码</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p>语法分析</p></li>
<li><p>转换成机器语言指令</p></li>
</ol>
</div></blockquote>
<p>编译后的 <cite>.obj</cite> 文件是二进制的机器码，没有可读性，为了可以简单查看编译后的内容，
可以在 Visual Studio 中的 Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Output Files:
Assemler Output: Assembly-Only Listing (/FA) 这样设置。</p>
</div>
<div class="section" id="id162">
<h3>4. C++ 链接器是如何工作的<a class="headerlink" href="#id162" title="永久链接至标题">¶</a></h3>
<p>必须要有一个 entry point ，否则会产生一个链接错误。</p>
<p>可以在 Visual Studio 中的 Properties -&gt; Configuration Properties -&gt; Linker -&gt; Advanced:
Entry Point: 这里修改程序的入口。</p>
<p><strong>LINK-ERROR: 未解决的符号</strong></p>
<ul>
<li><p>代码一：</p>
<div class="literal-block-wrapper docutils container" id="id273">
<div class="code-block-caption"><span class="caption-text">Log.cpp</span><a class="headerlink" href="#id273" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id274">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id274" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">Multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Multiply&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Multiply</span>
<span class="mi">40</span>
</pre></div>
</div>
</li>
<li><p>代码二：</p>
<div class="literal-block-wrapper docutils container" id="id275">
<div class="code-block-caption"><span class="caption-text">Log.cpp</span><a class="headerlink" href="#id275" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Logr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id276">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id276" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">Multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Multiply&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>build 时将会出现以下错误信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Main.obj : error LNK2019: unresolved external symbol &quot;void __cdecl Log(char const *)&quot; (?Log@@YAXPBD@Z) referenced in function &quot;int __cdecl Multiply(int,int)&quot; (?Multiply@@YAHHH@Z)
1&gt;C:\dev\C++\C++Temp\Debug\C++Temp.exe : fatal error LNK1120: 1 unresolved externals
</pre></div>
</div>
<p>错误产生是由于链接时链接器找不到与 <cite>Main.cpp</cite> 中 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数声明那样匹配的定义。</p>
<p>此时如果注释掉 <cite>Main.cpp</cite> 中的：</p>
<div class="literal-block-wrapper docutils container" id="id277">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id277" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">7</span><span class="c1">//Log(&quot;Multiply&quot;);</span>
</pre></div>
</div>
</div>
<p>这时再 build 将会通过，这是因为代码中没有调用 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数，因此也就不会进行链接，
也就避免了链接错误的产生。</p>
</li>
<li><p>代码三：</p>
<div class="literal-block-wrapper docutils container" id="id278">
<div class="code-block-caption"><span class="caption-text">Log.cpp</span><a class="headerlink" href="#id278" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Logr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id279">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id279" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">Multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Multiply&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="c1">//std::cout &lt;&lt; Multiply(5, 8) &lt;&lt; std::endl;</span>
</span><span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>build 时会出现以下错误信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Main.obj : error LNK2019: unresolved external symbol &quot;void __cdecl Log(char const *)&quot; (?Log@@YAXPBD@Z) referenced in function &quot;int __cdecl Multiply(int,int)&quot; (?Multiply@@YAHHH@Z)
1&gt;C:\dev\C++\C++Temp\Debug\C++Temp.exe : fatal error LNK1120: 1 unresolved externals
</pre></div>
</div>
<p>这是由于链接器链接时找不到与 <cite>Main.cpp</cite> 中 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数声明那样匹配的定义。在 <cite>Main.cpp</cite>
中虽然没有直接（ Log(“something”) ）或间接（Multiply(someInt,someInt)）调用
该 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数的地方，但是不能保证不会有其他的文件会调用 <cite>Main.cpp</cite> 中的 <code class="docutils literal notranslate"><span class="pre">Multiply</span></code> 函数，
因此链接器会对其进行链接操作，进而生产这个链接错误。</p>
<p>然而，如果我们告诉链接器 <cite>Main.cpp</cite> 中的这个 <code class="docutils literal notranslate"><span class="pre">Multiply</span></code> 不会被其他文件调用，
又由于在 <code class="docutils literal notranslate"><span class="pre">Main.cpp</span></code> 没有直接或间接对 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数的使用，因此链接时不会对
其进行链接操作，也就不会导致这个链接错误的产生：</p>
<div class="literal-block-wrapper docutils container" id="id280">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id280" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">5</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
</ul>
<p><strong>LINK-ERROR: 已存在的符号</strong></p>
<ul>
<li><p>代码一：</p>
<div class="literal-block-wrapper docutils container" id="id281">
<div class="code-block-caption"><span class="caption-text">Log.h</span><a class="headerlink" href="#id281" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#pragma once</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id282">
<div class="code-block-caption"><span class="caption-text">Log.cpp</span><a class="headerlink" href="#id282" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos">2</span><span class="cp">#include</span><span class="cpf">&quot;Log.h&quot;</span><span class="cp"></span>
</span><span class="linenos">3</span>
<span class="linenos">4</span><span class="kt">void</span><span class="w"> </span><span class="nf">InitLog</span><span class="p">()</span><span class="w"></span>
<span class="linenos">5</span><span class="p">{</span><span class="w"></span>
<span class="linenos">6</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Init&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id283">
<div class="code-block-caption"><span class="caption-text">Main.cpp</span><a class="headerlink" href="#id283" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&quot;Log.h&quot;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">Multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Multiply&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>build 时会出现以下错误信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Log.obj : error LNK2005: &quot;void __cdecl Log(char const *)&quot; (?Log@@YAXPBD@Z) already defined in Main.obj
1&gt;C:\dev\C++\C++Temp\Debug\C++Temp.exe : fatal error LNK1169: one or more multiply defined symbols found
</pre></div>
</div>
<p>这是由于在 <cite>Log.cpp</cite> 和 <cite>Main.cpp</cite> 文件中都使用了 <cite>#include”Log.h”</cite> 这条预处
理指令，这会将 <cite>Log.h</cite> 中的内容复制到 <cite>Log.cpp</cite> 和 <cite>Main.cpp</cite> 中，即会存在两份
<code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数的定义，因此会在链接时产生符号已存在的错误。</p>
<p>有以下3种解决方式：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><cite>Log.h</cite> 中的 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数加上 <code class="docutils literal notranslate"><span class="pre">static</span></code> 关键字，表示仅在 include 的 .cpp 文件中自己可见</p></li>
<li><p><cite>Log.h</cite> 中的 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数加上 <code class="docutils literal notranslate"><span class="pre">inline</span></code> 关键字，表示在调用的地方展开（类似宏展开）</p></li>
<li><p><cite>Log.h</cite> 中的 <code class="docutils literal notranslate"><span class="pre">Log</span></code> 函数移到 <cite>Log.cpp</cite> 中</p></li>
</ol>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id163">
<h3>5. C++ 中的变量<a class="headerlink" href="#id163" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">sizeof</span></code></p>
</div>
<div class="section" id="id164">
<h3>6. C++ 中的函数<a class="headerlink" href="#id164" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id165">
<h3>7. C++ 中的头文件<a class="headerlink" href="#id165" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">once</span></code> 告诉预处理器仅包含一次头文件。</p>
<p><code class="docutils literal notranslate"><span class="pre">include</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">&lt;xxx.h&gt;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">xxx.h&quot;</span></code>:
如果 <cite>xxx.h</cite> 文件是在当前解决方案的 <cite>include directories</cite> 中的，则使用 <code class="docutils literal notranslate"><span class="pre">&lt;xx.h&gt;</span></code> （当然也可以使用 <code class="docutils literal notranslate"><span class="pre">xxx.h</span></code> ）;
如果 <cite>xxx.h</cite> 和当前的文件存在相对路径，则使用 <code class="docutils literal notranslate"><span class="pre">&quot;xxx.h&quot;</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">../xxx.h</span></code> 。</p>
</div>
<div class="section" id="visual-studio-c">
<h3>8. 如何在 Visual Studio 中调试 C++ 程序<a class="headerlink" href="#visual-studio-c" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-if">
<h3>9. C++ 中的条件和分支（ if语句 ）<a class="headerlink" href="#c-if" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-visual-studio">
<h3>10. 关于 C++ 程序最好的 Visual  Studio 设置<a class="headerlink" href="#c-visual-studio" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-for-while">
<h3>11. C++ 中的循环（for, while）<a class="headerlink" href="#c-for-while" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-continue-break-return">
<h3>12. C++ 中的流程控制（continue, break, return）<a class="headerlink" href="#c-continue-break-return" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id166">
<h3>13. C++ 中的指针<a class="headerlink" href="#id166" title="永久链接至标题">¶</a></h3>
<p>指针是一个数整数，一个存储内存地址的数字。
在一个已存在的变量名前加 <cite>&amp;</cite> 以获取变量的地址；在一个指针前面加 <cite>*</cite> 可以对指针解
引用以获取指针指向的变量中的值。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">var</span><span class="p">;</span><span class="w"></span>
<span class="linenos">7</span><span class="w">    </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面代码中创建的变量是在栈里的，下面的代码则是在堆上创建了一个数组：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w"></span>
<span class="linenos">6</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>除此之外，还可以有指向指针的指针：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id167">
<h3>14. C++ 中的引用<a class="headerlink" href="#id167" title="永久链接至标题">¶</a></h3>
<p>引用不像指针那样可以设置一个为零的值，引用并不占据内存，必须进行初始化。引用只是
为已有的变量创建一个别名，本质上只有一个变量。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// a = 2</span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>引用是关于指针的一个语法糖，看一个在函数中修改变量值的例子：</p>
<blockquote>
<div><ul>
<li><p>使用指针：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="kt">void</span><span class="w">  </span><span class="nf">Increment</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">Increment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// a = 6</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>使用引用：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="kt">void</span><span class="w">  </span><span class="nf">Increment</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">value</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">Increment</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// a = 6</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id168">
<h3>15. C++ 中的类<a class="headerlink" href="#id168" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Player</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Move</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ya</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">xa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ya</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span><span class="p">};</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Player</span><span class="w"> </span><span class="n">player</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="n">Move</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id169">
<h3>16. C++ 中类和结构体的比较<a class="headerlink" href="#id169" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>类中的成员变量的可见性默认是 <cite>private</cite> 而结构体中成员变量的可见性默认是 <cite>public</cite>；</p></li>
<li><p>尽量不要在结构体中使用继承。</p></li>
</ul>
</div>
<div class="section" id="id170">
<h3>17. 如何写一个 C++ 的类<a class="headerlink" href="#id170" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Log</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ErrorLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">WarningLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">InfoLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetLevel</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ErrorLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">22</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[ERROR]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Warning</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">WarningLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">27</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[WARNING]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">InfoLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">32</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[INFO]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">34</span><span class="p">};</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">37</span><span class="p">{</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="n">Log</span><span class="w"> </span><span class="n">log</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="n">ErrorLevel</span><span class="p">);</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">44</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-static">
<h3>18. C++ 中的 Static<a class="headerlink" href="#c-static" title="永久链接至标题">¶</a></h3>
<p>C++ 中的 <cite>static</cite> 主要有两种不同的使用场景：</p>
<blockquote>
<div><ul class="simple">
<li><p>在类或结构体内部使用 <cite>static</cite> ;</p></li>
<li><p>在类或结构体外部使用 <cite>static</cite> ;</p></li>
</ul>
</div></blockquote>
<p>下面展示一些类或结构体外部使用 <cite>static</cite> 的代码片段：</p>
<ul>
<li><p>场景一</p>
<div class="literal-block-wrapper docutils container" id="id284">
<div class="code-block-caption"><span class="caption-text">Static.cpp</span><a class="headerlink" href="#id284" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id285">
<div class="code-block-caption"><span class="caption-text">Sandbox.cpp</span><a class="headerlink" href="#id285" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="linenos">7</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>将会出现编译错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Static.obj : error LNK2005: &quot;int s_Variable&quot; (?s_Variable@@3HA) already defined in Sandbox.obj
1&gt;C:\dev\CppTemp\Debug\Sandbox.exe : fatal error LNK1169: one or more multiply defined symbols found
</pre></div>
</div>
<p>由于这里（一个编译单元 – translation unit）有两个同名的全局变量 <cite>s_Variable</cite> 。</p>
</li>
<li><p>场景二：</p>
<div class="literal-block-wrapper docutils container" id="id286">
<div class="code-block-caption"><span class="caption-text">Static.cpp</span><a class="headerlink" href="#id286" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id287">
<div class="code-block-caption"><span class="caption-text">Sandbox.cpp</span><a class="headerlink" href="#id287" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="linenos">7</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be 10</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>在 <cite>static.cpp</cite> 中定义的 <code class="docutils literal notranslate"><span class="pre">s_Variable</span></code> 由于有 <code class="docutils literal notranslate"><span class="pre">static</span></code> 修饰，其作用
类似于使其修饰的变量仅在当前 <cite>.cpp</cite> 文件中可见，因此没有出现场景一中链接错
误。若在头文件中像这样定义 <code class="docutils literal notranslate"><span class="pre">static</span></code> 修饰的变量，在每一个使用该头文件的 <cite>.cpp</cite>
文件中都会各自定义一个 <code class="docutils literal notranslate"><span class="pre">static</span></code> 变量，这是因为引用头文件本质是将其代码进
行复制。</p>
</li>
<li><p>场景三：</p>
<div class="literal-block-wrapper docutils container" id="id288">
<div class="code-block-caption"><span class="caption-text">Static.cpp</span><a class="headerlink" href="#id288" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id289">
<div class="code-block-caption"><span class="caption-text">Sandbox.cpp</span><a class="headerlink" href="#id289" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s_Variable</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="linenos">7</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Variable</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be 5</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>在 <cite>static.cpp</cite> 中定义的 <code class="docutils literal notranslate"><span class="pre">s_Variable</span></code> 没有 <code class="docutils literal notranslate"><span class="pre">static</span></code> 修饰，因此该定义
对于 <cite>Sandbox.cpp</cite> 是可见的。</p>
</li>
</ul>
</div>
<div class="section" id="id171">
<h3>19. C++ 类和结构体中的 static<a class="headerlink" href="#id171" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">Entity</span><span class="w">  </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">  </span><span class="c1">// output will be &quot;2 , 3&quot;</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"> </span><span class="c1">// output will be &quot;5 , 8&quot;</span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>将成员变量 <code class="docutils literal notranslate"><span class="pre">x</span></code> 和 <code class="docutils literal notranslate"><span class="pre">y</span></code> 加上 <code class="docutils literal notranslate"><span class="pre">static</span></code> 修饰：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="n">Entity</span><span class="w">  </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>由于此时 <code class="docutils literal notranslate"><span class="pre">x</span></code> 和 <code class="docutils literal notranslate"><span class="pre">y</span></code> 不是实例中的成员，因此编译时将出现以下错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="o">&gt;</span><span class="n">C</span><span class="p">:</span>\<span class="n">dev</span>\<span class="n">CppTemp</span>\<span class="n">Debug</span>\<span class="n">Sandbox</span><span class="o">.</span><span class="n">exe</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">25</span><span class="p">):</span> <span class="n">error</span> <span class="n">C2078</span><span class="p">:</span> <span class="n">too</span> <span class="n">many</span> <span class="n">initializers</span>
</pre></div>
</div>
<p>继续调整如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">24</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">25</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>编译时出现以下错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1&gt;Sandbox.obj : error LNK2001: unresolved external symbol &quot;public: static int Entity::x&quot; (?x@Entity@@2HA)
1&gt;Sandbox.obj : error LNK2001: unresolved external symbol &quot;public: static int Entity::y&quot; (?y@Entity@@2HA)
1&gt;C:\dev\CppTemp\Debug\Sandbox.exe : fatal error LNK1120: 2 unresolved externals
</pre></div>
</div>
<p>继续调整如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="hll"><span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="n">Entity</span><span class="o">::</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="n">Entity</span><span class="o">::</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;5, 8&quot;</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">    </span><span class="c1">// output will be &quot;5, 8&quot;</span>
</span><span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上述代码等效于：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="n">Entity</span><span class="o">::</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="n">Entity</span><span class="o">::</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">Entity</span><span class="o">::</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="n">Entity</span><span class="o">::</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">Entity</span><span class="o">::</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">Entity</span><span class="o">::</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;5, 8&quot;</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">    </span><span class="c1">// output will be &quot;5, 8&quot;</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-local-static">
<h3>20. C++ 中的 Local Static<a class="headerlink" href="#c-local-static" title="永久链接至标题">¶</a></h3>
<p>函数第一次被调用时，函数中的 static 变量将被创建一次，后续被调用时将不会再创建。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;1&quot;</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;2&quot;</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;3&quot;</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;4&quot;</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;5&quot;</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面的代码等效于下面的代码，只是限制了变量 <code class="docutils literal notranslate"><span class="pre">i</span></code> 只能在函数 <code class="docutils literal notranslate"><span class="pre">Function()</span></code> 中访问：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;1&quot;</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;2&quot;</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;3&quot;</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;4&quot;</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w">     </span><span class="c1">// output will be &quot;5&quot;</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>通常的单例模式代码：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Singleton</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="o">*</span><span class="w"> </span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Get</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">13</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SomeFunc</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span><span class="p">};</span><span class="w"></span>
<span class="linenos">17</span>
<span class="hll"><span class="linenos">18</span><span class="n">Singleton</span><span class="o">*</span><span class="w"> </span><span class="n">Singleton</span><span class="o">::</span><span class="n">s_Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">Singleton</span><span class="o">::</span><span class="n">Get</span><span class="p">().</span><span class="n">SomeFunc</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>使用本节中的 <cite>Local Static</cite> 后代码更简洁：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Singleton</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Get</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SomeFunc</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span><span class="p">};</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Singleton</span><span class="o">::</span><span class="n">Get</span><span class="p">().</span><span class="n">SomeFunc</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">20</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id172">
<h3>21. C++  中的枚举<a class="headerlink" href="#id172" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Log</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">enum</span> <span class="nc">Level</span><span class="w"> </span><span class="c1">//  [ : [ unsigned ] char | int ]</span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="n">LevelError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">        </span><span class="n">LevelWarning</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">        </span><span class="n">LevelInfo</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">12</span>
<span class="linenos">13</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Level</span><span class="w"> </span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LevelInfo</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetLevel</span><span class="p">(</span><span class="n">Level</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">        </span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LevelError</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">25</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[ERROR]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Warning</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">29</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LevelWarning</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">30</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[WARNING]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Info</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">34</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_LogLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LevelInfo</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">35</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[INFO]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">37</span><span class="p">};</span><span class="w"></span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">40</span><span class="p">{</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">Log</span><span class="w"> </span><span class="n">log</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">42</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">Log</span><span class="o">::</span><span class="n">LevelError</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">43</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">47</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面的代码中 <cite>enum Level</cite> 并不是一个名称空间，因此这样访问 <code class="docutils literal notranslate"><span class="pre">Log::LevelError</span></code>
而不是这样访问 <code class="docutils literal notranslate"><span class="pre">Level::LevelError</span></code> ;另外由于此处枚举的本质是整数，因
此可以使用比较运算符 <cite>m_LogLevel &gt;= LevelError</cite> 。</p>
</div>
<div class="section" id="id173">
<h3>22. C++ 中的构造函数<a class="headerlink" href="#id173" title="永久链接至标题">¶</a></h3>
<p>构造函数是一个特殊的方法，在实例化对象的时候被调用。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面的代码会得到类似以下的输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mf">1.07374e+08</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.07374e+08</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面的代码将会出现编译错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span> <span class="n">C4700</span><span class="p">:</span> <span class="n">uninitialized</span> <span class="n">local</span> <span class="n">variable</span> <span class="s1">&#39;entity&#39;</span> <span class="n">used</span>
</pre></div>
</div>
<p>这是由于 C++ 类中基础类型的成员变量默认将不会被初始化为“零”，必须手动对其进
行初始化，可以像下面代码中那样写一个构造函数来初始化：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// 将会正确输出</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"> </span><span class="c1">// 将会正确输出</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">26</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>如果在 C++ 类中没有显示地通过代码创建构造函数，编译器将会实现一个默认的 <cite>public</cite>
的“空”构造函数：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">2</span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>如果不希望编译器创建默认的构造函数，可以添加下面的代码：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">Entity</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>另外，可以创建需要传递参数的构造函数：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span>
<span class="hll"><span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">17</span><span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span><span class="p">};</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">27</span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity2</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">30</span><span class="w">    </span><span class="n">entity1</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">    </span><span class="c1">// 0 , 0</span>
<span class="hll"><span class="linenos">31</span><span class="w">    </span><span class="n">entity2</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w">    </span><span class="c1">// 10 , 5</span>
</span><span class="linenos">32</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">33</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id174">
<h3>23. C++ 中的析构函数<a class="headerlink" href="#id174" title="永久链接至标题">¶</a></h3>
<p>当对象被销毁的时候析构函数将会被调用，通常在析构函数中释放在构造函数中分配在
堆中的内存；当然也可以手动调用析构函数，但是很少这样做，注意析构函数会被多次调用。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Created Entity!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">17</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Destroyed Entity!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; , &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span><span class="p">};</span><span class="w"></span>
<span class="linenos">25</span>
<span class="hll"><span class="linenos">26</span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">33</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">34</span><span class="w">    </span><span class="n">Function</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">35</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">36</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Created Entity!
0 , 0
Destroyed Entity!
</pre></div>
</div>
</div>
<div class="section" id="id175">
<h3>24. C++ 中的继承<a class="headerlink" href="#id175" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Move</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ya</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">xa</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ya</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="p">};</span><span class="w"></span>
<span class="linenos">14</span>
<span class="hll"><span class="linenos">15</span><span class="k">class</span> <span class="nc">Player</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
</span><span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">Player</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">()</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="p">};</span><span class="w"></span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">32</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Entity</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;8&quot;</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Player</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;12&quot;</span>
</span><span class="linenos">35</span>
<span class="hll"><span class="linenos">36</span><span class="w">    </span><span class="n">Player</span><span class="w"> </span><span class="n">player</span><span class="p">(</span><span class="s">&quot;playerA&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">37</span><span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="n">Move</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="n">PrintName</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">42</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id176">
<h3>25. C++ 中的虚函数<a class="headerlink" href="#id176" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Entity&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">class</span> <span class="nc">Player</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Player</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="p">};</span><span class="w"></span>
<span class="linenos">27</span>
<span class="hll"><span class="linenos">28</span><span class="kt">void</span><span class="w"> </span><span class="nf">PrintName</span><span class="p">(</span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">();</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">37</span>
<span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Entity&quot;</span>
</span><span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">player</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Entity&quot;</span>
</span><span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">player</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>使用虚函数后（包含 V-Table），有两个额外花销，保存 V-Table 的空间和调用时查表:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Entity&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">class</span> <span class="nc">Player</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Player</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="c1">// C++ 11 中 override 可选，为了可读性，建议加上</span>
</span><span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="p">};</span><span class="w"></span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">void</span><span class="w"> </span><span class="nf">PrintName</span><span class="p">(</span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">29</span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">();</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">37</span>
<span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Entity&quot;</span>
</span><span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">player</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Cherno&quot;</span>
</span><span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">player</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id177">
<h3>26. C++ 中的接口（纯虚函数）<a class="headerlink" href="#id177" title="永久链接至标题">¶</a></h3>
<p>C++ 中的包含纯虚函数的类就是“抽象类”，若所有方法都是纯虚函数，则是“接口”，包含未
实现纯的虚函数的类不能进行实例化操作。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Printable</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetClassName</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Printable</span><span class="w"></span>
<span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetClassName</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="c1">// C++ 11 中 override 可选，为了可读性，建议加上</span>
</span><span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Entity&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span><span class="p">};</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="k">class</span> <span class="nc">Player</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">GetClassName</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="c1">// C++ 11 中 override 可选，为了可读性，建议加上</span>
</span><span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Player&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="p">};</span><span class="w"></span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="n">Printable</span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"></span>
<span class="linenos">29</span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">GetClassName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">();</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">();</span><span class="w"></span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Entity&quot;</span>
<span class="linenos">39</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="n">player</span><span class="p">);</span><span class="w">  </span><span class="c1">// output will be &quot;Player&quot;</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">player</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id178">
<h3>27. C++ 中的可见性（作用域）<a class="headerlink" href="#id178" title="永久链接至标题">¶</a></h3>
<p>可见性是指类中的属性或者方法的可见性，C++ 中有三种可见性，分别是 <code class="docutils literal notranslate"><span class="pre">public</span></code> 、 <code class="docutils literal notranslate"><span class="pre">protected</span></code> 和 <code class="docutils literal notranslate"><span class="pre">private</span></code>。
类中的可见性默认是 <code class="docutils literal notranslate"><span class="pre">private</span></code>, 结构体中的可见性默认是 <code class="docutils literal notranslate"><span class="pre">public</span></code> 。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>可见性</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>private</p></td>
<td><p>修饰后的成员只能在 <strong>当前类</strong> 或者 <strong>友元</strong> 中进行访问</p></td>
</tr>
<tr class="row-odd"><td><p>protected</p></td>
<td><p>修饰后的成员只能在 <strong>当前类</strong> 或者 <strong>派生类</strong> 中进行访问</p></td>
</tr>
<tr class="row-even"><td><p>public</p></td>
<td><p>修饰后的成员在任何地方都可进行访问</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id179">
<h3>28. C++ 中的数组<a class="headerlink" href="#id179" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">example</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">   </span><span class="c1">// 访问数组中元素</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">      </span><span class="c1">// 数组的地址</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在上面的代码中数组名称就是一个指向整型（元素类型）的指针：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 7</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">example</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">example</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="c1">// 5</span>
<span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="c1">// 6</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>有时需要通过 <cite>new</cite> 关键字来创建数组，主要是考虑到数组对象的生命周期问题。如果需要
在某个方法种创建并返回数组，则通常需使用 <cite>new</cite> 关键字来创建数组，同时必须在代码中
调用 <cite>delete</cite> 来删除该数组，在此调用之前，该数组将会一直存在：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">example</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w">                 </span><span class="c1">// 存储在栈中</span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">example</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w">      </span><span class="c1">// 存储在堆中</span>
</span><span class="linenos">12</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">another</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">another</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>C++ 中的数组无法直接获取其中包含的元素的数量：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"> </span><span class="c1">// 5</span>
</span><span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0</span>
</span><span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在 C++ 11 中可以通过以下代码获取数组中元素的数量，但是会有额外的开销：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;array&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-stirng">
<h3>29. C++ 中的 Stirng 是如何工作的<a class="headerlink" href="#c-stirng" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>C 风格字符串：</p></li>
</ul>
<blockquote>
<div><p><strong>双引号</strong> 的类型默认为 <code class="docutils literal notranslate"><span class="pre">char*</span></code> , 使用 <strong>单引号</strong> 的类型为 <code class="docutils literal notranslate"><span class="pre">char</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">char*</span> <span class="pre">name</span> <span class="pre">=</span> <span class="pre">&quot;Cherno&quot;;</span></code> 这里使用了 C 风格的代码来表示字符串，虽然这里的 <code class="docutils literal notranslate"><span class="pre">name</span></code> 是
一个指针类型，但不需要通过 <code class="docutils literal notranslate"><span class="pre">delete</span> <span class="pre">name</span></code> 来清理内存，记住仅在使用 new 关键字分
配内存的时候才使用 <code class="docutils literal notranslate"><span class="pre">delete</span></code> 清理内存。 <em>内存中从指针开始到后面的第一个存储值为
0的字节部分为字符串的内容。</em> 这也是下面代码中使用 <code class="docutils literal notranslate"><span class="pre">std::cout</span></code> 可以输出完整字符
串的原因（name2、name3可是指针）。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span>
</span><span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name2</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;\0&#39;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name3</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;7&quot;</span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">name3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;6&quot;</span>
</span><span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Cherno&quot;</span>
</span><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name3</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Cherno&quot;</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>C++ 风格字符串：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// output will be &quot;6&quot;</span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">         </span><span class="c1">// output will be &quot;Cherno&quot;</span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>使用下面两种方式进行字符串的拼接：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">2</span><span class="n">name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;another&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;another&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id180">
<h3>30. C++ 中的 Stirng 字面量<a class="headerlink" href="#id180" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Che</span><span class="se">\0</span><span class="s">rno&quot;</span><span class="p">;</span><span class="w">        </span><span class="c1">// \0 represents NUL</span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="c1">//const char name[] = &quot;Che\0rno&quot;        // same as above</span>
<span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// output will be &quot;3&quot;</span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// output will be &quot;Che&quot;</span>
</span><span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// or u8&quot;Cherno&quot;   // UTF-8,1 bytes per character</span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="o">*</span><span class="w"> </span><span class="n">name2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">L</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w">               </span><span class="c1">// 1 or 2 or 4 byte(s) per character</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char16_t</span><span class="o">*</span><span class="w"> </span><span class="n">name3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">u</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w">              </span><span class="c1">// UTF-16,2 bytes per character</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char32_t</span><span class="o">*</span><span class="w"> </span><span class="n">name4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">U</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w">              </span><span class="c1">// UTF-32,4 bytes per character</span>
</span><span class="hll"><span class="linenos"> 9</span>
</span><span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="w"> </span><span class="n">s_name2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">L</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">u16string</span><span class="w"> </span><span class="n">s_name3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">u</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">u32string</span><span class="w"> </span><span class="n">s_name4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">U</span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">paragraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span><span class="s">Line1</span>
<span class="linenos">16</span><span class="s">Line2</span>
<span class="linenos">17</span><span class="s">Line3</span>
<span class="linenos">18</span><span class="s">Line4</span><span class="dl">)</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">paragraph2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Line1</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="s">&quot;Line2</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="s">&quot;Line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="s">&quot;Line4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">paragraph</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">paragraph2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Line1</span>
<span class="n">Line2</span>
<span class="n">Line3</span>
<span class="n">Line4</span>
<span class="n">Line1</span>
<span class="n">Line2</span>
<span class="n">Line3</span>
<span class="n">Line4</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>字符串总是存储在只读的内存空间中。</p>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 7</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Charno&quot;</span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id181">
<h3>31. C++ 中的常量<a class="headerlink" href="#id181" title="永久链接至标题">¶</a></h3>
<p>使用 <cite>const</cite> 修饰的变量表示其不希望在程序中被修改。</p>
<ul>
<li><p>基本使用场景：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_AGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MAX_AGE</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">12</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>修饰类中的成员方法：</p>
<blockquote>
<div><p>表示方法不会对成员变量进行修改。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_X</span><span class="p">,</span><span class="w"> </span><span class="n">m_Y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">GetX</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_X</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetX</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="n">m_X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="hll"><span class="linenos">20</span><span class="kt">void</span><span class="w"> </span><span class="nf">PrinEntity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">GetX</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">24</span>
<span class="linenos">25</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">26</span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="n">PrinEntity</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="c-mutable">
<h3>32. C++ 中的 Mutable 关键字<a class="headerlink" href="#c-mutable" title="永久链接至标题">¶</a></h3>
<p><cite>Mutable</cite> 单词的意思为“可以修改的”，C++ 中主要又两个使用场景，分别是：</p>
<blockquote>
<div><ul class="simple">
<li><p>Const 常量相关</p></li>
<li><p>Lambda 表达式相关</p></li>
</ul>
</div></blockquote>
<ul>
<li><p>在常量上下文中的 mutable 使用：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">GetName</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">20</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>使用 <cite>mutable</cite> 关键字修饰的类成员变量使其可以在 const 方法中被修改：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="k">mutable</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m_DebugCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">12</span><span class="w">        </span><span class="n">m_DebugCount</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">13</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">GetName</span><span class="p">();</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">23</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p>在 Lambda 上下文中使用 mutable:</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]()</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">        </span><span class="n">y</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">16</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><cite>[=]</cite> 表示在 Lambda 中对外部的局部变量以值拷贝的方式使用，<cite>[&amp;]</cite> 表示以引用的
方式使用。使用 <cite>mutable</cite> 关键字修饰 Lambda 可以对上面的代码进行简化：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="c1">// x = 8 here</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id182">
<h3>33. C++ 中的成员初始化列表（构造函数初始化器列表）<a class="headerlink" href="#id182" title="永久链接至标题">¶</a></h3>
<p>类成员初始化的几种方式：</p>
<ul>
<li><p>方式一（构造函数中初始化）</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">        </span><span class="n">m_Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unknown&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">16</span><span class="w">        </span><span class="n">m_Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span><span class="p">};</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity2</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// output will be &quot;Unknown&quot;</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity2</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Cherno&quot;</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>方式二（成员初始化列表）</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="s">&quot;Unknown&quot;</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">16</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span><span class="p">};</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity2</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// output will be &quot;Unknown&quot;</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity2</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Cherno&quot;</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>当有多个成员变量的时候，注意成员初始化列表中的顺序需要与它们定义的顺序保持一
致，否则可能会导致某些编译器报错，这是因为类中成员变量初始化总是按照它们在类
中出现的先后顺序确定的。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 2</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 4</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Score</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="s">&quot;Unknown&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">m_Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
<p>为什么需要成员初始化列表？</p>
<blockquote>
<div><ul>
<li><p>避免额外无意义的初始化</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 2</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Score</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
</span><span class="linenos"> 9</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// without [ m_Name(&quot;Unknown&quot;) ] here</span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">        </span><span class="n">m_Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unknown&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>上面的代码中，我们没有在成员初始化列表中对 <code class="docutils literal notranslate"><span class="pre">m_Name</span></code> 成员进行初始化，而
是将其初始化代码添加到构造函数体内部。这会导致 <code class="docutils literal notranslate"><span class="pre">m_Name</span></code> 进行两次初始化。
第一次是默认的，第二次是在构造函数体中我们编码写的。</p>
</li>
<li><p>演示代码</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Example</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="n">Example</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Created Example !&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">Example</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Created Example With &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">Example</span><span class="w"> </span><span class="n">m_Example</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">        </span><span class="n">m_Example</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Example</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">27</span><span class="p">};</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">30</span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">33</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>将会输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Created Example !
Created Example With 8!
</pre></div>
</div>
<p>如果我们使用成员初始化列表：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Example</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Example</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Created Example !&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">Example</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Created Example With &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">Example</span><span class="w"> </span><span class="n">m_Example</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Example</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="c1">// or : m_Example(8)</span>
</span><span class="linenos">25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">27</span><span class="p">};</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">30</span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">33</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出将会是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Created Example With 8!
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id183">
<h3>34. 三元运算符<a class="headerlink" href="#id183" title="永久链接至标题">¶</a></h3>
<p>略。</p>
</div>
<div class="section" id="id184">
<h3>35. C++ 中如何创建并初始化对象<a class="headerlink" href="#id184" title="永久链接至标题">¶</a></h3>
<p>C++ 中对像的创建主要有两种，主要根据对象在内存中的创建的位置进行分类，栈中 和 堆中。
栈中的对象的生命周期在离开其作用域后结束，而堆中的对象的生命周期将由编程人员决定。</p>
<p>栈通常不会很大，因此如果需要创建大量的对象的时候，考虑在堆中创建。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">new</span></code> 关键字创建的对象在堆中，注意使用 <code class="docutils literal notranslate"><span class="pre">delete</span></code> 删除堆中分配的内存。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="s">&quot;Unknown&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="p">};</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity1</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w">               </span><span class="c1">// stack</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// heap</span>
</span><span class="linenos">19</span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity1</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">entity2</span><span class="p">).</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">entity2</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">entity2</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-new">
<h3>36. C++ 中的 NEW 关键字<a class="headerlink" href="#c-new" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">new</span></code> 关键字除了寻找恰当大小的内存以存储目标对象，还会进行构造函数的调用。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="s">&quot;Unknown&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="p">};</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w"></span>
</span><span class="linenos">20</span>
<span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w"> </span><span class="c1">// or new Entity();</span>
</span><span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">entity2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="c1">// Entity* entity2 = new(c) Entity[50]; // 指定在哪里创建对象</span>
</span><span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">entity2</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">29</span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-explict">
<h3>37. C++ 中的隐式转换和 Explict 关键字<a class="headerlink" href="#c-explict" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>隐式类型转换</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Age</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="s">&quot;Unknown&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">m_Age</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="n">m_Age</span><span class="p">(</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span><span class="p">};</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="o">&amp;</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">24</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">a1</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// only use &quot;Cherno&quot; is ok in tutorial video</span>
</span><span class="linenos">28</span>
<span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">b2</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">32</span>
<span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w">              </span><span class="c1">// 如果存在 Print(int) 前面的函数，则会调用这个更匹配的</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">    </span><span class="c1">// Print(&quot;Cherno&quot;);     // 这会失败因为仅允许一次隐式类型转化</span>
</span><span class="hll"><span class="linenos">35</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">));</span><span class="w"></span>
</span><span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">38</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>explicit 关键字</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Age</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m_Age</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="o">&amp;</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">b2</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entity</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="c1">// Entity b3 = 22;  // this will be fail</span>
</span><span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="c1">// Print(22);       // this will be fail</span>
</span><span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">25</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
<p>C++ 中只会进行一次隐式类型转换，不会进行多次隐式类型转换。</p>
</div>
<div class="section" id="id185">
<h3>38. C++ 中的操作符和操作符重载<a class="headerlink" href="#id185" title="永久链接至标题">¶</a></h3>
<p>C++ 中的操作符仅仅是一个函数。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span>  <span class="nc">Vector2</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Vector2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">12</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">14</span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="n">Add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">17</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">;</span><span class="w"> </span><span class="c1">// or return operator+(other);</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Vector2</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">29</span>
<span class="hll"><span class="linenos">30</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">32</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">);</span><span class="c1">// or return !operator==(other);</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">34</span><span class="p">};</span><span class="w"></span>
<span class="linenos">35</span>
<span class="hll"><span class="linenos">36</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">37</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">40</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">41</span>
<span class="linenos">42</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">43</span><span class="p">{</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="nf">positon</span><span class="p">(</span><span class="mf">4.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="nf">speed</span><span class="p">(</span><span class="mf">0.5f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.5f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="nf">powerup</span><span class="p">(</span><span class="mf">1.1f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.1f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">47</span>
<span class="hll"><span class="linenos">48</span><span class="w">    </span><span class="n">Vector2</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">positon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">powerup</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">49</span>
<span class="hll"><span class="linenos">50</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">51</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">52</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a class="reference internal" href="#id222"><span class="std std-ref">仿函数中的重载</span></a></p>
</div>
<div class="section" id="c-this">
<h3>39. C++ 中的 this 关键字<a class="headerlink" href="#c-this" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 2</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id186">
<h3>40. C++ 中的对象生命周期<a class="headerlink" href="#id186" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>作用域（scope）</p>
<blockquote>
<div><ul>
<li><p>函数作用域</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"></span>
<span class="hll"><span class="linenos">2</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">3</span><span class="w">    </span><span class="c1">// code here</span>
</span><span class="hll"><span class="linenos">4</span><span class="p">}</span><span class="w"></span>
</span></pre></div>
</div>
</li>
<li><p>空作用域</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="p">{</span><span class="w"></span>
</span><span class="linenos">2</span><span class="w">    </span><span class="c1">// code here</span>
<span class="hll"><span class="linenos">3</span><span class="p">}</span><span class="w"></span>
</span></pre></div>
</div>
</li>
<li><p>类作用域</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">        </span><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">   </span><span class="c1">// output will be &quot;Entity Created!&quot;</span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w">               </span><span class="c1">// output will be &quot;Entity Destoried!&quot;</span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上面代码中的 <code class="docutils literal notranslate"><span class="pre">e</span></code> 对象是在 <strong>栈</strong> 空间中创建的，在其作用域结束时（第
21 行）由于栈空间中其内存的释放，该对象被销毁，因此其析构函数被调用。</p>
<p>与上面的代码不同的是，下面代码中的 <code class="docutils literal notranslate"><span class="pre">e</span></code> 指针指向了分配在堆中的对象，
在其作用域结束时（第 21 行）由于栈空间中其内存的释放，该 <strong>指针</strong> 被
销毁， <em>但指针所指向的堆中的对象并没有被销毁</em> ，相反该堆中的对象在程序
终止后由操作系统将其销毁。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">        </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w">   </span><span class="c1">// output will be &quot;Entity Created!&quot;</span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>注意事项：</p>
<blockquote>
<div><p>下面代码 <code class="docutils literal notranslate"><span class="pre">int*</span> <span class="pre">CreateArray()</span></code> 函数中，由于 <code class="docutils literal notranslate"><span class="pre">array</span></code> 数组是在栈
中创建的，因此在该函数的作用域结束后，该 <code class="docutils literal notranslate"><span class="pre">array</span></code> 数组对象将被销
毁，因此 <code class="docutils literal notranslate"><span class="pre">main</span></code> 函数中的指针 <code class="docutils literal notranslate"><span class="pre">a</span></code> 将不会获得一个有效的数组（该
指针指向的数组在 <code class="docutils literal notranslate"><span class="pre">CreateArray</span></code> 方法返回后就被销毁了，虽然该指针
还指向之前的那个地址）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="nf">CreateArray</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateArray</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>可以在 <code class="docutils literal notranslate"><span class="pre">int*</span> <span class="pre">CreateArray()</span></code> 函数中在堆中创建数组对象，这样在该
函数的作用域结束后，堆中的数组对象并不会被销毁，这样就可以在 <code class="docutils literal notranslate"><span class="pre">main</span></code>
函数中获得预期的数组对象：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="nf">CreateArray</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateArray</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>利用作用域创建智能指针：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="hll"><span class="linenos">17</span><span class="k">class</span>  <span class="nc">ScopedPtr</span><span class="w"></span>
</span><span class="hll"><span class="linenos">18</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">m_Ptr</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">ScopedPtr</span><span class="p">(</span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="o">:</span><span class="n">m_Ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="o">~</span><span class="n">ScopedPtr</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Ptr</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">38</span>
<span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">40</span><span class="w">        </span><span class="n">ScopedPtr</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w">  </span><span class="c1">// 隐式转换</span>
</span><span class="hll"><span class="linenos">41</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">42</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">43</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Entity Created!
Entity Created!
Entity Destoried!
</pre></div>
</div>
</div></blockquote>
<p>Timer base on scope</p>
<p>Mutex lock base on scope</p>
</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id187">
<h3>41. C++ 中的智能指针<a class="headerlink" href="#id187" title="永久链接至标题">¶</a></h3>
<p>C++ 中的智能指针就是在使用 <code class="docutils literal notranslate"><span class="pre">new</span></code> 关键字分配内存后不需要你手动地去 <code class="docutils literal notranslate"><span class="pre">delete</span></code> 掉
这部分内存。</p>
<ol class="arabic">
<li><p>unique pointer (a kind of socped pointer)</p>
<p>unique pinter 不能复制</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">23</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="p">();</span><span class="w">   </span><span class="c1">// or : std::unique_ptr&lt;Entity&gt; entity1(new Entity);</span>
</span><span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">        </span><span class="c1">// std::unique_ptr&lt;Entity&gt; entity2 = entity1; // 这是不允许的</span>
</span><span class="linenos">26</span>
<span class="hll"><span class="linenos">27</span><span class="w">        </span><span class="n">entity1</span><span class="o">-&gt;</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Entity Created!
Entity Created!
Entity Destoried!
Entity Destoried!
</pre></div>
</div>
</li>
<li><p>shared pointer(based on reference counting)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entity2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="p">();</span><span class="w">   </span><span class="c1">// or : std::shared_ptr&lt;Entity&gt; entity2 (new Entity);</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">                                                                            </span><span class="c1">// 引用计数为一</span>
</span><span class="hll"><span class="linenos">27</span><span class="w">            </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entity2</span><span class="p">;</span><span class="w">      </span><span class="c1">// 引用计数加一</span>
</span><span class="hll"><span class="linenos">28</span><span class="w">        </span><span class="p">}</span><span class="w">   </span><span class="c1">//  entity2 的作用域结束，引用计数减一</span>
</span><span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w">       </span><span class="c1">//  entity1 的作用域结束，引用计数减一，对象被销毁</span>
</span><span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>将 <cite>shared_ptr</cite> 拷贝给 <cite>weak_ptr</cite> ，不会增加 <cite>shared_ptr</cite> 的引用计数：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Created!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="o">~</span><span class="n">Entity</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Entity Destoried!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entity1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entity2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span><span class="p">();</span><span class="w">   </span><span class="c1">// or : std::shared_ptr&lt;Entity&gt; entity2 (new Entity);</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">                                                                            </span><span class="c1">// 引用计数为一</span>
</span><span class="hll"><span class="linenos">27</span><span class="w">            </span><span class="n">entity1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entity2</span><span class="p">;</span><span class="w">      </span><span class="c1">// 引用计数不变</span>
</span><span class="hll"><span class="linenos">28</span><span class="w">        </span><span class="p">}</span><span class="w">   </span><span class="c1">//  entity2 的作用域结束，引用计数减一，对象被销毁</span>
</span><span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w">       </span><span class="c1">//  entity1 的作用域结束</span>
</span><span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="copying-and-copy-constructors-in-c">
<h3>42. Copying and Copy Constructors in C++<a class="headerlink" href="#copying-and-copy-constructors-in-c" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">String</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">m_Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span>
</span><span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="p">};</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span>
</span><span class="linenos">25</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">26</span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">32</span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// output will be &quot;Cherno&quot;</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">36</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>我们进行一次复制操作：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">String</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="c1">//String(const String&amp; string) = delete; // use this to remove the default copy constructor</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">m_Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="p">};</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">27</span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">33</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">34</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">35</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">41</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cherno</span>
<span class="n">Cherno</span>
</pre></div>
</div>
<p>程序输出正确，然而当我们在命令行输出窗口中按下回车键，程序运行到 40 行时，程序将
崩溃。这是由于 C++ 中默认的复制操作底层实现是将类中的所有成员进行简单的复制，也
就是说在 <code class="docutils literal notranslate"><span class="pre">string</span></code> 和 <code class="docutils literal notranslate"><span class="pre">second</span></code> 对象中的成员 <code class="docutils literal notranslate"><span class="pre">m_Buffer</span></code> 和 <code class="docutils literal notranslate"><span class="pre">m_Size</span></code> 拥有相
同的值，程序运行到最后时，对象将会调用其析构函数，导致同一个 <code class="docutils literal notranslate"><span class="pre">m_Buffer</span></code> 值作为
参数被连续两次调用 <cite>delete[]</cite> ，这就是崩溃的原因。</p>
<p>按如下调整可解决该问题：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">String</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">m_Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="c1">//String(const String&amp; other) = delete; // use this to remove the default copy constructor</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Size</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">m_Size</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;String Copied!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span><span class="w">        </span><span class="n">m_Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
</span><span class="hll"><span class="linenos">23</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">m_Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">25</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">char</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">37</span><span class="p">};</span><span class="w"></span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">40</span><span class="p">{</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="n">m_Buffer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span><span class="p">}</span><span class="w"></span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="kt">void</span><span class="w"> </span><span class="n">PrintString</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">46</span><span class="p">{</span><span class="w"></span>
<span class="linenos">47</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">48</span><span class="p">}</span><span class="w"></span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">51</span><span class="p">{</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="p">;</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">    </span><span class="n">PrintString</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="n">PrintString</span><span class="p">(</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">59</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>String Copied!
String Copied!
Cherno
String Copied!
Cherno
</pre></div>
</div>
<p>拷贝发生在 53，55，56 三处，其中 55，56 两行发生的拷贝可将 45 行代码调整如下解决：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="kt">void</span><span class="w"> </span><span class="n">PrintString</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
</span></pre></div>
</div>
</div>
<div class="section" id="id188">
<h3>43. C++ 中的箭头（-&gt;）操作符<a class="headerlink" href="#id188" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>基础使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">).</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">Entity</span><span class="o">&amp;</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">26</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>在 Scoped Pointer 中使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">class</span>  <span class="nc">ScopedPtr</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">m_Ptr</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="n">ScopedPtr</span><span class="p">(</span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">19</span><span class="w">        </span><span class="o">:</span><span class="n">m_Ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="o">~</span><span class="n">ScopedPtr</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Ptr</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span>
<span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Ptr</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">31</span><span class="p">};</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="n">Entity</span><span class="o">*</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">e1</span><span class="o">-&gt;</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">e1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span>
<span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="n">ScopedPtr</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entity</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">40</span><span class="w">    </span><span class="n">e2</span><span class="o">-&gt;</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">43</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>获取成员在内存中的偏移</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span> <span class="nc">Vector3</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(((</span><span class="n">Vector3</span><span class="o">*</span><span class="p">)</span><span class="k">nullptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">   </span><span class="c1">// output will be &quot;4&quot;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id189">
<h3>44. C++ 中的动态数组<a class="headerlink" href="#id189" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">std::vector&lt;Vertex&gt;</span> <span class="pre">vertices;</span></code> 还是 <code class="docutils literal notranslate"><span class="pre">std::vector&lt;Vertex*&gt;</span> <span class="pre">vertices;</span></code> ？</p>
<p>第一种是在栈空间中创建数组，在内存中是连续的，因此遍历的效率会好一些。但是如果需
要 resize 的话，就需要将整个数据拷贝到另一个更大的内存空间中，会有一定的开销。</p>
<p>第二种是则是在堆空间中创建数组，在内存中通常不是连续的，因此遍历的效率会差一些。
但是 resize 的时候会少一些拷贝的开销。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span> <span class="nc">Vertex</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vertex</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vertex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vertex</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vertex</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">// 添加元素</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="c1">// 遍历元素</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vertex</span><span class="o">&amp;</span><span class="w"> </span><span class="nl">v</span> <span class="p">:</span><span class="w"> </span><span class="n">vertices</span><span class="p">)</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="w">    </span><span class="c1">// 移除元素</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">vertices</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="c1">// 清除</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">41</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>std::vector 更像是是 array list</p>
</div>
<div class="section" id="c-std-vector">
<h3>45. C++ 中的 std-vector 使用优化<a class="headerlink" href="#c-std-vector" title="永久链接至标题">¶</a></h3>
<p>使用 <code class="docutils literal notranslate"><span class="pre">std::vector</span></code> 向里面 <code class="docutils literal notranslate"><span class="pre">push_back</span></code> 元素时，如果 vector 的 capcity 无法完
成此次添加的操作，则需要分配一个更大的内存空间以将新添加的元素容纳进来，并把原来
内存空间中的数据拷贝到新分配的空间中。在使用 <code class="docutils literal notranslate"><span class="pre">std::vector</span></code> 过程中，如何避免这
种元素数据的拷贝？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span> <span class="nc">Vertex</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Vertex</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="n">Vertex</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vertex</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vertex</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">14</span><span class="w">        </span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">z</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Copied!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">18</span><span class="p">};</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span>
<span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Vertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Vertex</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">));</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Vertex</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">));</span><span class="w"></span>
</span><span class="linenos">27</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Copied!
Copied!
Copied!
Copied!
Copied!
Copied!
</pre></div>
</div>
<p>在上面的代码中，有两种类型的数据拷贝：</p>
<blockquote>
<div><ol class="arabic">
<li><p><code class="docutils literal notranslate"><span class="pre">vertices.push_back(Vertex(1,</span> <span class="pre">2,</span> <span class="pre">3));</span></code> 这里调用 <cite>vector</cite> 的 <cite>push_back</cite>
时，<code class="docutils literal notranslate"><span class="pre">Vertex(1,</span> <span class="pre">2,</span> <span class="pre">3</span></code> 会在 <code class="docutils literal notranslate"><span class="pre">mian</span></code> 方法所在的 <cite>stack frame</cite> 中进行构建，
然后在方法调用时拷贝到 <cite>vector</cite> 对象所在的 <cite>stack frame</cite> ；</p>
<blockquote>
<div><p>可以通过调用 <code class="docutils literal notranslate"><span class="pre">vertices.push_back</span></code> 而不是 <code class="docutils literal notranslate"><span class="pre">vertices.push_back</span></code> 避
免这种类型的拷贝：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">24</span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
</span></pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Copied!
Copied!
Copied!
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">emplace_back</span></code> 方法中传递的是构建目标对象的参数列表，而不是已构建好
的对象本身。</p>
</div></blockquote>
</li>
<li><p>上面代码创建的 <cite>vertices</cite> 对象默认的 <cite>capacity</cite> 是 <code class="docutils literal notranslate"><span class="pre">1</span></code> ，因此添加第二个
元素的时候就需要把之前的元素拷贝到新分配的更大的内存空间中。</p>
<blockquote>
<div><p>可以通过调用 <code class="docutils literal notranslate"><span class="pre">vertices.reserve(3);</span></code> 来告诉 vector 准备创建可容纳 3
个元素的的对象：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span>
<span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="n">vertices</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>这时将不会有任何输出，即避免了之前两种拷贝的发生。</p>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id190">
<h3>46. C++ 中库的使用（静态链接）<a class="headerlink" href="#id190" title="永久链接至标题">¶</a></h3>
<p>includes: a bounch of header files.</p>
<p>libraries: pre-compiled binaries, static or dynamic.</p>
<p>静态链接效率通常会好一些。</p>
<p>visual studio 中设置：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>include directories:</p></li>
</ol>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">C/C++</span> <span class="pre">-&gt;</span> <span class="pre">General</span> <span class="pre">-&gt;</span> <span class="pre">Adding</span> <span class="pre">include</span> <span class="pre">Directories</span></code></p>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>include directories:</p>
<p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Linker</span> <span class="pre">-&gt;</span> <span class="pre">General</span> <span class="pre">-&gt;</span> <span class="pre">Additional</span> <span class="pre">Library</span> <span class="pre">Directories</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Linker</span> <span class="pre">-&gt;</span> <span class="pre">Input</span> <span class="pre">-&gt;</span> <span class="pre">Additional</span> <span class="pre">Dependencies</span></code> : <code class="docutils literal notranslate"><span class="pre">glfw3.lib</span></code></p>
<p>如果设置了第一项，第二项中只填入库文件的相对路径就行，否则需要在第二项中填入完整的库文件路径。</p>
</li>
</ol>
</div></blockquote>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="c1">// #include &lt;GLFE/glfw3.h&gt;</span>
</span><span class="hll"><span class="linenos"> 3</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">glfwInit</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">glfwInit</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id191">
<h3>47. C++ 中使用动态链接库<a class="headerlink" href="#id191" title="永久链接至标题">¶</a></h3>
<p>visual studio 中设置：</p>
<blockquote>
<div><ol class="arabic">
<li><p>include directories:</p>
<p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">C/C++</span> <span class="pre">-&gt;</span> <span class="pre">General</span> <span class="pre">-&gt;</span> <span class="pre">Adding</span> <span class="pre">include</span> <span class="pre">Directories</span></code></p>
</li>
<li><p>include directories:</p>
<p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Linker</span> <span class="pre">-&gt;</span> <span class="pre">General</span> <span class="pre">-&gt;</span> <span class="pre">Additional</span> <span class="pre">Library</span> <span class="pre">Directories</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Linker</span> <span class="pre">-&gt;</span> <span class="pre">Input</span> <span class="pre">-&gt;</span> <span class="pre">Additional</span> <span class="pre">Dependencies</span></code> : <code class="docutils literal notranslate"><span class="pre">glfw3dll.lib</span></code> (注意保证 <code class="docutils literal notranslate"><span class="pre">glfw3dll.lib</span></code> 与 <code class="docutils literal notranslate"><span class="pre">glfw3.dll</span></code> 是同时编译的 )</p>
<p>如果设置了第一项，第二项中只填入库文件的相对路径就行，否则需要在第二项中填入完整的库文件路径。</p>
<p><strong>运行程序时，需要把 ``glfw3.dll`` 放到程序所在的路径下。</strong></p>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id192">
<h3>48. 创建和使用 C++ 库<a class="headerlink" href="#id192" title="永久链接至标题">¶</a></h3>
<ol class="arabic simple">
<li><p>Visual Studio 中创建一个空的 C++ 项目 <code class="docutils literal notranslate"><span class="pre">Game</span></code> ; 然后再添加一个空的 C++ 项目 <code class="docutils literal notranslate"><span class="pre">Engine</span></code> 。</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">Game</span></code> 项目的 <cite>Project Properties -&gt; Configuration Properties -&gt; General -&gt; General Properties -&gt; Configuration Type</cite> 选项中设置为 <code class="docutils literal notranslate"><span class="pre">Application</span> <span class="pre">(.exe)</span></code> 。</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">Engine</span></code> 项目的 <cite>Project Properties -&gt; Configuration Properties -&gt; General -&gt; General Properties -&gt; Configuration Type</cite> 选项中设置为 <code class="docutils literal notranslate"><span class="pre">Static</span> <span class="pre">library</span> <span class="pre">(.lib)</span></code> 。</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">Game</span></code> 项目的 <code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">Configuration</span> <span class="pre">Properties</span> <span class="pre">-&gt;</span> <span class="pre">C/C++</span> <span class="pre">-&gt;</span> <span class="pre">General</span> <span class="pre">-&gt;</span> <span class="pre">Adding</span> <span class="pre">include</span> <span class="pre">Directories</span></code> 选项中添加 <code class="docutils literal notranslate"><span class="pre">Engine</span></code> 项目中头文件所在的路径。（为了编译通过）</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">Game</span></code> 项目的引用中添加对 <code class="docutils literal notranslate"><span class="pre">Engine</span></code> 项目的引用。（为了链接通过）</p></li>
</ol>
</div>
<div class="section" id="id193">
<h3>49. C++ 中如何处理多个返回值<a class="headerlink" href="#id193" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">结构体</span></code> <code class="docutils literal notranslate"><span class="pre">以引用的方式传递待返回的数据到方法中</span></code> <code class="docutils literal notranslate"><span class="pre">std::tuple</span></code> <code class="docutils literal notranslate"><span class="pre">std::pair</span></code></p>
</div>
<div class="section" id="id194">
<h3>50. C++ 中的模板<a class="headerlink" href="#id194" title="永久链接至标题">¶</a></h3>
<p>C++ 中的模板有些类似于 CSharp 中的泛型，模板在编译的时候被“展开”，而宏则是
在此之前进行“展开”（简单的文本替换）。</p>
<p>没有使用模板的代码：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="mf">5.5f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>使用模板后的代码：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w">    </span><span class="c1">// or : template&lt;class T&gt;</span>
</span><span class="hll"><span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w">           </span><span class="c1">// or : Print&lt;int&gt;(5);</span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w">     </span><span class="c1">// or : Print&lt;std::string&gt;(&quot;Hello&quot;);</span>
</span><span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="n">Print</span><span class="p">(</span><span class="mf">5.5f</span><span class="p">);</span><span class="w">        </span><span class="c1">// or : Print&lt;float&gt;(5.5f);</span>
</span><span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>编译时，编译器会根据代码的情况将模板生成相应的代码，然后进行编译。比如上面的
代码中，编译器就会生成3个函数 <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">Print(int</span> <span class="pre">value)</span></code> 、 <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">Print(float</span> <span class="pre">value)</span></code> 和 <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">Print(std::string</span> <span class="pre">value)</span></code> 。
如果代码中没有任何调用模板的代码，则编译器不会生成相应的函数。当不需要编译器
生成函数的时候，如果模板中的代码有错误，有些编译器是不会报错的。</p>
<p>示例：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos"> 4</span><span class="k">class</span> <span class="nc">Array</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">m_Array</span><span class="p">[</span><span class="n">N</span><span class="p">];</span><span class="w"></span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">GetSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">array</span><span class="p">.</span><span class="n">GetSize</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id195">
<h3>51. C++ 中的栈和堆<a class="headerlink" href="#id195" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id196">
<h3>52. C++ 中的宏<a class="headerlink" href="#id196" title="永久链接至标题">¶</a></h3>
<p>模板在编译的时候被“展开”，而宏则是在此之前进行“展开”（简单的文本替换）。</p>
<ul>
<li><p>示例代码一：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="cp">#define WAIT std::cin.get()</span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">7</span><span class="w">    </span><span class="n">WAIT</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>示例代码二（带参数）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="cp">#define Log(x) std::cout &lt;&lt; x &lt;&lt; std::endl</span>
</span><span class="linenos">4</span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">6</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">7</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>示例代码三（条件编译）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">#ifdef DEBUG</span>
</span><span class="hll"><span class="linenos"> 4</span><span class="cp">#define Log(x) std::cout &lt;&lt; x &lt;&lt; std::endl</span>
</span><span class="hll"><span class="linenos"> 5</span><span class="cp">#else</span>
</span><span class="hll"><span class="linenos"> 6</span><span class="cp">#define Log(x)</span>
</span><span class="hll"><span class="linenos"> 7</span><span class="cp">#endif</span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>示例代码四（条件编译）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">#define DEBUGLevel  1</span>
</span><span class="linenos"> 4</span>
<span class="hll"><span class="linenos"> 5</span><span class="cp">#if DEBUGLevel == 1</span>
</span><span class="linenos"> 6</span><span class="cp">#define Log(x) std::cout &lt;&lt; x &lt;&lt; std::endl</span>
<span class="linenos"> 7</span><span class="cp">#else</span>
<span class="linenos"> 8</span><span class="cp">#define Log(x)</span>
<span class="linenos"> 9</span><span class="cp">#endif</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>示例代码四（换行）：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="hll"><span class="linenos">3</span><span class="cp">#define MAIN int main() \</span>
</span><span class="hll"><span class="linenos">4</span><span class="cp">{\</span>
</span><span class="hll"><span class="linenos">5</span><span class="cp">    std::cin.get(); \</span>
</span><span class="hll"><span class="linenos">6</span><span class="cp">}</span>
</span><span class="linenos">7</span>
<span class="hll"><span class="linenos">8</span><span class="n">MAIN</span><span class="w"></span>
</span></pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="c-auto">
<h3>53. C++ 中的 auto 关键字<a class="headerlink" href="#c-auto" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id197">
<h3>54. C++ 中的静态数组<a class="headerlink" href="#id197" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id198">
<h3>55. C++ 中的函数指针<a class="headerlink" href="#id198" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>函数指针的基本使用：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Hello1</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">Hello2</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="c1">// 11. auto</span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello1</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="c1">// 12. 指定类型</span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">func12</span><span class="p">)()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello1</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="c1">// 13. typedef 类似于 C# 中的 delegate</span>
<span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">HelloFunc1</span><span class="p">)();</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">HelloFunc1</span><span class="w"> </span><span class="n">func13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello1</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="c1">// 14. lambda</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]()</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">func11</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">func12</span><span class="p">();</span><span class="w">   </span><span class="c1">// or: (*func12)()</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">func13</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">func14</span><span class="p">();</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="c1">// 21. auto</span>
<span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello2</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="c1">// 22. 指定类型</span>
<span class="hll"><span class="linenos">36</span><span class="w">    </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">func22</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello2</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="c1">// 23. typedef 类似于 C# 中的 delegate</span>
<span class="hll"><span class="linenos">39</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">HelloFunc2</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">40</span><span class="w">    </span><span class="n">HelloFunc2</span><span class="w"> </span><span class="n">func23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello2</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="c1">// 24. lambda</span>
<span class="hll"><span class="linenos">43</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="n">func21</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="n">func22</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w">   </span><span class="c1">// or: (*func22)(&quot;Hello!&quot;)</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">func23</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="n">func24</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">51</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>实际使用场景：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="hll"><span class="linenos"> 9</span><span class="kt">void</span><span class="w"> </span><span class="nf">HandleVector</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="nl">item</span> <span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">13</span><span class="w">        </span><span class="n">func</span><span class="p">(</span><span class="n">item</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">HandleVector</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">print</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">23</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="c-lambda">
<h3>56. C++ 中的 Lambda 表达式<a class="headerlink" href="#c-lambda" title="永久链接至标题">¶</a></h3>
<p>Lambda 表达式主要是用于创建匿名函数，通常在 C++ 中使用函数指针的地方都可以
使用 Lambda 表达式。</p>
<p>比如上一节 <a class="reference internal" href="#id198"><span class="std std-ref">55. C++ 中的函数指针</span></a> 中的示例代码可以做如下修改：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">HandleVector</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="nl">item</span> <span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">func</span><span class="p">(</span><span class="n">item</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">HandleVector</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
</span><span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span>
</pre></div>
</div>
</div></blockquote>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print1</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;value outside labmda: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;value in labmda: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Print2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"></span>
</span><span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="n">a</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">Print2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">]()</span><span class="w"> </span><span class="k">mutable</span><span class="w"></span>
</span><span class="linenos">26</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="n">a</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="n">b</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">        </span><span class="n">Print2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">30</span><span class="w">        </span><span class="n">Print2</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">32</span>
<span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">func4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"></span>
</span><span class="linenos">34</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">        </span><span class="n">a</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="n">b</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">        </span><span class="n">Print2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">38</span><span class="w">        </span><span class="n">Print2</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="n">func1</span><span class="p">();</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">func2</span><span class="p">();</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">func3</span><span class="p">();</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">49</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="n">func4</span><span class="p">();</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="n">Print1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">56</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="ow">in</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">value</span> <span class="n">outside</span> <span class="n">labmda</span><span class="p">:</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Labmda 表达式中的 <code class="docutils literal notranslate"><span class="pre">[]</span></code> 是 <cite>captures</cite> 表示如果在 Lambda 表达式内部如
何访问外部的变量:</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">[=]</span></code> :</p>
<p>Lambda 表达式内部全部都按值（by value）的方式访问外部变量;</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">[&amp;]</span></code> :</p>
<p>Lambda 表达式内部全部都按引用（by reference）的方式访问外部变量;</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">[a,&amp;b]</span></code> :</p>
<p>Lambda 表达式内部按值（by value）的方式访问外部变量 <code class="docutils literal notranslate"><span class="pre">a</span></code> ，按引用
（by reference）的方式访问外部变量 <code class="docutils literal notranslate"><span class="pre">b</span></code> 。</p>
</li>
</ul>
</div></blockquote>
<p>关于上述代码中 <cite>mutable</cite> 的使用，可参考前面的章节 <a class="reference internal" href="#c-mutable"><span class="std std-ref">32. C++ 中的 Mutable 关键字</span></a> 。</p>
<p>更多详细的信息可参考 <a class="reference external" href="https://en.cppreference.com/w/cpp/language/lambda">Lambda expressions (since C++11)</a> 。</p>
</div>
<div class="section" id="std">
<h3>57. 为什么不使用 std 命名空间<a class="headerlink" href="#std" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id199">
<h3>58. C++ 中的命名空间<a class="headerlink" href="#id199" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id200">
<h3>59. C++ 中的线程<a class="headerlink" href="#id200" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-timing">
<h3>60. C++ 中的计时（Timing）<a class="headerlink" href="#c-timing" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span>  <span class="nc">Timer</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">duration</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="o">~</span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Timer took &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ms&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">19</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span>  <span class="nc">Timer</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">m_StartTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="o">~</span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">Stop</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Stop</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">endTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_StartTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;us (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ms) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_StartTimepoint</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id201">
<h3>61. C++ 中的多维数组<a class="headerlink" href="#id201" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id202">
<h3>62. C++ 中的排序<a class="headerlink" href="#id202" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="c-type-punning">
<h3>63. C++ 中的（Type Punning）<a class="headerlink" href="#c-type-punning" title="永久链接至标题">¶</a></h3>
<p>将类型 <cite>A</cite> 的指针转换为类型 <cite>B</cite> 的指针，然后按照类型 <cite>B</cite> 来操作关联的内存。</p>
</div>
<div class="section" id="c-unions">
<h3>64. C++ 中的 Unions<a class="headerlink" href="#c-unions" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span> <span class="nc">Vector2</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">struct</span> <span class="nc">Vector4</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vector2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vector4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos">19</span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">w</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="k">struct</span> <span class="nc">MyUnion</span><span class="w"></span>
<span class="linenos">25</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="k">union</span>
</span><span class="hll"><span class="linenos">27</span>    <span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">        </span><span class="n">Vector4</span><span class="w"> </span><span class="n">v4</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="w">        </span><span class="k">struct</span>
</span><span class="hll"><span class="linenos">30</span>        <span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="w">            </span><span class="n">Vector2</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">32</span><span class="w">        </span><span class="p">};</span><span class="w"></span>
</span><span class="hll"><span class="linenos">33</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
</span><span class="linenos">34</span><span class="p">};</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="n">MyUnion</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">v4</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">48</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="section" id="id203">
<h3>65. C++ 中的虚构造函数<a class="headerlink" href="#id203" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span>  <span class="nc">Base</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">Base</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Base Constructed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="o">~</span><span class="n">Base</span><span class="p">()</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Base Destructed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span><span class="p">};</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="k">class</span>  <span class="nc">Derived</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Base</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">Derived</span><span class="p">()</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Derived Constructed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="o">~</span><span class="n">Derived</span><span class="p">()</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">25</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Derived Destructed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">27</span><span class="p">};</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">Base</span><span class="o">*</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Base</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">base</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;--------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="n">Derived</span><span class="o">*</span><span class="w"> </span><span class="n">derived</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Derived</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">derived</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;--------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">36</span><span class="w">    </span><span class="n">Base</span><span class="o">*</span><span class="w"> </span><span class="n">poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Derived</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">37</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">poly</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">40</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="o">--------------------------</span>
<span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="o">--------------------------</span>
<span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
</pre></div>
</div>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">poly</span></code> 变量在被销毁的时候并没有正确地调用 <code class="docutils literal notranslate"><span class="pre">Derived::~Derived()</span></code>
这个析构函数，这是因为 <code class="docutils literal notranslate"><span class="pre">poly</span></code> 被以指向 <code class="docutils literal notranslate"><span class="pre">Base</span></code> 类型地指针对待，在 <code class="docutils literal notranslate"><span class="pre">delete</span> <span class="pre">poly;</span></code>
调用的时候无法知道其是否具有派生类的析构函数。</p>
<p>为了解决这个问题，将基类的析构函数设置为虚函数即可：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">10</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Base</span><span class="p">()</span><span class="w"></span>
</span></pre></div>
</div>
<p>调整后的输出：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="o">--------------------------</span>
<span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="o">--------------------------</span>
<span class="n">Base</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Constructed</span><span class="o">.</span>
<span class="n">Derived</span> <span class="n">Destructed</span><span class="o">.</span>
<span class="n">Base</span> <span class="n">Destructed</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="id204">
<h3>66. C++ 中的类型转换<a class="headerlink" href="#id204" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">               </span><span class="c1">// C style</span>
<span class="linenos">6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">  </span><span class="c1">// C++ style</span>
<span class="linenos">7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>C++ style:</p>
<blockquote>
<div><ul class="simple">
<li><p>static_cast</p></li>
<li><p>dynamic_cast</p></li>
<li><p>const_cast</p></li>
<li><p>reinterpret_cast</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id205">
<h3>67. C++ 中的条件和动作断点<a class="headerlink" href="#id205" title="永久链接至标题">¶</a></h3>
<p>略。</p>
</div>
<div class="section" id="id206">
<h3>68. 现代 C++ 中的安全<a class="headerlink" href="#id206" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id207">
<h3>69. C++ 中的预编译头文件<a class="headerlink" href="#id207" title="永久链接至标题">¶</a></h3>
<p>使用方式：</p>
<ol class="arabic">
<li><p>pch.h</p>
<p>在一个头文件中包含需要预编译的头文件信息。</p>
</li>
<li><p>pch.cpp</p>
<ol class="arabic">
<li><p>在一个 <cite>.cpp</cite> 文件中 <cite>include</cite> 上一步中的头文件。</p>
<div class="literal-block-wrapper docutils container" id="id290">
<div class="code-block-caption"><span class="caption-text">pch.cpp</span><a class="headerlink" href="#id290" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&quot;pch.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
</div>
</li>
<li><p>在该文件的 Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Precompiled Header -&gt; Precompiled Header : <cite>Create (/Yc)</cite></p></li>
</ol>
</li>
<li><p>修改项目相关属性</p>
<ol class="arabic simple">
<li><p>在项目的 Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Precompiled Header -&gt; Precompiled Header : <cite>Use (/Yu)</cite></p></li>
<li><p>在项目的 Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Precompiled Header -&gt; Precompiled Header File : <cite>pch.h</cite></p></li>
</ol>
</li>
</ol>
<p>缺点：</p>
<blockquote>
<div><ul class="simple">
<li><p>使用预编译头文件的项目中不太好知道项目依赖于哪些库</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="c-dynamic-casting">
<h3>70. C++ 中的动态类型转换（Dynamic Casting）<a class="headerlink" href="#c-dynamic-casting" title="永久链接至标题">¶</a></h3>
<p>C++ 中的动态类型转换是在运行时发生的，因此会有一定的性能开销。动态类型转换通常是
发生在类的继承树中，检查一个以基类类型命名的变量中存储的是否是某个子类的实例。</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">PrintName</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
</span><span class="linenos"> 7</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">class</span> <span class="nc">Player</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">class</span> <span class="nc">Enemy</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">Enemy</span><span class="o">*</span><span class="w"> </span><span class="n">enemy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Enemy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">player</span><span class="p">);</span><span class="w">     </span><span class="c1">// cast success. p0 will be some value</span>
</span><span class="hll"><span class="linenos">23</span><span class="w">    </span><span class="n">Player</span><span class="o">*</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">enemy</span><span class="p">);</span><span class="w">      </span><span class="c1">// cast failed. p1 will be nullptr</span>
</span><span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">26</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>C++ 使用 RTTI(Run time type information) 来实现运行时的动态类型转换，有一定的开
销，在 Visual Studio 中的项目的 Properties -&gt; Configuration Properties -&gt; C/C++
-&gt; Language -&gt; Enable Run-Time Type Information 选项中可开启或禁用，禁用后编译的
代码中的动态类型转换相关的代码会出现不可预知的行为。</p>
</div>
<div class="section" id="id208">
<h3>71. C++ 中的性能测试（如何测量性能）<a class="headerlink" href="#id208" title="永久链接至标题">¶</a></h3>
<p>注意在 <cite>Debug</cite> 和 <cite>Release</cite> 模式下存在编译后代码的差异。</p>
<p>测试一：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span>  <span class="nc">Timer</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">m_StartTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="o">~</span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">Stop</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Stop</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">endTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_StartTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;us (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ms) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_StartTimepoint</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="p">};</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">33</span><span class="p">{</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">38</span><span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="n">__debugbreak</span><span class="p">();</span><span class="w"></span>
<span class="linenos">43</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出（Debug）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8935</span><span class="n">us</span> <span class="p">(</span><span class="mf">8.935</span><span class="n">ms</span><span class="p">)</span>
<span class="mi">2000000</span>
</pre></div>
</div>
<p>输出（Release）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="n">us</span> <span class="p">(</span><span class="mf">0.001</span><span class="n">ms</span><span class="p">)</span>
<span class="mi">2000000</span>
</pre></div>
</div>
</div></blockquote>
<p>测试二：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;array&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">struct</span>  <span class="nc">Timer</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">m_StartTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="o">~</span><span class="n">Timer</span><span class="p">()</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">Stop</span><span class="p">();</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Stop</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">endTimepoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_StartTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endTimepoint</span><span class="p">).</span><span class="n">time_since_epoch</span><span class="p">().</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;us (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ms) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_StartTimepoint</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="p">};</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="k">struct</span> <span class="nc">Vector2</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Make Shared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">41</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">44</span><span class="w">            </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;New Shared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">;</span><span class="w"></span>
<span class="linenos">50</span><span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">51</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">52</span><span class="w">            </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Vector2</span><span class="p">());</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Make Unique</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">57</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">;</span><span class="w"></span>
<span class="linenos">58</span><span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">59</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ptrs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">60</span><span class="w">            </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Vector2</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="n">__debugbreak</span><span class="p">();</span><span class="w"></span>
<span class="linenos">64</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出（Debug）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Make</span> <span class="n">Shared</span>
<span class="mi">1142</span><span class="n">us</span> <span class="p">(</span><span class="mf">1.142</span><span class="n">ms</span><span class="p">)</span>
<span class="n">New</span> <span class="n">Shared</span>
<span class="mi">1476</span><span class="n">us</span> <span class="p">(</span><span class="mf">1.476</span><span class="n">ms</span><span class="p">)</span>
<span class="n">Make</span> <span class="n">Unique</span>
<span class="mi">990</span><span class="n">us</span> <span class="p">(</span><span class="mf">0.99</span><span class="n">ms</span><span class="p">)</span>
</pre></div>
</div>
<p>输出（Release）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Make</span> <span class="n">Shared</span>
<span class="mi">112</span><span class="n">us</span> <span class="p">(</span><span class="mf">0.112</span><span class="n">ms</span><span class="p">)</span>
<span class="n">New</span> <span class="n">Shared</span>
<span class="mi">292</span><span class="n">us</span> <span class="p">(</span><span class="mf">0.292</span><span class="n">ms</span><span class="p">)</span>
<span class="n">Make</span> <span class="n">Unique</span>
<span class="mi">89</span><span class="n">us</span> <span class="p">(</span><span class="mf">0.089</span><span class="n">ms</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="c-17-structured-bindings">
<h3>72. C++ 17 中的结构化绑定（Structured Bindings）<a class="headerlink" href="#c-17-structured-bindings" title="永久链接至标题">¶</a></h3>
<p>从 C++ 17 开始的一种可以让方法有多个返回值的方式，在 Visual Studio 中的项目
的 Properties -&gt; Configuration Properties -&gt; C/C++ -&gt; Language -&gt; C++ Language Standard : ISO C++17 Standard (/std:c++17)</p>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">std::tuple</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">std::pair</span></code> :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;tuple&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreatePerson</span><span class="p">()</span><span class="w"> </span><span class="c1">// 或者 std::pair&lt;std::string, int&gt; CreatePerson()</span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">,</span><span class="mi">24</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="c1">// 方式一</span>
<span class="linenos">10</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePerson</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="c1">// 方式二</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">age2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">tie</span><span class="p">(</span><span class="n">name2</span><span class="p">,</span><span class="w"> </span><span class="n">age2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePerson</span><span class="p">();</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>使用 Structured Bindings :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;tuple&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreatePerson</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">,</span><span class="mi">24</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePerson</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="c-17-optional-data">
<h3>73. C++ 17 中如何处理可选数据（Optional Data）<a class="headerlink" href="#c-17-optional-data" title="永久链接至标题">¶</a></h3>
<p>C++ 17 引入的 <code class="docutils literal notranslate"><span class="pre">std::optional</span></code> 类似于 C# 中的 <code class="docutils literal notranslate"><span class="pre">Nullable</span></code> 。</p>
<ul>
<li><p>常规处理方式：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="hll"><span class="linenos"> 4</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">ReadFileAsString</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filePath</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&amp;</span><span class="w"> </span><span class="n">outSuccess</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">stream</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w">  </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="c1">// read file</span>
<span class="linenos">11</span><span class="w">        </span><span class="n">stream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><span class="w"></span>
<span class="hll"><span class="linenos">12</span><span class="w">        </span><span class="n">outSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">13</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">outSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">();</span><span class="w"></span>
</span><span class="linenos">17</span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">fileOpendSuccessfully</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadFileAsString</span><span class="p">(</span><span class="s">&quot;data.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fileOpendSuccessfully</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileOpendSuccessfully</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">22</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;File read successfully!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;File could not be opened!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">std::optional</span></code> ：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;optional&gt;</span><span class="cp"></span>
</span><span class="linenos"> 4</span>
<span class="hll"><span class="linenos"> 5</span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ReadFileAsString</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filePath</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w">  </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="c1">// read file</span>
<span class="linenos">12</span><span class="w">        </span><span class="n">stream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
</span><span class="linenos">16</span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadFileAsString</span><span class="p">(</span><span class="s">&quot;data.txt&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span><span class="w"></span>
</span><span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">21</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">content1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
</span><span class="hll"><span class="linenos">22</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">content2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">23</span>
<span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;File read successfully!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;File could not be opened!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id209">
<h3>74. C++ 17 中让一个变量拥有多种类型<a class="headerlink" href="#id209" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>基本使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;variant&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 6</span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="c1">// std::cout &lt;&lt; std::get&lt;std::string&gt;(data) &lt;&lt; &quot;\n&quot;; // 这里会泡抛出异常</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>检查变量中存储的类型：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;variant&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="linenos">14</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">15</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>或者：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;variant&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get_if</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">))</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">12</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get_if</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">))</span><span class="w"></span>
</span><span class="linenos">16</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">        </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">18</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>检查变量中存储的类型：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;variant&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w">               </span><span class="c1">// output will be 4</span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w">       </span><span class="c1">// output will be 28</span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w">              </span><span class="c1">// output will be 32</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><cite>variant</cite> 的底层实现有些像类中包含了多个成员变量，没有 <code class="docutils literal notranslate"><span class="pre">unino</span></code> 那样的
高效，但是更安全一些。</p>
</li>
<li><p>其它使用场景</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;variant&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;optional&gt;</span><span class="cp"></span>
</span><span class="linenos"> 4</span>
<span class="hll"><span class="linenos"> 5</span><span class="k">enum</span>  <span class="nc">ErrorCode</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">None</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NorFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NoAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="p">};</span><span class="w"></span>
</span><span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ReadFileAsString</span><span class="p">()</span><span class="w"></span>
</span><span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="c-17-how-to-store-any-data-in-c">
<h3>75. C++ 17 How to store ANY data in C++<a class="headerlink" href="#c-17-how-to-store-any-data-in-c" title="永久链接至标题">¶</a></h3>
<p>浏览的 C++ 源码得知 <code class="docutils literal notranslate"><span class="pre">std::any</span></code> 类型的变量在当存储到其中的数据较小时，使用栈来
存储；当数据较大时，使用堆来存储。作为比较 <code class="docutils literal notranslate"><span class="pre">std::variant</span></code> 则不会存在动态分配内
存的情况，性能可能会好一些。</p>
<ul>
<li><p>常规使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;any&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">any</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//  const char*</span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"> </span><span class="c1">// pay attention to try catch</span>
</span><span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>其他</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;any&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="hll"><span class="linenos"> 4</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="c1">// 兼容性不是很好</span>
</span><span class="hll"><span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">struct</span> <span class="nc">CustomClass</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">any</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">               </span><span class="c1">// use stack</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CustomClass</span><span class="p">();</span><span class="w">   </span><span class="c1">// use heap with big poiner</span>
</span><span class="linenos">19</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">20</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="c-std-async">
<h3>76. 如何让 C++ 运行更快（std-async）<a class="headerlink" href="#c-std-async" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="hll"><span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;future&gt;</span><span class="cp"></span>
</span><span class="linenos"> 3</span>
<span class="hll"><span class="linenos"> 4</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">m_Futures</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 5</span>
<span class="hll"><span class="linenos"> 6</span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">s_MeshMutex</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">LoadMesh</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">s_MeshMutex</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">11</span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">LoadMesh</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">s_MeshMutex</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">16</span><span class="w">    </span><span class="c1">// other operations</span>
<span class="linenos">17</span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">meshFilepaths</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="nl">file</span> <span class="p">:</span><span class="w"> </span><span class="n">meshFilepaths</span><span class="p">)</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">24</span><span class="w">        </span><span class="n">m_Futures</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">launch</span><span class="o">::</span><span class="n">async</span><span class="p">,</span><span class="w"> </span><span class="n">LoadMesh</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">));</span><span class="w"></span>
</span><span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">27</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="c-17-string">
<h3>77. C++ 17 如何让 String 更快<a class="headerlink" href="#c-17-string" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>常规写法</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">s_Allocations</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Allocating &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">firstName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">lastName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; allocations &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Allocating</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Allocating</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Allocating</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Allocating</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Yan</span> <span class="n">Chernikov</span>
<span class="n">Yan</span>
<span class="n">Chernikov</span>
<span class="mi">4</span> <span class="n">allocations</span>
</pre></div>
</div>
<p>四次内存分配发生在第18，20，21和23这几行。</p>
</li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">std::string_view</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">s_Allocations</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Allocating &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">firstName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">lastName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; allocations &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Allocating</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Yan</span> <span class="n">Chernikov</span>
<span class="n">Yan</span>
<span class="n">Chernikov</span>
<span class="mi">1</span> <span class="n">allocations</span>
</pre></div>
</div>
<p>唯一的一次内存分配发生在第18行。</p>
</li>
<li><p>继续优化</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">s_Allocations</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Allocating &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">19</span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="s">&quot;Yan Chernikov&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">firstName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">PrintName</span><span class="p">(</span><span class="n">lastName</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_Allocations</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; allocations &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Yan</span> <span class="n">Chernikov</span>
<span class="n">Yan</span>
<span class="n">Chernikov</span>
<span class="mi">0</span> <span class="n">allocations</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id210">
<h3>78. C++ 中让性能测试可视化<a class="headerlink" href="#id210" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id211">
<h3>79. C++ 中的单例<a class="headerlink" href="#id211" title="永久链接至标题">¶</a></h3>
<p>C++ 中单例类的行为和命名空间的作用类型。</p>
<ul>
<li><p>常规实现</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Singleton</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Get</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="c1">// 禁用拷贝构造函数</span>
<span class="hll"><span class="linenos">12</span><span class="w">    </span><span class="n">Singleton</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">15</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="n">Singleton</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="c1">// 静态实例</span>
<span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="w"> </span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">20</span><span class="p">};</span><span class="w"></span>
<span class="hll"><span class="linenos">21</span><span class="n">Singleton</span><span class="w"> </span><span class="n">Singleton</span><span class="o">::</span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">24</span><span class="p">{</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="c1">// Singleton instance = Singleton::Get(); // 这会复制一个实例 因此需要把拷贝构造函数禁用</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">Singleton</span><span class="o">::</span><span class="n">Get</span><span class="p">().</span><span class="n">Function</span><span class="p">();</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>优化</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Singleton</span><span class="w"></span>
<span class="linenos"> 2</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Get</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">        </span><span class="c1">// 静态实例</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">Singleton</span><span class="w"> </span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">s_Instance</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="c1">// 禁用拷贝构造函数</span>
<span class="linenos">12</span><span class="w">    </span><span class="n">Singleton</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Singleton</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">15</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">Singleton</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">17</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>命名空间</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">namespace</span><span class="w"> </span><span class="nn">RandomClass</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">RandomClass</span><span class="o">::</span><span class="n">Function</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id212">
<h3>80. C++ 中对短字符串的优化<a class="headerlink" href="#id212" title="永久链接至标题">¶</a></h3>
<p>C++ 中，使用 <code class="docutils literal notranslate"><span class="pre">std::stirng</span></code> 时，如果字符串的长度小于等于 15 ，则在 <em>Release</em> 模
式下会存储在栈中，不会进行堆空间内存的分配。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Allocation &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Debug(x86) 模式：
    Allocation 8 bytes
Release(x86) 模式：
    无
</pre></div>
</div>
<p>调整字符串，使其长度大于 15 :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">11</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno small str&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Debug(x86) 模式：
    Allocation 8 bytes（？？？）
    Allocation 32 bytes
Release(x86) 模式：
    Allocation 32 bytes
</pre></div>
</div>
</div>
<div class="section" id="id213">
<h3>81. C++ 中以最简单的方式对内存分配进行跟踪<a class="headerlink" href="#id213" title="永久链接至标题">¶</a></h3>
<p>在 C++ 代码中重写 <code class="docutils literal notranslate"><span class="pre">new</span></code> 操作符，使其替换 STL 中的实现，在链接时被使用，便于断
点调试。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span> <span class="nc">AllocationMetrics</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">TotalAllocated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">TotalFreed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">CurrentUsage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">TotalAllocated</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TotalFreed</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="p">};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="n">AllocationMetrics</span><span class="w"> </span><span class="n">s_AllocationMetrics</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PrintMemoryUsage</span><span class="p">()</span><span class="w"></span>
<span class="linenos">15</span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Memory Usage: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_AllocationMetrics</span><span class="p">.</span><span class="n">CurrentUsage</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;Allocation &quot; &lt;&lt; size &lt;&lt; &quot; bytes\n&quot;;</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">s_AllocationMetrics</span><span class="p">.</span><span class="n">TotalAllocated</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="kt">void</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="linenos">27</span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;Freeing &quot; &lt;&lt; size &lt;&lt; &quot; bytes\n&quot;;</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">s_AllocationMetrics</span><span class="p">.</span><span class="n">TotalFreed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="k">struct</span>  <span class="nc">Object</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="p">};</span><span class="w"></span>
<span class="linenos">37</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">38</span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">PrintMemoryUsage</span><span class="p">();</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cherno&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">PrintMemoryUsage</span><span class="p">();</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">43</span><span class="w">        </span><span class="n">Object</span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">;</span><span class="w"></span>
<span class="linenos">44</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">        </span><span class="n">PrintMemoryUsage</span><span class="p">();</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obj2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="linenos">48</span><span class="w">        </span><span class="n">PrintMemoryUsage</span><span class="p">();</span><span class="w"></span>
<span class="linenos">49</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">50</span><span class="w">    </span><span class="n">PrintMemoryUsage</span><span class="p">();</span><span class="w"></span>
<span class="linenos">51</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">52</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Memory</span> <span class="n">Usage</span><span class="p">:</span> <span class="mi">0</span> <span class="nb">bytes</span>
<span class="n">Memory</span> <span class="n">Usage</span><span class="p">:</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Memory</span> <span class="n">Usage</span><span class="p">:</span> <span class="mi">8</span> <span class="nb">bytes</span>
<span class="n">Memory</span> <span class="n">Usage</span><span class="p">:</span> <span class="mi">20</span> <span class="nb">bytes</span>
<span class="n">Memory</span> <span class="n">Usage</span><span class="p">:</span> <span class="mi">8</span> <span class="nb">bytes</span>
</pre></div>
</div>
</div>
<div class="section" id="id214">
<h3>82. C++ 的左值和右值<a class="headerlink" href="#id214" title="永久链接至标题">¶</a></h3>
<p>C++ 中的左值 ( <cite>lvalue</cite> ) 是指已经分配内存的对象；而右值（ <cite>rvalue</cite> ）是指
尚未为其分配内存的对象。</p>
<p>在类型名后面加一个 <cite>&amp;</cite> 以声明左值类型，加两个 <cite>&amp;</cite> 以声明右值类型，仅在函数的
参数列表中可以使用这两种类型进行声明。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">void</span><span class="w"> </span><span class="nf">Print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4</span><span class="p">{</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="c1">// do something here</span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id215">
<h3>83. C++ 中的持续集成<a class="headerlink" href="#id215" title="永久链接至标题">¶</a></h3>
<p><a class="reference external" href="https://www.jenkins.io/">jenkins</a> <a class="reference external" href="https://www.linode.com/">linode</a></p>
</div>
<div class="section" id="id216">
<h3>84. C++ 中的静态分析<a class="headerlink" href="#id216" title="永久链接至标题">¶</a></h3>
<p><a class="reference external" href="https://pvs-studio.com/en/">PVS-Studio</a></p>
</div>
<div class="section" id="c-evaluation">
<h3>85. C++ 中参数 evaluation 顺序<a class="headerlink" href="#c-evaluation" title="永久链接至标题">¶</a></h3>
<p>C++ 中没有规定参数被 evalueated 的顺序，但在 C++ 17 中规定了 ++i 在 i++ 之
前被 evaluated。</p>
</div>
<div class="section" id="c-move-semantics">
<h3>86. C++ 中的 Move 含义（semantics）<a class="headerlink" href="#c-move-semantics" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>第一版代码</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="k">class</span> <span class="nc">String</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">String</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Constructed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Copied!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">29</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destroyed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">30</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">38</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">39</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">41</span><span class="p">};</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos">44</span><span class="p">{</span><span class="w"></span>
<span class="linenos">45</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="hll"><span class="linenos">47</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">48</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">49</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">()</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">53</span><span class="w">        </span><span class="n">m_Name</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">54</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">57</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">58</span><span class="p">};</span><span class="w"></span>
<span class="linenos">59</span>
<span class="linenos">60</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">61</span><span class="p">{</span><span class="w"></span>
<span class="linenos">62</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">63</span><span class="w">        </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w">    </span><span class="c1">// same as: Entity entity(String(&quot;Cherno&quot;));</span>
</span><span class="linenos">64</span><span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="n">PrintName</span><span class="p">();</span><span class="w"></span>
<span class="linenos">65</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">66</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">67</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Constructed!
Copied!
Destroyed!
Cherno
Destroyed!
</pre></div>
</div>
<ul class="simple">
<li><p><cite>main</cite> 函数中的代码 <code class="docutils literal notranslate"><span class="pre">Entity</span> <span class="pre">entity(&quot;Cherno&quot;);</span></code> 会调用 <code class="docutils literal notranslate"><span class="pre">String::String(const</span> <span class="pre">char*</span> <span class="pre">string)</span></code>
构造函数将参数 <cite>“Cherno”</cite> 进行隐式类型转换；</p></li>
<li><p>然后在调用 <code class="docutils literal notranslate"><span class="pre">Entity::Entity(const</span> <span class="pre">String&amp;</span> <span class="pre">name):</span> <span class="pre">m_Name(name)</span></code>
构造函数时， <code class="docutils literal notranslate"><span class="pre">m_Name(name)</span></code> 会调用 <code class="docutils literal notranslate"><span class="pre">String(const</span> <span class="pre">String&amp;</span> <span class="pre">copiedObject)</span></code>
进行一次拷贝构造（copy construct）。</p></li>
</ul>
</li>
<li><p>第二版代码</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="k">class</span>  <span class="nc">String</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">String</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Constructed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Copied!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span>
<span class="hll"><span class="linenos">27</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="n">String</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">movedObject</span><span class="p">)</span><span class="w"> </span><span class="k">noexcept</span><span class="w"></span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">29</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Moved!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos">30</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">31</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">32</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">        </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">34</span><span class="w">        </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">35</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destroyed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">40</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">45</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">46</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">47</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">48</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">51</span><span class="p">};</span><span class="w"></span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos">54</span><span class="p">{</span><span class="w"></span>
<span class="linenos">55</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">57</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos">58</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">59</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">60</span>
<span class="hll"><span class="linenos">61</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="n">String</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos">62</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="c1">// same as: m_Name((String&amp;&amp;)name)</span>
</span><span class="hll"><span class="linenos">63</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos">64</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">65</span>
<span class="linenos">66</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">()</span><span class="w"></span>
<span class="linenos">67</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">68</span><span class="w">        </span><span class="n">m_Name</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">69</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">72</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">73</span><span class="p">};</span><span class="w"></span>
<span class="linenos">74</span>
<span class="linenos">75</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">76</span><span class="p">{</span><span class="w"></span>
<span class="linenos">77</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">78</span><span class="w">        </span><span class="n">Entity</span><span class="w"> </span><span class="n">entity</span><span class="p">(</span><span class="s">&quot;Cherno&quot;</span><span class="p">);</span><span class="w">    </span><span class="c1">// same as: Entity entity(String(&quot;Cherno&quot;));</span>
<span class="linenos">79</span><span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="n">PrintName</span><span class="p">();</span><span class="w"></span>
<span class="linenos">80</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">81</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">82</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Constructed!
Moved!
Destroyed!
Cherno
Destroyed!
</pre></div>
</div>
<ul class="simple">
<li><p>增加了 move constructor 的实现，相较第一版代码而言，移除了因拷贝构造
带来的内存分配。</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="c-move-move-assigment">
<h3>87. C++ 中的 Move 和 move assigment 操作符<a class="headerlink" href="#c-move-move-assigment" title="永久链接至标题">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">  2</span><span class="k">class</span>  <span class="nc">String</span><span class="w"></span>
<span class="linenos">  3</span><span class="p">{</span><span class="w"></span>
<span class="linenos">  4</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">  5</span><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">  6</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">  7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">  8</span><span class="w">    </span><span class="n">String</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 12</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Constructed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 13</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 14</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 21</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Copied!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 22</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 23</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 24</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">copiedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">,</span><span class="w"> </span><span class="n">m_Size</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="w">    </span><span class="n">String</span><span class="p">(</span><span class="n">String</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">movedObject</span><span class="p">)</span><span class="w"> </span><span class="k">noexcept</span><span class="w"></span>
<span class="linenos"> 28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Moved!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">        </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">        </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="w">        </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">        </span><span class="n">movedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 35</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 36</span>
<span class="hll"><span class="linenos"> 37</span><span class="w">    </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">String</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">asignedObject</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 38</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 39</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Move assigned!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 40</span>
</span><span class="hll"><span class="linenos"> 41</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">asignedObject</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 42</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 43</span><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 44</span>
</span><span class="hll"><span class="linenos"> 45</span><span class="w">            </span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asignedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 46</span><span class="w">            </span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asignedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 47</span>
</span><span class="hll"><span class="linenos"> 48</span><span class="w">            </span><span class="n">asignedObject</span><span class="p">.</span><span class="n">m_Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 49</span><span class="w">            </span><span class="n">asignedObject</span><span class="p">.</span><span class="n">m_Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 50</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 51</span>
</span><span class="hll"><span class="linenos"> 52</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 53</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="o">~</span><span class="n">String</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 56</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Destroyed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 59</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Print</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 62</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 63</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_Size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos"> 66</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 67</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 68</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 69</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="k">class</span>  <span class="nc">Entity</span><span class="w"></span>
<span class="linenos"> 72</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 73</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 74</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 75</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="n">Entity</span><span class="p">(</span><span class="n">String</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">m_Name</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="c1">// same as: m_Name((String&amp;&amp;)name)</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PrintName</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">        </span><span class="n">m_Name</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 90</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">m_Name</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 91</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 94</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 95</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">apple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Apple&quot;</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 96</span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">dest</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Apple: &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="n">apple</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Dest: &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="n">dest</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">102</span>
<span class="hll"><span class="linenos">103</span><span class="w">    </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">apple</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">104</span>
<span class="linenos">105</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Apple: &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="n">apple</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">107</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Dest: &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">108</span><span class="w">    </span><span class="n">dest</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span><span class="w"></span>
<span class="linenos">109</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Constructed!
Apple: Apple
Dest:
Move assigned!
Apple:
Dest: Apple
Destroyed!
Destroyed!
</pre></div>
</div>
</div>
<div class="section" id="c-array">
<h3>88. C++ 中的设计数据结构 -  ARRAY<a class="headerlink" href="#c-array" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>基础使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">heapArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">size</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">heapArray</span><span class="p">[];</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>stl 使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;array&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">&gt;</span><span class="w"> </span><span class="n">collection</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">collection</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="nl">i</span><span class="p">:</span><span class="w"> </span><span class="n">collection</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>自己实现</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="k">class</span>  <span class="nc">Array</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">S</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// constexpr 表示该函数可以编译时被 evaluated， 否则 static_assert 不能正常编译通过</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="p">[](</span><span class="kt">size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">S</span><span class="p">))</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">            </span><span class="n">__debugbreak</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="p">[](</span><span class="kt">size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">S</span><span class="p">))</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">            </span><span class="n">__debugbreak</span><span class="p">();</span><span class="w"></span>
<span class="linenos">25</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_Data</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">Data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">Data</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">m_Data</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">31</span><span class="p">};</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="c1">// following statements can be used since the Size method is been marked with constexpr</span>
<span class="linenos">39</span><span class="w">    </span><span class="c1">// static_assert(data.Size() &lt; 10, &quot;Size is too large!&quot;);</span>
<span class="linenos">40</span><span class="w">    </span><span class="c1">// Array&lt;int, data.Size()&gt; newData;</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Data</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w"> </span><span class="c1">//  same as: memset(&amp;data[0], 0, data.Size() * sizeof(int));</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">50</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">51</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="vector-dynamic-array">
<h3>89. VECTOR DYNAMIC ARRAY - 设计数据结构<a class="headerlink" href="#vector-dynamic-array" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id217">
<h3>90. C++ 中的迭代器<a class="headerlink" href="#id217" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>基础使用</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="nl">value</span> <span class="p">:</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">24</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>扩展</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;unordered_map&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 5</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">ScoreMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">ScoreMap</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">map</span><span class="p">[</span><span class="s">&quot;Cherno&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">map</span><span class="p">[</span><span class="s">&quot;C++&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ScoreMap</span><span class="o">::</span><span class="n">const_local_iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="nl">kv</span> <span class="p">:</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kv</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="c1">// C++ 17 structured binding</span>
<span class="linenos">27</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="linenos">32</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id218">
<h3>91. 在 C++ 中写一个迭代器<a class="headerlink" href="#id218" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id219">
<h3>92. 如何学习 C++<a class="headerlink" href="#id219" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="stl">
<h2>STL 源码剖析<a class="headerlink" href="#stl" title="永久链接至标题">¶</a></h2>
<div class="section" id="id220">
<h3>第一章 STL 概论与版本简介<a class="headerlink" href="#id220" title="永久链接至标题">¶</a></h3>
<p>测试当前编译器中使用的 STL 实现版本中的 GCC 常量设定：</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id291">
<div class="code-block-caption"><span class="caption-text">lconfig.cpp</span><a class="headerlink" href="#id291" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="cp">#if defined(__sgi)</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__sgi&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="cp">#endif</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#if defined(__GNUC__)</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__GNUC__&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">__GNUC__</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">__GNUC_MINOR__</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">__GLIBC__</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="cp">#endif</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="c1">// case 2</span>
<span class="linenos">15</span><span class="cp">#ifdef __STL_NO_DRAND48</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_NO_DRAND48 defined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="cp">#else</span>
<span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_NO_DRAND48 undefined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="cp">#endif</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="c1">// case 3</span>
<span class="linenos">22</span><span class="cp">#ifdef __STL_STATIC_TEMPLATE_MEMBER_BUG</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_STATIC_TEMPLATE_MEMBER_BUG defined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="cp">#else</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_STATIC_TEMPLATE_MEMBER_BUG undefined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="cp">#endif</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">    </span><span class="c1">// case 5</span>
<span class="linenos">29</span><span class="cp">#ifdef __STL_CLASS_PARTIAL_SPECIALIZATION</span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_CLASS_PARTIAL_SPECIALIZATION defined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="cp">#else</span>
<span class="linenos">32</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__STL_CLASS_PARTIAL_SPECIALIZATION undefined&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="cp">#endif</span>
<span class="linenos">34</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<div class="section" id="id221">
<h4>可能令你困惑的 C++ 语法<a class="headerlink" href="#id221" title="永久链接至标题">¶</a></h4>
<p>stl_config.h 中的各种组态（congigurations）</p>
<ul>
<li><p>组态3： <code class="docutils literal notranslate"><span class="pre">__STL_STATIC_TEMPLATE_MEMBER_BUG</span></code></p>
<div class="literal-block-wrapper docutils container" id="id292">
<div class="code-block-caption"><span class="caption-text">lconfig3.cpp</span><a class="headerlink" href="#id292" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 测试在 class template 中拥有 static member.</span>
<span class="linenos"> 2</span><span class="c1">// vc6[o] cb4[x] gcc[o]</span>
<span class="linenos"> 3</span><span class="c1">// cb4 does not support static data member initialization.</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">class</span> <span class="nc">testClass</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_data</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="c1">// 为 static data member 进行定义（配置内存），并设初值</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="kt">int</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">// 以下，CB4 表现不佳，没有接受初值设定</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">        </span><span class="c1">// GCC, VC6:1 CB4:0</span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">       </span><span class="c1">// GCC, VC6:2 CB4:0</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obji1</span><span class="p">,</span><span class="w"> </span><span class="n">obji2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objc1</span><span class="p">,</span><span class="w"> </span><span class="n">objc2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obji1</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:1 CB4:0</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obji2</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:1 CB4:0</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objc1</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:2 CB4:0</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objc2</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:2 CB4:0</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">    </span><span class="n">obji1</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">objc2</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obji1</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:3 CB4:3</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obji2</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:3 CB4:3</span>
<span class="linenos">36</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objc1</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:4 CB4:4</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objc2</span><span class="p">.</span><span class="n">_data</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">          </span><span class="c1">// GCC, VC6:4 CB4:4</span>
<span class="linenos">38</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>组态5： <code class="docutils literal notranslate"><span class="pre">__STL_CLASS_PARTIAL_SPECIALIZATION</span></code></p>
<div class="literal-block-wrapper docutils container" id="id293">
<div class="code-block-caption"><span class="caption-text">lconfig5.cpp</span><a class="headerlink" href="#id293" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 测试 class template partial specialization —— 在 class template 的</span>
<span class="linenos"> 2</span><span class="c1">// 一般化设计之外，特别针对某些 template 参数做特殊设计</span>
<span class="linenos"> 3</span><span class="c1">// vc6[x] cb4[o] gcc[o]</span>
<span class="linenos"> 4</span><span class="c1">// cb4 does not support static data member initialization.</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c1">// 一般化设计</span>
<span class="linenos"> 8</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">O</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="k">struct</span> <span class="nc">testClass</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">testClass</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;I, O&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1">// 特殊化设计</span>
<span class="linenos">15</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">16</span><span class="k">struct</span> <span class="nc">testClass</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
</span><span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">testClass</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;T*, T*&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">19</span><span class="p">};</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="c1">// 特殊化设计</span>
<span class="linenos">22</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">23</span><span class="k">struct</span> <span class="nc">testClass</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
</span><span class="linenos">24</span><span class="p">{</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">testClass</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;const T*, T*&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="p">};</span><span class="w"></span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">29</span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obj1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">obj2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">testClass</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">obj3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>组态6： <code class="docutils literal notranslate"><span class="pre">__STL_CLASS_PARTIAL_SPECIALIZATION</span></code></p>
<div class="literal-block-wrapper docutils container" id="id294">
<div class="code-block-caption"><span class="caption-text">lconfig6.cpp</span><a class="headerlink" href="#id294" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// vc6[x] cb4[o] gcc[o]</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">alloc</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">class</span> <span class="nc">Vector</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">swap</span><span class="p">(</span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;swap()&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="cp">#ifdef   __STL_FUNCTION_TMPL_PARTIAL_ORDER      </span><span class="c1">// 只为说明，非本程序内容</span>
<span class="linenos">14</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">15</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">swap</span><span class="p">(</span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
<span class="linenos">19</span><span class="cp">#endif </span><span class="c1">//  __STL_FUNCTION_TMPL_PARTIAL_ORDER</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="c1">// 以上代码节选自 stl_vector.h，为条件编译吧部分的代码，非本测试程序的内容</span>
<span class="linenos">22</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="linenos">26</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>组态8： <code class="docutils literal notranslate"><span class="pre">__STL_MEMBER_TEMPLATES</span></code></p>
<div class="literal-block-wrapper docutils container" id="id295">
<div class="code-block-caption"><span class="caption-text">lconfig8.cpp</span><a class="headerlink" href="#id295" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 测试 template 之内可否再有 template (members)</span>
<span class="linenos"> 2</span><span class="c1">// vc6[o] cb4[o] gcc[o]</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">alloc</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="hll"><span class="linenos"> 7</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="k">class</span> <span class="nc">vector</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">value_type</span><span class="o">*</span><span class="w"> </span><span class="n">iterator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">15</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos">16</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">iterator</span><span class="w"> </span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;insert()&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span><span class="p">};</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ia</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">ite</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ite</span><span class="p">,</span><span class="w"> </span><span class="n">ia</span><span class="p">,</span><span class="w"> </span><span class="n">ia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>组态10： <code class="docutils literal notranslate"><span class="pre">__STL_LIMITED_DEFAULT_TEMPLATES</span></code></p>
<div class="literal-block-wrapper docutils container" id="id296">
<div class="code-block-caption"><span class="caption-text">lconfig10.cpp</span><a class="headerlink" href="#id296" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 测试 template 参数可否根据前一个 template 参数而设定默认值</span>
<span class="linenos"> 2</span><span class="c1">// vc6[o] cb4[o] gcc[o]</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">alloc</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="hll"><span class="linenos"> 7</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">BufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="k">class</span> <span class="nc">deque</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">deque</span><span class="p">()</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;deque&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="c1">// 根据前一个参数值T，设定下一个参数 Sequence 的默认值 deque&lt;T&gt;</span>
<span class="hll"><span class="linenos">18</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"></span>
</span><span class="linenos">19</span><span class="k">class</span> <span class="nc">stack</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">stack</span><span class="p">()</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;stack&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="n">Sequence</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="p">};</span><span class="w"></span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">31</span><span class="p">{</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="n">stack</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">   </span><span class="c1">// deque</span>
<span class="linenos">33</span><span class="w">                    </span><span class="c1">// stack</span>
<span class="linenos">34</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>组态11： <code class="docutils literal notranslate"><span class="pre">__STL_NONE_TYPE_TMPL_PARAM_BUG</span></code></p>
<div class="literal-block-wrapper docutils container" id="id297">
<div class="code-block-caption"><span class="caption-text">lconfig11.cpp</span><a class="headerlink" href="#id297" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 测试 class template 可否拥有 none-type template 参数</span>
<span class="linenos"> 2</span><span class="c1">// vc6[o] cb4[o] gcc[o]</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">alloc</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">__deque_buf_size</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">n</span> <span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="mi">512</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="linenos">10</span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="hll"><span class="linenos">12</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Ref</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">BufSize</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos">13</span><span class="k">struct</span> <span class="nc">__deque_iterator</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__deque_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BufSize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iterator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__deque_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BufSize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">const_iterator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">buffer_size</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">__deque_buf_size</span><span class="p">(</span><span class="n">BufSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">19</span><span class="p">};</span><span class="w"></span>
<span class="linenos">20</span>
<span class="hll"><span class="linenos">21</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">BufSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos">22</span><span class="k">class</span> <span class="nc">deque</span><span class="w"></span>
<span class="linenos">23</span><span class="p">{</span><span class="w"></span>
<span class="linenos">24</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__deque_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BufSize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iterator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="p">};</span><span class="w"></span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">29</span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">deque</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="o">::</span><span class="n">buffer_size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">                  </span><span class="c1">// 128</span>
<span class="linenos">31</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">deque</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="o">::</span><span class="n">buffer_size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">       </span><span class="c1">// 64</span>
<span class="linenos">32</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
</ul>
</div>
<div class="section" id="id222">
<h4>临时对象的产生与运用<a class="headerlink" href="#id222" title="永久链接至标题">¶</a></h4>
<p>所谓临时对象，就是一种无名对象（unnamed objects）。</p>
<ul>
<li><p>如果不在预期之下出现，往往造成效率上的负担。</p>
<p>例如任何 pass by value 操作都会引发 copy 操作，于是形成一个临时对象</p>
</li>
<li><p>刻意制造临时对象，使程序干净清爽。</p>
<p>方法是在类型名称之后直接加一对小括号，并可指定初值，例如 shape(3,5) 或 int (8),
其意义相当与调用相应的 constructor 且不指定对象名称。</p>
<p>STL 最常将此技巧应用于仿函数与算法的搭配上，例如：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// 本例测试仿函数用于 for_each 的情形</span>
<span class="linenos"> 2</span><span class="c1">// vc6[o] cb4[o] gcc[o]</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="k">class</span>  <span class="nc">print</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">elem</span><span class="p">)</span><span class="w"> </span><span class="c1">// operator() 重载</span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">16</span><span class="p">};</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">19</span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ia</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iv</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span><span class="w"> </span><span class="n">ia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="n">for_each</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">print</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
</span><span class="linenos">23</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="class">
<h4>静态常量整数成员在 class 内部直接初始化<a class="headerlink" href="#class" title="永久链接至标题">¶</a></h4>
<p>如果 class 内含 const static intefral data member， 那么根据 C++ 标准规范，我们
可以在 class 之内直接赋初值。所谓 integral 泛指所有整数类型，不单只是指 int 。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// vc6[x] cb4[o] gcc[o]</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">class</span>  <span class="nc">testClass</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_datai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_datal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3L</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="linenos">10</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">_datac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">11</span><span class="p">};</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_datai</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">   </span><span class="c1">// 5</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_datal</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">   </span><span class="c1">// 3</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">testClass</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_datac</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">   </span><span class="c1">// c</span>
<span class="linenos">18</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="increment-decrement-dereference">
<h4>increment / decrement / dereference 操作符<a class="headerlink" href="#increment-decrement-dereference" title="永久链接至标题">¶</a></h4>
<p>increment / dereference 操作符在迭代器的实现上占有非常重要的地位，因为i任何一个
迭代器都必须实现出前进（ <strong>increment</strong> , operator++ ）和取值（ <strong>dereference</strong> , operator* ）功能，
前者还分为前置式和后置式两种。有些迭代器具备双向移动的功能，那么就必须再提供
decrement 操作符（也分前置式和后置式两种）。下面是一个示例：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// vc6[x] cb4[o] gcc[o]</span>
<span class="linenos"> 2</span><span class="c1">// vc6 的 friend 机制搭配 C++ 标准程序库，有 bug</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">INT</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">INT</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="n">m_i</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="c1">// prefix: increment and then fetch</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">++</span><span class="p">()</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="o">++</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_i</span><span class="p">);</span><span class="w">      </span><span class="c1">// 随着 class 的不同，该行应该有不同的操作</span>
<span class="linenos">16</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="c1">// postfix: fetch and then increment</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="n">INT</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="o">++</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">    </span><span class="c1">// prefix: decrement and then fetch</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">--</span><span class="p">()</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">29</span><span class="w">        </span><span class="o">--</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_i</span><span class="p">);</span><span class="w">      </span><span class="c1">// 随着 class 的不同，该行应该有不同的操作</span>
<span class="linenos">30</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="c1">// postfix: fetch and then decrement</span>
<span class="linenos">33</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">--</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">        </span><span class="n">INT</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="o">--</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">37</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="c1">// dereference</span>
<span class="linenos">41</span><span class="w">    </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">43</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="p">)</span><span class="n">m_i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">44</span><span class="w">        </span><span class="c1">// 以上转换操作告诉编译器，你确实要将 从 const int 转为 non-const lvalue.</span>
<span class="linenos">45</span><span class="w">        </span><span class="c1">// 如果没有这样显示地转型，有些编译器会给你警告，有些更严格的编译器会视为错误</span>
<span class="linenos">46</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">47</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">49</span><span class="p">};</span><span class="w"></span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">INT</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">52</span><span class="p">{</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">m_i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;]&#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">54</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">os</span><span class="p">;</span><span class="w"></span>
<span class="linenos">55</span><span class="p">}</span><span class="w"></span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">58</span><span class="p">{</span><span class="w"></span>
<span class="linenos">59</span><span class="w">    </span><span class="n">INT</span><span class="w"> </span><span class="nf">I</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">60</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="nf">J</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="o">++</span><span class="p">;</span><span class="w">   </span><span class="c1">// [5]</span>
<span class="linenos">62</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">;</span><span class="w">   </span><span class="c1">// [7]</span>
<span class="linenos">63</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="o">--</span><span class="p">;</span><span class="w">   </span><span class="c1">// [7]</span>
<span class="linenos">64</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">--</span><span class="n">I</span><span class="p">;</span><span class="w">   </span><span class="c1">// [5]</span>
<span class="linenos">65</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">;</span><span class="w">    </span><span class="c1">// 5</span>
<span class="linenos">66</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id223">
<h4>前闭后开区间表示法 [)<a class="headerlink" href="#id223" title="永久链接至标题">¶</a></h4>
<p>任何一个 STL 算法，都需要获得由一对迭代器（泛型指针）所标示的区间，用以表示操作
范围。这一迭代器所标示的是个所谓的前闭后开区间，以[first,last)表示。也就是说，整
个实际范围从 first 开始，直到 last-1。如下两个 STL 算法的循环设计，就显得干净利落：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 2</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">InputIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="n">wihle</span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">first</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">++</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Function</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="n">Function</span><span class="w"> </span><span class="n">for_each</span><span class="p">(</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">InputIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">first</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="fucntion-call-operator">
<h4>fucntion call 操作符 （operator ()）<a class="headerlink" href="#fucntion-call-operator" title="永久链接至标题">¶</a></h4>
<p>很少有人注意到，函数调用操作（C++ 语法中的左右小括号）也可以被重载。</p>
<p>许多 STL 算法都提供了两个版本，一个用于一般状况（例如排序时以递增方式排序），一
个用于特殊状况（例如排序时由使用者指定以何种特殊关系进行排序）。像这种情况，需要
用户指定某个条件或某个策略，而条件或策略的背后由一整组操作构成，便需要某种特殊的
东西来代表这“一整组操作”。</p>
<p>代表“一整组操作”的，当然是函数。过去 C 语言时代，欲将函数当作参数传递，唯有通过
函数指针才能达成。</p>
<p>但是函数指针由缺点，最重要的时他无法持有自己的状态（所欸局部状态，local states），
也无法达到组件技术中的可适配性（adaptability）—— 也就是无法再将某些修饰条件加诸
于其上而改变其状态。</p>
<p>为此，STL 算法的特殊版本所接受的所谓“条件”或“策略”或“一整组操作”，都以仿函数形式
呈现。所谓仿函数（functor）就是使用起来像函数一样的东西。如果你针对某个 class 进
行 operator() 重载，它就成为一个仿函数。至于要成为一个可配接的仿函数，还需要做一
些额外的努力。</p>
<p>下面是一个将 operator() 重载的例子：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">// 由于将 operator() 重载了，因此 plus 成了一个仿函数</span>
<span class="linenos"> 4</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">struct</span> <span class="nc">plus</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="nf">operator</span><span class="p">()(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="c1">// 由于将 operator() 重载了，因此 minus 成了一个仿函数</span>
<span class="linenos">11</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">12</span><span class="k">struct</span> <span class="nc">minus</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">14</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="nf">operator</span><span class="p">()(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">15</span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">// 以下产生仿函数对象</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">plusobj</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">minus</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">minusobj</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="c1">// 以下使用仿函数，就像使用一般函数一样</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">plusobj</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">            </span><span class="c1">// 8</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">minusobj</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">           </span><span class="c1">// -2</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="c1">// 以下直接产生仿函数临时对象（第一对小括号），并调用之（第二对小括号）</span>
<span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">()(</span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">      </span><span class="c1">//93</span>
</span><span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">minus</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">()(</span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w">     </span><span class="c1">// -7</span>
</span><span class="linenos">30</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id224">
<h3>第二章 空间配置器<a class="headerlink" href="#id224" title="永久链接至标题">¶</a></h3>
<p>空间配置器是 STL 实现过程中所必须的，因为整个 STL 的操作对象（所有的数值）都
存放在容器之内，而容器一定需要配置空间以放置资料。</p>
<p>之所以说是空间配置器而不是内存配置器，是因为需要分配的空间不一定是内存，也可
以是磁盘或其它辅助存储介质。</p>
<div class="section" id="id225">
<h4>2.1 空间配置器的标准接口<a class="headerlink" href="#id225" title="永久链接至标题">¶</a></h4>
<p>根据 STL 的规范，以下是 allocator 的必要接口：</p>
<blockquote>
<div><ol class="arabic">
<li><p>allocator::value_type</p></li>
<li><p>allocator::pointer</p></li>
<li><p>allocator::const_pointer</p></li>
<li><p>allocator::reference</p></li>
<li><p>allocator::const_reference</p></li>
<li><p>allocator::size_type</p></li>
<li><p>allocator::difference_type</p></li>
<li><p>allocator::rebind</p>
<p>一个嵌套的 class template, class rebind&lt;U&gt; 拥有唯一的成员 other，
那是一个 typedef ，代表 allocator&lt;U&gt;</p>
</li>
<li><p>allocator::allocator()</p>
<p>default constructor</p>
</li>
<li><p>allocator::allocator(const allocator&amp;)</p>
<p>copy constructor</p>
</li>
<li><p>template &lt;class U&gt; allocator::allocator(const allocator&lt;U&gt;&amp;)</p>
<p>泛化的 copy constructor</p>
</li>
<li><p>allocator::~allocator()</p>
<p>default deconstructor</p>
</li>
<li><p>pointer allocator::address(reference x) const</p>
<p>返回某个对象的地址。算式 a.address(x) 等同于 &amp;x</p>
</li>
<li><p>const_pointer allocator::address(const_reference x) const</p>
<p>返回某个 const 对象的地址。算式 a.address(x) 等同于 &amp;x</p>
</li>
<li><p>pointer allocator::allocate(size_type n, const void* = 0)</p>
<p>配置空间，足以存储 n 个 T 对象。第二个参数是个提示，实现上可能会利用
它来增进区域性（locality），或完全忽略之</p>
</li>
<li><p>void allocator::deallocate(pointer p, size_type n)</p>
<p>归还先前配置的空间</p>
</li>
<li><p>size_type allocator::max_size() const</p>
<p>返回可成功配置的最大量</p>
</li>
<li><p>void allocator::construct(pointer p, const T&amp; x)</p>
<p>等同于 new(const void*) p) T(x)</p>
</li>
<li><p>void allocator::destroy(pointer p)</p>
<p>等同于 p-&gt;~T()</p>
</li>
</ol>
</div></blockquote>
<div class="section" id="jj-alocator">
<h5>2.1.1 设计一个简单的空间配置器，JJ::alocator<a class="headerlink" href="#jj-alocator" title="永久链接至标题">¶</a></h5>
<div class="literal-block-wrapper docutils container" id="id298">
<div class="code-block-caption"><span class="caption-text">2jjalloc.h</span><a class="headerlink" href="#id298" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#pragma once</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="cpf">&lt;new&gt;</span><span class="c1">       // for placement new</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="cpf">&lt;cstddef&gt;</span><span class="c1">   // for ptrdiff_t, size_t</span><span class="cp"></span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="cpf">&lt;cstdlib&gt;</span><span class="c1">   // for exit()</span><span class="cp"></span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="cpf">&lt;climits&gt;</span><span class="c1">   // for UNIT_MAX</span><span class="cp"></span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="c1">  // for cerr</span><span class="cp"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">namespace</span><span class="w"> </span><span class="nn">JJ</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">_allocate</span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set_new_handler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="p">)(</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">))));</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">17</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;out of memory&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">_deallocate</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">delete</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T1</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">T2</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">_construct</span><span class="p">(</span><span class="n">T1</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">T1</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">  </span><span class="c1">// placement new. invoke ctor of T1</span>
<span class="linenos">34</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">_destroy</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">        </span><span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">T</span><span class="p">();</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="k">class</span> <span class="nc">allocator</span><span class="w"></span>
<span class="linenos">43</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">45</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">47</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">const_pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">48</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">const_reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">50</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">51</span><span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">        </span><span class="c1">// rebind allocator of type U</span>
<span class="linenos">56</span><span class="w">        </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">57</span><span class="w">        </span><span class="k">struct</span> <span class="nc">rebind</span><span class="w"></span>
</span><span class="linenos">58</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">59</span><span class="w">            </span><span class="k">typedef</span><span class="w"> </span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">;</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="w">        </span><span class="c1">// hint used for locality. ref.[Austern],p189</span>
<span class="hll"><span class="linenos">63</span><span class="w">        </span><span class="n">pointer</span><span class="w"> </span><span class="nf">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">64</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">65</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">_allocate</span><span class="p">((</span><span class="n">difference_type</span><span class="p">)</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">66</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">67</span>
<span class="hll"><span class="linenos">68</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">construct</span><span class="p">(</span><span class="n">pointer</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">69</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">70</span><span class="w">            </span><span class="n">_construct</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="linenos">71</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">72</span>
<span class="hll"><span class="linenos">73</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">(</span><span class="n">pointer</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_destroy</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">74</span>
<span class="hll"><span class="linenos">75</span><span class="w">        </span><span class="n">pointer</span><span class="w"> </span><span class="nf">address</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">76</span>
<span class="hll"><span class="linenos">77</span><span class="w">        </span><span class="n">const_pointer</span><span class="w"> </span><span class="nf">const_address</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">const_pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos">78</span>
<span class="hll"><span class="linenos">79</span><span class="w">        </span><span class="n">size_type</span><span class="w"> </span><span class="nf">max_size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
</span><span class="linenos">80</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">81</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">size_type</span><span class="p">(</span><span class="n">UINT_MAX</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span><span class="w"></span>
<span class="linenos">82</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">83</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">84</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>将 JJ::allocator 应用与程序之中，我们发现，它只能有限度地搭配 PJ STL 和 RW STL ，例如：</p>
<div class="literal-block-wrapper docutils container" id="id299">
<div class="code-block-caption"><span class="caption-text">2jjalloc.cpp</span><a class="headerlink" href="#id299" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// vc6[o] BCB4[o] GCC2.9[x]</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;2jjalloc.h&quot;</span><span class="cp"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 7</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ia</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">JJ</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">iv</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span><span class="w"> </span><span class="n">ia</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">10</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>“只能有限度搭配 PJ STL”是因为，PJ STL 未完全遵循 STL 规范，其所供应的许多容
器都需要一个非标准的空间配置接口 allocator::_Charalloc()。</p>
<p>“只能有限度地搭配 RW STL”则是因为，RW STL 在很多容器身上运用了缓冲区，情况复
杂得多，JJ::allocator 无法与之兼容。</p>
<p>至于完全无法应用于 SGI STL，是因为 SGI STL 在这个项目上根本逸脱了 STL 标准
规范，使用一个专属的、拥有次层配置（sub-allocation）能力的、效率优越的特殊配
置器，稍后有详细介绍。</p>
<p>事实上，SGI STL 仍然提供了一个标准的配置器接口，只是把它做了一层隐藏。这个标
准接口的配置器名为 simple_alloc，稍后便会提到。</p>
</div>
</div>
<div class="section" id="sub-allocation-sgi">
<h4>2.2 具备次层配置力（sub-allocation）的 SGI 空间配置器<a class="headerlink" href="#sub-allocation-sgi" title="永久链接至标题">¶</a></h4>
<p>SGI STL 的配置器与众不同，也与标准规范不同，其名称是 alloc 而非 allocator，
而且不接受任何参数。换句话说，如果你要在程序中显示采用 SGI 配置器，则不能采
用标准写法：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span><span class="w">    </span><span class="c1">// in VC or CB</span>
</pre></div>
</div>
</div></blockquote>
<p>必须这么写：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">alloc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span><span class="w">             </span><span class="c1">// in GCC</span>
</pre></div>
</div>
</div></blockquote>
<p>SGI STL allocator 未能符合标准规范，这个事实通常不会给我们带来困扰，因为通
常我们使用缺省的空间配置器，很少有需要自行指定配置器名称，而 SGI STL 的每一
个容器都已经指定其缺省的空间配置器为 alloc 。例如下面的 vector 声明：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="o">&gt;</span><span class="w"> </span><span class="c1">// 缺省使用 alloc 为配置器</span>
<span class="k">class</span> <span class="nc">vector</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="sgi-std-allocator">
<h5>2.2.1 SGI 标准的空间配置器， std::allocator<a class="headerlink" href="#sgi-std-allocator" title="永久链接至标题">¶</a></h5>
<p>虽然 SGI 也定义有一个符合部分标准、名称 allocator 的配置器，但 SGI 自己从未
使用过它，也不建议我们使用。主要原因是效率不佳，只是把 C++ 的 operator:: new
和 ::operator delete 做一层薄薄的包装而已。下面是 SGI 的 std::allocator
全貌：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#ifndef DEFALLOC_H</span>
<span class="linenos"> 2</span><span class="cp">#define DEFALLOC_H</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="cpf">&lt;new.h&gt;</span><span class="cp"></span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="cpf">&lt;stddef.h&gt;</span><span class="cp"></span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="cpf">&lt;iostream.h&gt;</span><span class="cp"></span>
<span class="linenos"> 9</span><span class="cp">#include</span><span class="cpf">&lt;algobase.h&gt;</span><span class="cp"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">12</span><span class="kr">inline</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">13</span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">set_new_handler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="p">)(</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">))));</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">18</span><span class="w">        </span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;out of memory&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">25</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"></span>
<span class="linenos">26</span><span class="p">{</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">delete</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="linenos">28</span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">31</span><span class="k">class</span> <span class="nc">allocator</span><span class="w"></span>
<span class="linenos">32</span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">34</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">const_pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">const_reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">43</span><span class="w">    </span><span class="n">pointer</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">44</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">45</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">::</span><span class="n">allocate</span><span class="p">((</span><span class="n">difference_type</span><span class="p">)</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">47</span>
<span class="hll"><span class="linenos">48</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">49</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">50</span><span class="w">        </span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="linenos">51</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">52</span>
<span class="hll"><span class="linenos">53</span><span class="w">    </span><span class="n">pointer</span><span class="w"> </span><span class="n">address</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">54</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">55</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">57</span>
<span class="hll"><span class="linenos">58</span><span class="w">    </span><span class="n">const_pointer</span><span class="w"> </span><span class="n">address</span><span class="p">(</span><span class="n">const_reference</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">59</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">const_pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">62</span>
<span class="hll"><span class="linenos">63</span><span class="w">    </span><span class="n">size_type</span><span class="w"> </span><span class="n">init_page_size</span><span class="p">()</span><span class="w"></span>
</span><span class="linenos">64</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">65</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">size_type</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">size_type</span><span class="p">(</span><span class="mi">4096</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)));</span><span class="w"></span>
<span class="linenos">66</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">67</span>
<span class="hll"><span class="linenos">68</span><span class="w">    </span><span class="n">size_type</span><span class="w"> </span><span class="n">max_size</span><span class="p">()</span><span class="w"></span>
</span><span class="linenos">69</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">70</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">size_type</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">size_type</span><span class="p">(</span><span class="n">UINT_MAX</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)));</span><span class="w"></span>
<span class="linenos">71</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">72</span><span class="p">};</span><span class="w"></span>
<span class="linenos">73</span>
<span class="linenos">74</span><span class="c1">// 特化版本（specialization）。注意，为什么最前面不需要加上 template&lt;&gt;?</span>
<span class="linenos">75</span><span class="c1">// 见 1.9.1 节的状态测试。注意，只适用于 GCC</span>
<span class="hll"><span class="linenos">76</span><span class="k">class</span> <span class="nc">allocator</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"></span>
</span><span class="linenos">77</span><span class="p">{</span><span class="w"></span>
<span class="linenos">78</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos">79</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">80</span><span class="p">};</span><span class="w"></span>
<span class="linenos">81</span><span class="cp">#endif</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="sgi-std-alloc">
<h5>2.2.2 SGI 特殊的空间配置器， std::alloc<a class="headerlink" href="#sgi-std-alloc" title="永久链接至标题">¶</a></h5>
<p>一般而言，我们所习惯的 C++ 内存配置操作和释放操作是这样的：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="n">Foo</span><span class="o">*</span><span class="w"> </span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Foo</span><span class="p">;</span><span class="w">      </span><span class="c1">// 配置内存，然后构造对象</span>
<span class="k">delete</span><span class="w"> </span><span class="n">pf</span><span class="p">;</span><span class="w">              </span><span class="c1">// 将对象析构，然后释放内存</span>
</pre></div>
</div>
</div></blockquote>
<p>这其中的 <code class="docutils literal notranslate"><span class="pre">new</span></code> 算式内含两阶段操作：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>调用 <cite>::operator new</cite> 配置内存；</p></li>
<li><p>调用 <cite>Foo::Foo()</cite> 构造对象内容。</p></li>
</ol>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">delete</span></code> 算式也含两阶段操作：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>调用 <cite>Foo::~Foo()</cite> 将对象析构；</p></li>
<li><p>调用 <cite>::operator delete</cite> 释放内存。</p></li>
</ol>
</div></blockquote>
<p>为了精密分工，STL allocator 决定将这两阶段操作区分开来。内存配置操作由
<cite>alloc::allocate()</cite> 负责，内存释放操作由 <cite>alloc::deallocate()</cite> 负责；
对象构造操作由 <cite>::constructor()</cite> 负责，对象析构操作由 <cite>::destroy()</cite> 负责。</p>
<p>STL 标准规范告诉我们，配置器定义于 <cite>&lt;memory&gt;</cite> 之中，SGI <cite>&lt;memory&gt;</cite> 内含以
下两个文件：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;stl_alloc.h&gt;</span><span class="c1">       // 负责内存空间的配置与释放</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;stl_construct.h&gt;</span><span class="c1">   // 负责对象内容的构造与析构</span><span class="cp"></span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="construct-destroy">
<h5>2.2.3 构造和析构基本工具： construct() 和 destroy()<a class="headerlink" href="#construct-destroy" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="std-alloc">
<h5>2.2.4 空间的配置与释放，std::alloc<a class="headerlink" href="#std-alloc" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="malloc-alloc-template">
<h5>2.2.5 第一级配置器 __malloc_alloc_template 剖析<a class="headerlink" href="#malloc-alloc-template" title="永久链接至标题">¶</a></h5>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#if 0</span><span class="c"></span>
<span class="linenos"> 2</span><span class="c">#include&lt;new&gt;</span>
<span class="linenos"> 3</span><span class="c">#define __THROW_BAD_ALLOC throw bad_alloc</span>
<span class="linenos"> 4</span><span class="cp">#elif !defined(__THROW_BAD_ALLOC)</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 6</span><span class="cp">#define __THROW_BAD_ALLOC std::cerr &lt;&lt; &quot;out of memory&quot; &lt;&lt; std::endl; exit(1)</span>
<span class="linenos"> 7</span><span class="cp">#endif </span><span class="c1">// 0</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">10</span><span class="k">class</span> <span class="nc">__malloc_alloc_template</span><span class="w"></span>
<span class="linenos">11</span><span class="p">{</span><span class="w"></span>
<span class="linenos">12</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="c1">// 以下函数将用来处理内存不足的情况</span>
<span class="linenos">14</span><span class="w">    </span><span class="c1">// oom: out of memory</span>
<span class="linenos">15</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">oom_remalloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">)();</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">21</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">      </span><span class="c1">// 第一级配置器直接使用 malloc()</span>
<span class="linenos">23</span><span class="w">        </span><span class="c1">// 以下无法满足需求时，改用 oom_malloc()</span>
<span class="linenos">24</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="linenos">25</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oom_malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="linenos">27</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span>
<span class="hll"><span class="linenos">31</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="cm">/*n*/</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">32</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w">       </span><span class="c1">// 第一级配置器直接使用 free()</span>
<span class="linenos">34</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">35</span>
<span class="hll"><span class="linenos">36</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">reallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="cm">/*old_sz*/</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">new_sz</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">37</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">38</span><span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_sz</span><span class="p">);</span><span class="w">      </span><span class="c1">// 第一级配置器直接使用 remalloc()</span>
<span class="linenos">39</span><span class="w">        </span><span class="c1">// 以下无法满足需求时，改用 oom_remalloc()</span>
<span class="linenos">40</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="linenos">41</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos">42</span><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oom_remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_sz</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">44</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="c1">// 以下模仿 C++ 的 set_new_handler()。换句话说，你可以通过它</span>
<span class="linenos">48</span><span class="w">    </span><span class="c1">// 指定你自己的 out-of-memory handler</span>
<span class="hll"><span class="linenos">49</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">set_malloc_handler</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)()))()</span><span class="w"></span>
</span><span class="linenos">50</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">51</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">old</span><span class="p">)()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
<span class="linenos">52</span><span class="w">        </span><span class="n">__malloc_alloc_oom_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">53</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="p">);</span><span class="w"></span>
<span class="linenos">54</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">55</span><span class="p">};</span><span class="w"></span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="c1">// malloc_alloc out-of-memory handling</span>
<span class="linenos">58</span><span class="c1">// 初值为0。有待客户端设定</span>
<span class="linenos">59</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">60</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">)()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">61</span>
<span class="linenos">62</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">63</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">64</span><span class="p">{</span><span class="w"></span>
<span class="linenos">65</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w"></span>
<span class="linenos">66</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">67</span>
<span class="linenos">68</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w">        </span><span class="c1">// 不断尝试释、配置、再释放、再配置...</span>
<span class="linenos">69</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">70</span><span class="w">        </span><span class="n">my_malloc_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
<span class="linenos">71</span>
<span class="linenos">72</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">73</span>
<span class="linenos">74</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w">     </span><span class="c1">// 调用处理例程，企图释放内存</span>
<span class="linenos">75</span><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">         </span><span class="c1">// 再次尝试配置内存</span>
<span class="linenos">76</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos">77</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">78</span><span class="p">}</span><span class="w"></span>
<span class="linenos">79</span>
<span class="linenos">80</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">81</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_remalloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">82</span><span class="p">{</span><span class="w"></span>
<span class="linenos">83</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w"></span>
<span class="linenos">84</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos">85</span>
<span class="linenos">86</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w">        </span><span class="c1">// 不断尝试释、配置、再释放、再配置...</span>
<span class="linenos">87</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">88</span><span class="w">        </span><span class="n">my_malloc_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
<span class="linenos">89</span>
<span class="linenos">90</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">91</span>
<span class="linenos">92</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w">         </span><span class="c1">// 调用处理例程，企图释放内存</span>
<span class="linenos">93</span><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">        </span><span class="c1">// 再次尝试配置内存</span>
<span class="linenos">94</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos">95</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">96</span><span class="p">}</span><span class="w"></span>
<span class="linenos">97</span>
<span class="linenos">98</span><span class="c1">// 注意，以下直接将参数 inst 指定为 0</span>
<span class="hll"><span class="linenos">99</span><span class="k">typedef</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="n">malloc_alloc</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
<p>上述代码与以下代码等价，主要是函数指针的写法不太直观：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#pragma once</span>
<span class="linenos">  2</span><span class="cp">#if 0</span><span class="c"></span>
<span class="linenos">  3</span><span class="c">#include&lt;new&gt;</span>
<span class="linenos">  4</span><span class="c">#define __THROW_BAD_ALLOC throw bad_alloc</span>
<span class="linenos">  5</span><span class="cp">#elif !defined(__THROW_BAD_ALLOC)</span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos">  7</span><span class="cp">#define __THROW_BAD_ALLOC std::cerr &lt;&lt; &quot;out of memory&quot; &lt;&lt; std::endl; exit(1)</span>
<span class="linenos">  8</span><span class="cp">#endif </span><span class="c1">// 0</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 11</span><span class="k">class</span> <span class="nc">__malloc_alloc_template</span><span class="w"></span>
<span class="linenos"> 12</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 13</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 14</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">HandlerType</span><span class="p">)();</span><span class="w"></span>
</span><span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 17</span><span class="w">    </span><span class="c1">// 以下函数将用来处理内存不足的情况</span>
<span class="linenos"> 18</span><span class="w">    </span><span class="c1">// oom: out of memory</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 20</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">oom_remalloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="linenos"> 21</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">HandlerType</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 24</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 26</span><span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">      </span><span class="c1">// 第一级配置器直接使用 malloc()</span>
<span class="linenos"> 27</span><span class="w">        </span><span class="c1">// 以下无法满足需求时，改用 oom_malloc()</span>
<span class="linenos"> 28</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oom_malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 32</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 33</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="cm">/*n*/</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 36</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 37</span><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w">       </span><span class="c1">// 第一级配置器直接使用 free()</span>
<span class="linenos"> 38</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">reallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="cm">/*old_sz*/</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">new_sz</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_sz</span><span class="p">);</span><span class="w">      </span><span class="c1">// 第一级配置器直接使用 remalloc()</span>
<span class="linenos"> 43</span><span class="w">        </span><span class="c1">// 以下无法满足需求时，改用 oom_remalloc()</span>
<span class="linenos"> 44</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 46</span><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oom_remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_sz</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 47</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 48</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 49</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="c1">// 以下模仿 C++ 的 set_new_handler()。换句话说，你可以通过它</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="c1">// 指定你自己的 out-of-memory handler</span>
<span class="hll"><span class="linenos"> 53</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">HandlerType</span><span class="w"> </span><span class="n">set_malloc_handler</span><span class="p">(</span><span class="n">HandlerType</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos"> 54</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 55</span><span class="w">        </span><span class="n">HandlerType</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 56</span><span class="w">        </span><span class="n">__malloc_alloc_oom_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 59</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="c1">// malloc_alloc out-of-memory handling</span>
<span class="linenos"> 62</span><span class="c1">// 初值为0。有待客户端设定</span>
<span class="linenos"> 63</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 64</span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">HandlerType</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">__malloc_alloc_oom_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 67</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 68</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 69</span><span class="w">    </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">HandlerType</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 70</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w">        </span><span class="c1">// 不断尝试释、配置、再释放、再配置...</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 74</span><span class="w">        </span><span class="n">my_malloc_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w">     </span><span class="c1">// 调用处理例程，企图释放内存</span>
<span class="linenos"> 79</span><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">         </span><span class="c1">// 再次尝试配置内存</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 82</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 85</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_remalloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 86</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 87</span><span class="w">    </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">HandlerType</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 88</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w">        </span><span class="c1">// 不断尝试释、配置、再释放、再配置...</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 92</span><span class="w">        </span><span class="n">my_malloc_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">my_malloc_handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span><span class="w">         </span><span class="c1">// 调用处理例程，企图释放内存</span>
<span class="linenos"> 97</span><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remalloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">        </span><span class="c1">// 再次尝试配置内存</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">100</span><span class="p">}</span><span class="w"></span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="c1">// 注意，以下直接将参数 inst 指定为 0</span>
<span class="linenos">103</span><span class="k">typedef</span><span class="w"> </span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="n">malloc_alloc</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>第一级配置器以 <code class="docutils literal notranslate"><span class="pre">malloc()</span></code>，<code class="docutils literal notranslate"><span class="pre">free()</span></code>，<code class="docutils literal notranslate"><span class="pre">realloc()</span></code> 等 C 函数执行实际
的内存配置、释放、重配置操作，并实现出类似 C++ new-handler 的机制。是的，它
不能直接运用 C++ new-handler 机制，因为它并非使用 <code class="docutils literal notranslate"><span class="pre">::operator</span> <span class="pre">new</span></code> 来配
置内存。</p>
<p>所谓 C++ new handler 机制是，你可以要求系统在内存配置需求无法被满足时，调用
一个你所指定的函数。卷句话说，一旦 <code class="docutils literal notranslate"><span class="pre">::operator</span> <span class="pre">new</span></code> 无法完成任务，在丢出
<code class="docutils literal notranslate"><span class="pre">std::bad_alloc</span></code> 异常状态之前，会先调用由客户端指定的处理例程。该处理例程
通常即被称为 <em>new-handler</em> 。 <em>new-handler</em> 解决内存不足的组发有特定的模式，
请参考 《Effecitive C++》2e 条款 7 。</p>
<p>注意，SGI 以 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 而非 <code class="docutils literal notranslate"><span class="pre">::operator</span> <span class="pre">new</span></code> 来配置内存（能够想到的一个
原因是历史因素，另一个原因是 C++ 并未提供相应于 <code class="docutils literal notranslate"><span class="pre">realloc</span></code> 的内存配置操作），
因此，SGI 不能直接使用 C++ 的 <cite>set_new_handler()</cite> ，必须模仿一个类似的
<cite>set_new_handler()</cite> 。</p>
</div>
<div class="section" id="sdefault-alloc-template">
<h5>2.2.6 第二级配置器 __sdefault_alloc_template 剖析<a class="headerlink" href="#sdefault-alloc-template" title="永久链接至标题">¶</a></h5>
<p>第二级配置器多了一些机制，避免太多小额区块造成内存的碎片。小额区块带来的其实
不仅是内存碎片，配置时的额外负担也是大问题。</p>
<p>SGI 第二级配置器的做法是，如果区块够大，超过 128 bytes 时，就移交第一级配置
器处理。当区块小于 128 bytes 时，则以内存池管理，此法又称为次层配置：每次配
置一大块内存，并维护对应之自由链表（free-lists）。下次若再有相同大小的内存需
求，就直接从 free-lists 中拨出，如果客户端释还小额区块，就由配置器回收到
free-lists 中 —— 配置器除了负责配置，也负责回收。为了方便管理，SGI 第二级配
置器会主动将任何小额区块的内存需求上调至 8  的倍数，并维护 16 个 free-lists，
各自管理大小分别为 8，16，24，32，40，48，56，64，72，80，88，96，104，112，
120，128 bytes 的小额区块。free-lists 的节点结构如下：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">union</span> <span class="nc">obj</span><span class="w">   </span><span class="c1">// free-lists 的节点构造</span>
<span class="linenos">2</span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="w">    </span><span class="k">union</span> <span class="nc">obj</span><span class="o">*</span><span class="w"> </span><span class="n">free_list_link</span><span class="p">;</span><span class="w"></span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w">        </span><span class="cm">/*The client sees this.*/</span><span class="w"></span>
<span class="linenos">5</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>下面是第二级配置器的部分实现内容：</p>
<blockquote>
<div><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">enum</span> <span class="p">{</span><span class="w"> </span><span class="n">__ALIGN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w">   </span><span class="c1">// 小型区块的上调边界</span>
<span class="linenos"> 2</span><span class="k">enum</span> <span class="p">{</span><span class="w"> </span><span class="n">__MAX_BYTES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="p">};</span><span class="w">   </span><span class="c1">// 小型区块的上限</span>
<span class="linenos"> 3</span><span class="k">enum</span> <span class="p">{</span><span class="w"> </span><span class="n">__NFREELISTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__MAX_BYTES</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">__ALIGN</span><span class="w"> </span><span class="p">};</span><span class="w">   </span><span class="c1">// free-lists 个数</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1">// 以下是第二级配置器</span>
<span class="linenos"> 6</span><span class="c1">// 注意，无 &quot;template&quot; 类型参数，且第二参数完全没派上用场</span>
<span class="linenos"> 7</span><span class="c1">// 第一参数用于多线程环境下。本书不讨论多线程环境</span>
<span class="linenos"> 8</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos"> 9</span><span class="k">class</span> <span class="nc">__default_alloc_template</span><span class="w"></span>
</span><span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="c1">// ROUND_UP 将 bytes 上调至 8 的倍数</span>
<span class="hll"><span class="linenos">13</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">sizt_t</span><span class="w"> </span><span class="n">ROUND_UP</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">bytes</span><span class="p">)</span><span class="o">+</span><span class="n">__ALIGN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">__ALIGN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="k">union</span> <span class="nc">obj</span><span class="w">   </span><span class="c1">// free-lists 的节点构造</span>
</span><span class="linenos">19</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="k">union</span> <span class="nc">obj</span><span class="o">*</span><span class="w"> </span><span class="n">free_list_link</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w">        </span><span class="cm">/*The client sees this.*/</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="c1">// 16 个 free-lists</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">obj</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">free_list</span><span class="p">[</span><span class="n">__NFREELISTS</span><span class="p">];</span><span class="w"></span>
</span><span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="c1">// 以下函数根据区块大小，决定使用第 n 号 free-list。 n 从1起算</span>
<span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">FREELIST_INDEX</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
</span><span class="linenos">29</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">30</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">bytes</span><span class="p">)</span><span class="o">+</span><span class="n">__ALIGN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">__ALIGN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">    </span><span class="c1">// 返回一个大小为 n 的对象，并可能加入大小为 n 的其它区块到 free list</span>
<span class="hll"><span class="linenos">34</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">refill</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="c1">// 配置一大块空间，可容纳 nobjs 个大小为 size 的区块</span>
<span class="linenos">37</span><span class="w">    </span><span class="c1">// 如果配置 nobjs 个区块有所不便，nobjs 可能会降低</span>
<span class="hll"><span class="linenos">38</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">chunk_alloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">nobjs</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="c1">// Chunk allocation state</span>
<span class="hll"><span class="linenos">41</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">start_free</span><span class="p">;</span><span class="w">    </span><span class="c1">// 内存池起始位置。只在 chunk_alloc() 中变化</span>
</span><span class="hll"><span class="linenos">42</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">end_free</span><span class="p">;</span><span class="w">      </span><span class="c1">// 内存池结束位置。只在 chunk_alloc() 中变化</span>
</span><span class="hll"><span class="linenos">43</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">heap_size</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">44</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">45</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="cm">/*详述于后*/</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">46</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="cm">/*详述于后*/</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos">47</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">reallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">old_sz</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">new_sz</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">48</span><span class="p">};</span><span class="w"></span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="c1">// 以下是 static data member 的定义与初值设定</span>
<span class="linenos">51</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">52</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">__default_alloc_template</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">start_free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</span><span class="linenos">53</span>
<span class="linenos">54</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">55</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">__default_alloc_template</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">end_free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</span><span class="linenos">56</span>
<span class="linenos">57</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="hll"><span class="linenos">58</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">__default_alloc_template</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">heap_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</span><span class="linenos">59</span>
<span class="linenos">60</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">61</span><span class="n">__default_alloc_template</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">obj</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"></span>
<span class="hll"><span class="linenos">62</span><span class="n">__default_alloc_template</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">free_list</span><span class="p">[</span><span class="n">__NFREELISTS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
</span><span class="linenos">63</span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="allocate">
<h5>2.2.7 空间配置函数 allocate()<a class="headerlink" href="#allocate" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="deallocate">
<h5>2.2.8 空间释放函数 deallocate()<a class="headerlink" href="#deallocate" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="free-lists">
<h5>2.2.9 重新填充 free lists<a class="headerlink" href="#free-lists" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="memory-pool">
<h5>2.2.10 内存池（memory pool）<a class="headerlink" href="#memory-pool" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="id226">
<h4>2.3 内存基本处理工具<a class="headerlink" href="#id226" title="永久链接至标题">¶</a></h4>
<p>STL 定义有5个全局函数，作用于未初始化空间上，这样的功能对于容器的实现很有帮助：</p>
<blockquote>
<div><ul class="simple">
<li><p>construct()</p></li>
<li><p>destroy()</p></li>
<li><p>uninitialized_copy()</p></li>
<li><p>uninitialized_fill()</p></li>
<li><p>uninitialized_fill_n()</p></li>
</ul>
</div></blockquote>
<p>前两个函数是之前提到过的用于构造的 <code class="docutils literal notranslate"><span class="pre">construct()</span></code> 和用于析构的 <code class="docutils literal notranslate"><span class="pre">destroy()</span></code>，
另外三个函数分别对应于高层次函数 <code class="docutils literal notranslate"><span class="pre">copy()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">fill()</span></code> 、<code class="docutils literal notranslate"><span class="pre">fill_n()</span></code> ——
这些都是 STL 是算法。如果要使用本节的三个低层次函数，应该包含 <code class="docutils literal notranslate"><span class="pre">&lt;memory&gt;</span></code> ，
不过 SGI 把它们实际定义于 <code class="docutils literal notranslate"><span class="pre">&lt;stl_uninitialized&gt;</span></code> 。</p>
<div class="section" id="uninitialized-copy">
<h5>2.3.1 uninitialized_copy<a class="headerlink" href="#uninitialized-copy" title="永久链接至标题">¶</a></h5>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">ForwardIterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">ForwardIterator</span><span class="w"> </span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">InputIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">ForwardIterator</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">uninitialized_copy()</span></code> 使用们能够将内存的配置与对象的构造行为分离开来。如
果作为输出目的地的 <em>[result, result + (last - first))</em> 范围内的每一个迭代
器都指向未初始化区域，则 <code class="docutils literal notranslate"><span class="pre">uninitialized_copy</span></code> 会使用 <em>copy constructor</em> ，
将输入源里面 <em>[first, last)</em> 范围内的每一个对象产生一份复制品，再将其放到目
标输出范围中。即针对输入源范围内的每一个迭代器 <code class="docutils literal notranslate"><span class="pre">i</span></code> ，该函数会调用
<code class="docutils literal notranslate"><span class="pre">construct(&amp;(result</span> <span class="pre">+</span> <span class="pre">(i</span> <span class="pre">-</span> <span class="pre">first)),</span> <span class="pre">*i)</span></code> 来产生 <code class="docutils literal notranslate"><span class="pre">*i</span></code> 的复制品，然后
将其放置于目标输出范围的对应位置上。</p>
<p>如果你需要实现一个容器， <code class="docutils literal notranslate"><span class="pre">uninitialized_copy()</span></code> 这样的函数会为你带来很大
的帮助，因为容器的全区间构造函数（range constructor）通常以两个步骤完成：</p>
<blockquote>
<div><ul class="simple">
<li><p>配置内存区块，足以包含范围内的所有元素。</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">uninitialized_copy()</span></code> ，在该内存区块上构造元素。</p></li>
</ul>
</div></blockquote>
<p>C++ 标准规范要求 <code class="docutils literal notranslate"><span class="pre">uninitialized_copy()</span></code> 具有 <strong>“commit or rollback”</strong>
语义，即要么构造出所有元素，要么不构造任何东西。</p>
</div>
<div class="section" id="uninitialized-fill">
<h5>2.3.2 uninitialized_fill<a class="headerlink" href="#uninitialized-fill" title="永久链接至标题">¶</a></h5>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ForwardIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">uninitialized_fill</span><span class="p">(</span><span class="n">ForwardIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ForwardIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">uninitialized_fill()</span></code> 也能够使我们将内存配置与对象的构造行为分离开来。如
果 <em>[first, last)</em> 范围内的每个迭代器都指向未初始化的内存，那么 <code class="docutils literal notranslate"><span class="pre">uninitialized_fill()</span></code>
会在该范围内产生 <code class="docutils literal notranslate"><span class="pre">x</span></code> 的复制品。即 <code class="docutils literal notranslate"><span class="pre">uninitialized_fill()</span></code> 会针对操作范围
内的每个迭代器 <code class="docutils literal notranslate"><span class="pre">i</span></code> ，调用 <code class="docutils literal notranslate"><span class="pre">construct(&amp;*i,</span> <span class="pre">x)</span></code> ，在 <code class="docutils literal notranslate"><span class="pre">i</span></code> 所指之处产生
<code class="docutils literal notranslate"><span class="pre">x</span></code> 的复制品。</p>
<p>与 <code class="docutils literal notranslate"><span class="pre">uninitialized_copy()</span></code> 一样， <code class="docutils literal notranslate"><span class="pre">uninitialized_fill()</span></code> 必须具备
<strong>“commit or rollback”</strong> 语义。</p>
</div>
<div class="section" id="uninitialized-fill-n">
<h5>2.3.3 uninitialized_fill_n<a class="headerlink" href="#uninitialized-fill-n" title="永久链接至标题">¶</a></h5>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ForwardIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Size</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">ForwardIterator</span><span class="w"> </span><span class="n">uninitialized_fill_n</span><span class="p">(</span><span class="n">ForwardIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">uninitialized_fill_n()</span></code> 能够使我们将内存配置与对象构造行为分离开来。它
会为指定范围内的所有元素设定相同的初值。</p>
<p>如果 <em>{first, first + n)</em> 范围内的每一个迭代器都指向未初始化的内存，那么
<code class="docutils literal notranslate"><span class="pre">uninitialized_fill_n()</span></code> 会调用 <em>copy constructor</em> ，在该范围内产生 <code class="docutils literal notranslate"><span class="pre">x</span></code>
的复制品。即针对 <em>[first, first + n)</em> 范围内的每个迭代器 <code class="docutils literal notranslate"><span class="pre">i</span></code> ， <code class="docutils literal notranslate"><span class="pre">unintialized_fill_n()</span></code>
会调用 <code class="docutils literal notranslate"><span class="pre">construct(&amp;*i,</span> <span class="pre">x)</span></code> ，在对应位置处产生 <code class="docutils literal notranslate"><span class="pre">x</span></code> 的复制品。</p>
<p><code class="docutils literal notranslate"><span class="pre">uninitialized_fill_n()</span></code> 也具备 <strong>“commit or rollback”</strong> 语义。</p>
<p>以下分别介绍这三个函数的实现。其中所呈现的 <code class="docutils literal notranslate"><span class="pre">iterators</span></code> 、 <code class="docutils literal notranslate"><span class="pre">value_type()</span></code> 、
<code class="docutils literal notranslate"><span class="pre">__type_traits</span></code> 、 <code class="docutils literal notranslate"><span class="pre">__true_type</span></code> 、 <code class="docutils literal notranslate"><span class="pre">__false_type</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_POD_type</span></code>
等实现技术，都将于第 3 章介绍。</p>
</div>
</div>
</div>
<div class="section" id="iterators-traits">
<h3>第三章 迭代器（iterators）概念与 traits 编程技法<a class="headerlink" href="#iterators-traits" title="永久链接至标题">¶</a></h3>
<div class="section" id="id227">
<h4>3.1 迭代器设计思维 —— STL 关键所在<a class="headerlink" href="#id227" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="iterator-smart-pointer">
<h4>3.2 迭代器（iterator）是一种 smart pointer<a class="headerlink" href="#iterator-smart-pointer" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="associated-types">
<h4>3.3 迭代器相应类型（associated types）<a class="headerlink" href="#associated-types" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="traits-stl">
<h4>3.4 Traits 编程技法 —— STL 源代码门钥<a class="headerlink" href="#traits-stl" title="永久链接至标题">¶</a></h4>
<div class="section" id="iterator-category">
<h5>3.4.5 迭代器相应类型之五： iterator_category<a class="headerlink" href="#iterator-category" title="永久链接至标题">¶</a></h5>
<p>根据移动特性与施行操作，迭代器被分为五类：</p>
<ul class="simple">
<li><p><strong>Input Iterator</strong>: 这种迭代器所指的对象，不允许外界改变。只读。</p></li>
<li><p><strong>Output Iteratot</strong>: 只写。</p></li>
<li><p><strong>Forward Iterator</strong>: 允许写入型算法（例如 replace() ）在此种迭代器所形成
的区间上进行读写操作。</p></li>
<li><p><strong>Bidirectional Iterator</strong>: 可双向移动。某些算法需要逆向遍历某个迭代器区间
（例如逆向拷贝某范围内的元素），可以使用 Bidirectional Iterator.</p></li>
<li><p><strong>Random Access Iterator</strong>:  前四种迭代器都只供应一部分指针算术能力（前三
种支持 <em>opetator++</em> ，第四种支持 <em>operator–</em> ），第五种则涵盖所有指针
算术能力，包括 <em>p + n</em> ， <em>p - n</em> ， <em>p[n]</em> ， <em>p1 - p2</em> ， <em>p1 &lt; p2</em> 。</p></li>
</ul>
<div class="figure align-center" id="id300">
<div class="graphviz"><object data="../_images/graphviz-946d9d5c5218c6d8014c13bd5b868e20f09dd9bf.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    bgcolor = &quot;transparent&quot;
    rankdir = TB;
    splines = false;
    node [shape=&quot;plaintext&quot;];
    edge [style=&quot;solid&quot;];

    subgraph cluster_0 {
        a [label = &quot;Input Iterator&quot;];
        b [label = &quot;Output Iterator&quot;];
        c [label = &quot;Forward Iterator&quot;];
        d [label = &quot;Bidirectional Iterator&quot;];
        e [label = &quot;Random Access Iterator&quot;];

        a:s-&gt;c;
        b:s-&gt;c;
        c:s-&gt;d:n;
        d:s-&gt;e:n;
    }
}</p></object></div>
<p class="caption"><span class="caption-text">迭代器的分类与从属关系</span><a class="headerlink" href="#id300" title="永久链接至图片">¶</a></p>
</div>
<div class="literal-block-wrapper docutils container" id="id301">
<div class="code-block-caption"><span class="caption-text">iterator_traits.h</span><a class="headerlink" href="#id301" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#pragma once</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;cstddef&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">T</span><span class="o">::</span><span class="n">iterator_category</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">T</span><span class="o">::</span><span class="n">value_type</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">T</span><span class="o">::</span><span class="n">difference_type</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">T</span><span class="o">::</span><span class="n">pointer</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">T</span><span class="o">::</span><span class="n">reference</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="p">};</span><span class="w"></span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1">// 偏特化版本 —— 指针</span>
<span class="linenos">15</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">16</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
<span class="linenos">17</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="cm">/*something todo here*/</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">19</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="p">};</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="c1">// 偏特化版本 —— 常量指针</span>
<span class="linenos">26</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">27</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
<span class="linenos">28</span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos">29</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="cm">/*something todo here*/</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">30</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>总结：</p>
<blockquote>
<div><p>设计适当的相应类型（associated types），是迭代器的责任。设计适当的迭代
器，则是容器的责任。唯容器本身，才知道该设计出怎样的迭代器来遍历自己，并
执行迭代器该有的各种行为（前进、后退、取值、取用成员…）。至于算法，完全
可以独立于容器和迭代器之外自行发展，只要设计时以迭代器为对外接口就行。</p>
<p><strong>traits</strong> 编程技法大量运用于 STL 实现品中。它利用“内嵌类型”的编程技巧
与编译器的 template 参数推导功能，增强 C++ 未能提供的关于类型认证方面的
能力，弥补 C++ 不为强类型（strong typed）语言的遗憾。</p>
</div></blockquote>
</div>
</div>
<div class="section" id="std-iterator">
<h4>3.5 std::iterator 的保证<a class="headerlink" href="#std-iterator" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="iterator">
<h4>3.6 iterator 源代码完整重列<a class="headerlink" href="#iterator" title="永久链接至标题">¶</a></h4>
<div class="literal-block-wrapper docutils container" id="id302">
<div class="code-block-caption"><span class="caption-text">stl_iterator.h</span><a class="headerlink" href="#id302" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#pragma once</span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="cpf">&lt;cstddef&gt;</span><span class="cp"></span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="c1">// 节选自 SGI STL &lt;stl_iterator.h&gt;</span>
<span class="linenos">  5</span><span class="c1">// 物种迭代器类型</span>
<span class="linenos">  6</span><span class="k">struct</span> <span class="nc">input_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">  7</span><span class="k">struct</span> <span class="nc">output_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">  8</span><span class="k">struct</span> <span class="nc">forward_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">input_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos">  9</span><span class="k">struct</span> <span class="nc">bidirectional_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">forward_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 10</span><span class="k">struct</span> <span class="nc">random_access_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">bidirectional_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="c1">// 为避免写代码时挂一漏万，自行开发迭代器时最好继承自下面这个 std::iterator</span>
<span class="linenos"> 13</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Category</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="w"></span>
<span class="linenos"> 14</span><span class="k">struct</span> <span class="nc">iterator</span><span class="w"></span>
<span class="linenos"> 15</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 16</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 17</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 18</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 19</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 20</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 21</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="c1">// “榨汁机” traits</span>
<span class="linenos"> 24</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Iterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 25</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="w"></span>
<span class="linenos"> 26</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 27</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">Iterator</span><span class="o">::</span><span class="n">iterator_category</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 28</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">Iterator</span><span class="o">::</span><span class="n">value_type</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">Iterator</span><span class="o">::</span><span class="n">difference_type</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">Iterator</span><span class="o">::</span><span class="n">pointer</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">Iterator</span><span class="o">::</span><span class="n">reference</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 32</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="c1">// 针对原生指针而设计的 traits 偏特化版</span>
<span class="linenos"> 35</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 36</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
<span class="linenos"> 37</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 38</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">random_access_iterator_tag</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 39</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 43</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="c1">// 针对原生之 pointer-to-const 而设计的 traits 偏特化版</span>
<span class="linenos"> 46</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 47</span><span class="k">struct</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*&gt;</span><span class="w"></span>
<span class="linenos"> 48</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 49</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">random_access_iterator_tag</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 51</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 52</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 53</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 54</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="c1">// 决定某个迭代器的类型</span>
<span class="linenos"> 57</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Iterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 58</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="w"></span>
<span class="linenos"> 59</span><span class="n">iterator_category</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Iterator</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 60</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 61</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="w"> </span><span class="n">categoty</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 62</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">categoty</span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 63</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 64</span><span class="c1">// 决定某个迭代器的 distance type</span>
<span class="linenos"> 65</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Iterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 66</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="o">*</span><span class="w"></span>
<span class="linenos"> 67</span><span class="n">distance_type</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Iterator</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 68</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 69</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="o">*&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 70</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="c1">// 决定某个迭代器的 value type</span>
<span class="linenos"> 73</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Iterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 74</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span><span class="w"></span>
<span class="linenos"> 75</span><span class="n">value_type</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Iterator</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 76</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 78</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="c1">// 以下是整组 distance 函数</span>
<span class="linenos"> 81</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 82</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="w"></span>
<span class="linenos"> 83</span><span class="n">__distance</span><span class="p">(</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">InputIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">input_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 84</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lase</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 88</span><span class="w">        </span><span class="o">++</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 89</span><span class="w">        </span><span class="o">++</span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 90</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 91</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 92</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 95</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">RandomAccessIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="w"></span>
<span class="linenos"> 96</span><span class="n">__distance</span><span class="p">(</span><span class="n">RandomAccessIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">RandomAccessIterator</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">random_access_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 97</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 99</span><span class="p">}</span><span class="w"></span>
<span class="linenos">100</span>
<span class="linenos">101</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">102</span><span class="kr">inline</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span><span class="w"></span>
<span class="linenos">103</span><span class="n">distance</span><span class="p">(</span><span class="n">InputIterator</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">InputIterator</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"></span>
<span class="linenos">104</span><span class="p">{</span><span class="w"></span>
<span class="linenos">105</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span> <span class="nc">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIterator</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="w"> </span><span class="n">category</span><span class="p">;</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="n">return__distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">category</span><span class="p">());</span><span class="w"></span>
<span class="linenos">107</span><span class="p">}</span><span class="w"></span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="c1">// 以下是整组 advance 函数</span>
<span class="linenos">110</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Distance</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">111</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__advance</span><span class="p">(</span><span class="n">InputIterator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">input_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">112</span><span class="p">{</span><span class="w"></span>
<span class="linenos">113</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">114</span><span class="p">}</span><span class="w"></span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">BidirectionalIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Distance</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">117</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__advance</span><span class="p">(</span><span class="n">BidirectionalIterator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">bidirectional_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">118</span><span class="p">{</span><span class="w"></span>
<span class="linenos">119</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">120</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span><span class="w"></span>
<span class="linenos">121</span><span class="w">            </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">122</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">123</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">124</span><span class="w">            </span><span class="o">--</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">125</span><span class="p">}</span><span class="w"></span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Distance</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">128</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__advance</span><span class="p">(</span><span class="n">RandomAccessIterator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">random_access_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">129</span><span class="p">{</span><span class="w"></span>
<span class="linenos">130</span><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="linenos">131</span><span class="p">}</span><span class="w"></span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Distance</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">134</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">advance</span><span class="p">(</span><span class="n">InputIterator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">random_access_iterator_tag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">135</span><span class="p">{</span><span class="w"></span>
<span class="linenos">136</span><span class="w">    </span><span class="n">__advance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">137</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sgi-stl-type-traits">
<h4>3.7 SGI STL 的私房菜： __type_traits<a class="headerlink" href="#sgi-stl-type-traits" title="永久链接至标题">¶</a></h4>
<p>traits 编程技法很棒，适度弥补了 C++ 语言本身的不足。STL 只对迭代器加以规范，
制定出 <em>iterator_traits</em> 这样的东西。SGI 把这种技法进一步扩大到迭代器以外的
世界，于是有了所谓的 <em>__type_traits</em> 。双下划线前缀词意指这是 SGI STL 内部
作用的东西，不在 STL 标准规范之内。</p>
<p><em>iterator_traits</em> 负责萃取迭代器的特性， <strong>__type_traits</strong> 则负责萃取类型
的特性。此处我们所关注的类型特性是指：</p>
<blockquote>
<div><ul class="simple">
<li><p>这个类型是否具备 non-trivial defalt ctor</p></li>
<li><p>是否具备 non-trivial copy ctor</p></li>
<li><p>是否具备 non-trivial assignment operator</p></li>
<li><p>是否具备 non-trivial dtor</p></li>
</ul>
</div></blockquote>
<p>如果答案是否定的，我们在对这个类型进行构造、析构、拷贝、赋值等操作时，就可以
采用最有效率的措施（例如根本不调用身居高位，不谋实事的那些 constructor,
destructor），而采用内存直接处理操作如 <em>malloc()</em> 、 <em>memcpy()</em> 等等，获得
最高效率。这对于大规模而操作频繁的容器，有着显著的效率提升。</p>
<p>根据 <em>iterator_traits</em> 得来的经验，我们希望，程序之中可以这样运用
<em>__type_traits&lt;T&gt;</em> , <em>T</em> 代表任意类型：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">has_trivial_default_constructor</span><span class="w"></span>
<span class="linenos">2</span><span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">has_trivial_copy_constructor</span><span class="w"></span>
<span class="linenos">3</span><span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">has_trivial_assignmenr_operator</span><span class="w"></span>
<span class="linenos">4</span><span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">has_trivial_destructor</span><span class="w"></span>
<span class="linenos">5</span><span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_POD_type</span><span class="w"></span>
</pre></div>
</div>
<p>为达成上述五个式子， <em>__type_traits</em> 内必须定义一些 typedefs ，其值不是
<em>__true_type</em> 就是 <em>__false_type</em> 。下面是 SGI 的做法：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">struct</span> <span class="nc">__true_type</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 2</span><span class="k">struct</span> <span class="nc">__false_type</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">type</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">struct</span> <span class="nc">__type_traits</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__true_type</span><span class="w"> </span><span class="n">this_dummy_member_must_be_first</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__false_type</span><span class="w"> </span><span class="n">has_trivial_default_constructor</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__false_type</span><span class="w"> </span><span class="n">has_trivial_copy_constructor</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__false_type</span><span class="w"> </span><span class="n">has_trivial_assignmenr_operator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__false_type</span><span class="w"> </span><span class="n">has_trivial_destructor</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__false_type</span><span class="w"> </span><span class="n">is_POD_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id228">
<h3>第四章 序列式容器<a class="headerlink" href="#id228" title="永久链接至标题">¶</a></h3>
<div class="section" id="id229">
<h4>4.1 容器的概观与分类<a class="headerlink" href="#id229" title="永久链接至标题">¶</a></h4>
<div class="figure align-center" id="id303">
<div class="graphviz"><object data="../_images/graphviz-6302a661239f37e503b79778cc1c2a27c8aca566.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph test{
    bgcolor = &quot;transparent&quot;
    rankdir = TB;
    splines = false;
    node [shape = &quot;plaintext&quot;];
    edge [style = &quot;invis&quot;];

    a0 [label = &quot;序列式容器\nSequence Containers&quot;];
    b0 [label = &quot;关联式容器\nAssociative Containers&quot;];

    node [shape = &quot;box&quot;, fixedsize = false, fontsize = 12, margin = &quot;0.11,0.055&quot;, width = 0.3 , height = 0.2];
    a1 [label = &quot;Array(built-in)&quot;];
    a2 [label = &quot;Vector&quot;];
    a3 [label = &quot;heap&quot;];
    a4 [label = &quot;priority-queue&quot;];
    a5 [label = &quot;list&quot;];
    a6 [label = &quot;slist&quot;];
    a7 [label = &quot;deque&quot;];
    a8 [label = &quot;stack&quot;];
    a9 [label = &quot;queue&quot;];

    b1 [label = &quot;RB-tree&quot;];
    b2 [label = &quot;set&quot;];
    b3 [label = &quot;map&quot;];
    b4 [label = &quot;multiset&quot;];
    b5 [label = &quot;multimap&quot;];
    b6 [label = &quot;hashtable&quot;];
    b7 [label = &quot;hash_set&quot;];
    b8 [label = &quot;hash_map&quot;];
    b9 [label = &quot;hash_multiset&quot;];
    b10 [label = &quot;hash_multimap&quot;];

    a0 -&gt; a1;
    a1 -&gt; a2;
    a2 -&gt; a3;
    a3 -&gt; a4;
    a4 -&gt; a5;
    a5 -&gt; a6;
    a6 -&gt; a7;
    a7 -&gt; a8;
    a8 -&gt; a9;

    b0 -&gt; b1;
    b1 -&gt; b2;
    b2 -&gt; b3;
    b3 -&gt; b4;
    b4 -&gt; b5;
    b5 -&gt; b6;
    b6 -&gt; b7;
    b7 -&gt; b8;
    b8 -&gt; b9;
    b9 -&gt; b10;

}</p></object></div>
<p class="caption"><span class="caption-text">迭代器的分类与从属关系</span><a class="headerlink" href="#id303" title="永久链接至图片">¶</a></p>
</div>
<div class="section" id="id230">
<h5>4.1.1 序列式容器<a class="headerlink" href="#id230" title="永久链接至标题">¶</a></h5>
<p>所谓序列式容器，其中的元素都可序（ <em>ordered</em> ），但未必有序（ <em>sorted</em> ）。
C++ 语言本身提供了一个序列式容器 <strong>array</strong> ，STL 另外再提供 <strong>vector</strong> ，
<strong>list</strong> ， <strong>deque</strong> ， <strong>stack</strong> ， <strong>queue</strong> ， <strong>priotity-queue</strong>
等等序列式容器。其中 <strong>stack</strong> 和 <strong>queue</strong> 由于只是将 <strong>deque</strong> 改头换面
而成，技术上被归类为一种适配器。</p>
</div>
</div>
<div class="section" id="vector">
<h4>4.2 vector<a class="headerlink" href="#vector" title="永久链接至标题">¶</a></h4>
<div class="section" id="id231">
<h5>4.2.1 vector 概述<a class="headerlink" href="#id231" title="永久链接至标题">¶</a></h5>
<p>vector 的数据安排以及操作方式，与 array 非常相似。两者唯一的区别在于空间运用
的灵活性。</p>
<p>array :</p>
<blockquote>
<div><ul>
<li><p>静态空间，一旦配置就不能改变</p></li>
<li><p>换更大的空间需要客户端自己处理</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>配置一块新空间</p></li>
<li><p>将元素从旧址一一搬往新址</p></li>
<li><p>把原来的空间释还给系统</p></li>
</ol>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>vector :</p>
<blockquote>
<div><ul class="simple">
<li><p>动态空间</p></li>
<li><p>随着元素的加入，内部机制会自行扩充空间以容纳新元素</p></li>
</ul>
</div></blockquote>
<p>vector 的实现技术，关键在于其对大小的控制以及重新配置时的数据移动效率。</p>
</div>
<div class="section" id="id232">
<h5>4.2.2 vector 定义摘要<a class="headerlink" href="#id232" title="永久链接至标题">¶</a></h5>
<p>以下是 vector 定义的源代码摘录。虽然 STL 规定，欲使用 vector 者必须先包括
&lt;vector&gt;，但 SGI　STL 将 vector 实现于更底层的 &lt;stl_vector.h&gt;。</p>
<div class="literal-block-wrapper docutils container" id="id304">
<div class="code-block-caption"><span class="caption-text">stl_vector.h</span><a class="headerlink" href="#id304" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span>#pragma once
<span class="linenos">  2</span>#include&lt;cstddef&gt;   // for ptrdiff_t, size_t
<span class="linenos">  3</span>
<span class="linenos">  4</span>class alloc {};
<span class="linenos">  5</span>
<span class="linenos">  6</span>// alloc 是 SGI STL 的空间配置器，见第二章
<span class="linenos">  7</span>template&lt;class T, class Alloc = alloc&gt;
<span class="linenos">  8</span>class vector
<span class="linenos">  9</span>{
<span class="linenos"> 10</span>public:
<span class="linenos"> 11</span>    // vector的嵌套类型定义
<span class="linenos"> 12</span>    typedef T value_type;
<span class="linenos"> 13</span>    typedef value_type* pointer;
<span class="linenos"> 14</span>    typedef value_type* iterator;       // vector 的迭代器是普通指针
<span class="linenos"> 15</span>    typedef value_type&amp; reference;
<span class="linenos"> 16</span>    typedef size_t size_type;
<span class="linenos"> 17</span>    typedef ptrdiff_t difference_type;
<span class="linenos"> 18</span>
<span class="linenos"> 19</span>protected:
<span class="linenos"> 20</span>    // 以下，simple_alloc 是 SGI STL 的空间配置器，见 2.2.4 节
<span class="linenos"> 21</span>    typedef simple_alloc&lt;value_type, Alloc&gt; data_allocator;
<span class="linenos"> 22</span>    iterator start;             // 表示目前使用空间的头
<span class="linenos"> 23</span>    iterator finish;            // 表示目前使用空间的尾
<span class="linenos"> 24</span>    iterator enf_of_storage;    // 表示目前可用空间的尾
<span class="linenos"> 25</span>
<span class="linenos"> 26</span>    void insert_aux(iterator positoin, const T&amp; x);
<span class="linenos"> 27</span>    void deallocate()
<span class="linenos"> 28</span>    {
<span class="linenos"> 29</span>        if (start)
<span class="linenos"> 30</span>            data_allocator::deallocate(start, enf_of_storage - start);
<span class="linenos"> 31</span>    }
<span class="linenos"> 32</span>
<span class="linenos"> 33</span>    void fill_initialize(size_type n, const T&amp; value)
<span class="linenos"> 34</span>    {
<span class="linenos"> 35</span>        start = allocate_and_fill(n, value);
<span class="linenos"> 36</span>        finish = start + n;
<span class="linenos"> 37</span>        enf_of_storage = finish;
<span class="linenos"> 38</span>    }
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>public:
<span class="linenos"> 41</span>    iterator begin() { return start; }
<span class="linenos"> 42</span>    iterator end() { return finish; }
<span class="linenos"> 43</span>    size_type size() const { return size_type(end() - begin()); }
<span class="linenos"> 44</span>    size_type capacity() const { return size_type(enf_of_storage - begin()); }
<span class="linenos"> 45</span>    bool empty() const { return begin() == end(); }
<span class="linenos"> 46</span>    reference operator[](size_type n) { return *(begin() + n); }
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>    vector() :start(0), finish(0), enf_of_storage(0) {}
<span class="linenos"> 49</span>    vector(size_type n, const T&amp; value) { fill_initialize(n, v); }
<span class="linenos"> 50</span>    vector(int n, const T&amp; value) { fill_initialize(n, v); }
<span class="linenos"> 51</span>    vector(long n, const T&amp; value) { fill_initialize(n, v); }
<span class="linenos"> 52</span>    explicit vector(size_type n) { fill_initialize(n, T()); }
<span class="linenos"> 53</span>
<span class="linenos"> 54</span>    ~vector()
<span class="linenos"> 55</span>    {
<span class="linenos"> 56</span>        destroy(start, finish);     // 全局函数，见 2.2.3 节
<span class="linenos"> 57</span>        deallocate();               // 这是 vector 的一个 member function
<span class="linenos"> 58</span>    }
<span class="linenos"> 59</span>
<span class="linenos"> 60</span>    reference front() { return *begin(); }      // 第一个元素
<span class="linenos"> 61</span>    reference back() { return *(end() - 1); }   // 最后一个元素
<span class="linenos"> 62</span>    void push_back() { const T&amp; x }               // 将元素插入至尾端
<span class="linenos"> 63</span>    {
<span class="linenos"> 64</span>        if (finish != end_of_storage)
<span class="linenos"> 65</span>        {
<span class="linenos"> 66</span>            construct(finish, x);
<span class="linenos"> 67</span>            ++finish;               // 全局函数，见 2.2.3 节
<span class="linenos"> 68</span>        }
<span class="linenos"> 69</span>        else
<span class="linenos"> 70</span>            insert_aux(end(), x);
<span class="linenos"> 71</span>    }
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>    void pop_back()                 // 将最尾端元素取出
<span class="linenos"> 74</span>    {
<span class="linenos"> 75</span>        --finish;
<span class="linenos"> 76</span>        destroy(finish);
<span class="linenos"> 77</span>    }
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>    iterator erase(iterator position)   // 清除某位置上的元素
<span class="linenos"> 80</span>    {
<span class="linenos"> 81</span>        if (position + 1 != end())
<span class="linenos"> 82</span>            copy(position + 1, finish, .position);     // 后续元素往前移动
<span class="linenos"> 83</span>        --finish;
<span class="linenos"> 84</span>        destroy(finish);
<span class="linenos"> 85</span>        return position;
<span class="linenos"> 86</span>    }
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>    void resize(size_type new_size, const T&amp; x)
<span class="linenos"> 89</span>    {
<span class="linenos"> 90</span>        if (new_size &lt; size)
<span class="linenos"> 91</span>            erase(begin() + new_size, end());
<span class="linenos"> 92</span>        else
<span class="linenos"> 93</span>            insert(end(), new_size - size(), x);
<span class="linenos"> 94</span>    }
<span class="linenos"> 95</span>    void resize(size_type new_size) { resize(new_size, T()); }
<span class="linenos"> 96</span>    void clear() { erase(begin(), end()); }
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>protected:
<span class="linenos"> 99</span>    // 配置空间并填充内容
<span class="linenos">100</span>    iterator allocate_and_fill(size_type n, const T&amp; x)
<span class="linenos">101</span>    {
<span class="linenos">102</span>        iterator result = data_allocator::allocate(n);
<span class="linenos">103</span>        uninitialized_fill_n(result, n, x);       // 全局函数，见 2.3 节
<span class="linenos">104</span>        return result;
<span class="linenos">105</span>    }
<span class="linenos">106</span>};
<span class="linenos">107</span>
<span class="hll"><span class="linenos">108</span>template&lt;class T, class Alloc&gt;
</span><span class="hll"><span class="linenos">109</span>void vector&lt;T, Alloc&gt;::insert_aux(iterator positoin, const T&amp; x)
</span><span class="linenos">110</span>{
<span class="linenos">111</span>    if (finish != enf_of_storage)
<span class="linenos">112</span>    {
<span class="linenos">113</span>        // 在备用空间起始处构造一个元素，并以 vector 最后一个元素值为其初值
<span class="linenos">114</span>        construct(finish, *(finish - 1));
<span class="linenos">115</span>        ++finish;
<span class="linenos">116</span>        T x_copy = x;
<span class="linenos">117</span>        copy_backward(position, finish - 2, finish - 1);
<span class="linenos">118</span>        *positoin = x_copy；
<span class="linenos">119</span>    }
<span class="linenos">120</span>    else
<span class="linenos">121</span>    {
<span class="linenos">122</span>        const size_type old_size = size();
<span class="linenos">123</span>        const size_type len = old_size != 0 ? 2 * old_size : 1;
<span class="linenos">124</span>
<span class="linenos">125</span>        iterator new_start = data_allocator::allocate(len); // 实际配置
<span class="linenos">126</span>        iterator new_finish = new_start;
<span class="linenos">127</span>
<span class="linenos">128</span>        try
<span class="linenos">129</span>        {
<span class="linenos">130</span>            // 将原 vector 的内容拷贝到新 vector
<span class="linenos">131</span>            new_finish = uninitialized_copy(start, position, new_start);
<span class="linenos">132</span>            // 为新元素设定初值
<span class="linenos">133</span>            construct(new_finish, x);
<span class="linenos">134</span>            ++new_finish;
<span class="linenos">135</span>            // 将原 vector 的备用空间中的内容也拷贝过来（啥用途）
<span class="linenos">136</span>            new_finish = uninitialized_copy(position, finish, new_finish);
<span class="linenos">137</span>        }
<span class="linenos">138</span>        catch (...)
<span class="linenos">139</span>        {
<span class="linenos">140</span>            // &quot;commit or rollback&quot; semantics.
<span class="linenos">141</span>            destroy(new_start, new_finish);
<span class="linenos">142</span>            data_allocator::deallocate(new_start, len);
<span class="linenos">143</span>            throw；
<span class="linenos">144</span>        }
<span class="linenos">145</span>
<span class="linenos">146</span>        // 析构并释放原 vector
<span class="linenos">147</span>        destroy(begin(), end());
<span class="linenos">148</span>        deallocate();
<span class="linenos">149</span>
<span class="linenos">150</span>        // 调整迭代器，指向新 vector
<span class="linenos">151</span>        start = new_start;
<span class="linenos">152</span>        finish = new_finish;
<span class="linenos">153</span>        enf_of_storage = new_start + len;
<span class="linenos">154</span>    }
<span class="linenos">155</span>}
</pre></div>
</div>
</div>
</div>
<div class="section" id="id233">
<h5>4.2.3 vector 的迭代器<a class="headerlink" href="#id233" title="永久链接至标题">¶</a></h5>
<p>vector 维护的是一个连续的线性空间，所以不论其元素类型为何，普通指针都可以作
为vector 的迭代器而满足所有必要条件，因为 vector 迭代器所需要的操作行为，如
operator*，operator-&gt;，operator++，operator–，operator+，operator-，
operator+=，operator-=，普通指针天生就具备。vector 支持随机存取，而普通指
针正有着这样的能力。所以，vector 提供的是 Random Access Iterators。</p>
</div>
<div class="section" id="id234">
<h5>4.2.4 vector 的数据结构<a class="headerlink" href="#id234" title="永久链接至标题">¶</a></h5>
<p>vector 所采用的数据结构非常简单，线性连续空间。它以两个迭代器 start 和
finish 分别指向配置得来的连续空间中目前已被使用的范围，并以迭代器
end_of_storage 指向整块连续空间（含备用空间）的尾端。</p>
<p>为了降低空间配置时的速度成本，vector 实际配置的大小可能比客户端需求量更大一
些，以备将来可能的扩充。这便是容量（capacity）的观念。换句话说，一个 vector
的容量永远大于或等于其大小。一旦容量等于大小，便是满载，下次再有新增元素，整
个 vectoer 就得另觅居所。</p>
</div>
<div class="section" id="vector-constructor-push-back">
<h5>4.2.5 vector 的构造与内存管理： constructor，push_back<a class="headerlink" href="#vector-constructor-push-back" title="永久链接至标题">¶</a></h5>
<p>以客户端程序代码为引导，观察其所得结果并实证源代码，是一个良好的学习路径。下
面是一个小小的测试程序，观察重点在构造的方式、元素的添加，以及大小、容量的变
化：</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id305">
<div class="code-block-caption"><span class="caption-text">4vector_test.cpp</span><a class="headerlink" href="#id305" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">34</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">36</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="linenos">40</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="linenos">44</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">ivite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ivite</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="n">iv</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ivite</span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">51</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">54</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">55</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="n">ivite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">59</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ivite</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="n">iv</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ivite</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">62</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">63</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">64</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">65</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">66</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">67</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">    </span><span class="n">iv</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="linenos">70</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size = </span><span class="se">\t\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">71</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;capacity = </span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iv</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">72</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">size</span> <span class="o">=</span>          <span class="mi">2</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">2</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">3</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">3</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">4</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">4</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">5</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">6</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">6</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">6</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">7</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
<span class="mi">9</span> <span class="mi">9</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">5</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">4</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">3</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
<span class="mi">9</span> <span class="mi">9</span> <span class="mi">2</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">6</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
<span class="mi">9</span> <span class="mi">9</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">2</span>
<span class="n">size</span> <span class="o">=</span>          <span class="mi">0</span>
<span class="n">capacity</span> <span class="o">=</span>      <span class="mi">9</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>对 vector 的任何操作，一旦引起空间重新配置，指向原 vector 的所有迭代器就
都失效了。这是程序员易犯的一个错误，务必小心。</p>
</div>
</div>
<div class="section" id="vector-pop-back-erase-clear-insert">
<h5>4.2.6 vector 的元素操作：pop_back，erase，clear，insert<a class="headerlink" href="#vector-pop-back-erase-clear-insert" title="永久链接至标题">¶</a></h5>
</div>
</div>
<div class="section" id="list">
<h4>4.3 list<a class="headerlink" href="#list" title="永久链接至标题">¶</a></h4>
<div class="section" id="id235">
<h5>4.3.1 list 概述<a class="headerlink" href="#id235" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="list-node">
<h5>4.3.2 list 的节点（node）<a class="headerlink" href="#list-node" title="永久链接至标题">¶</a></h5>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">2</span><span class="k">struct</span> <span class="nc">__list_node</span><span class="w"></span>
<span class="linenos">3</span><span class="p">{</span><span class="w"></span>
<span class="linenos">4</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">void_pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">5</span><span class="w">    </span><span class="n">void_pointer</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">      </span><span class="c1">//  类型为 void*。其实可设为 __list_node&lt;T&gt;*</span>
<span class="linenos">6</span><span class="w">    </span><span class="n">void_pointer</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="linenos">7</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>显然这是一个双向链表。</p>
</div>
<div class="section" id="id236">
<h5>4.3.3 list 的迭代器<a class="headerlink" href="#id236" title="永久链接至标题">¶</a></h5>
<p>list 不再能够像 vector 一样以普通指针作为迭代器，因为其节点不保证在存储空间
中连续存在。由于 STL list 是一个双向链表（double linked-list），迭代器必须
具备前移、后移的能力，所以 list 提供的是 <strong>Bidirectional Iterators</strong> 。</p>
<p>list 还有一个重要性质：插入（insert）操作和接合操作（splice）都不会造成原有
的 list 迭代器失效。甚至 list 的元素删除（erase）操作，也只有“指向被删除元
素”的那个迭代器失效，其它的迭代器不受任何影响。</p>
<div class="literal-block-wrapper docutils container" id="id306">
<div class="code-block-caption"><span class="caption-text">list_iterator.h</span><a class="headerlink" href="#id306" title="永久链接至代码">¶</a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#pragma once</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="cpf">&lt;cstddef&gt;</span><span class="c1">   // for ptrdiff_t, size_t</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">struct</span> <span class="nc">input_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">struct</span> <span class="nc">output_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">struct</span> <span class="nc">forward_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">input_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">struct</span> <span class="nc">bidirectional_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">forward_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 8</span><span class="k">struct</span> <span class="nc">random_access_iterator_tag</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">bidirectional_iterator_tag</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">11</span><span class="k">struct</span> <span class="nc">__list_node</span><span class="w"></span>
<span class="linenos">12</span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">void_pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">void_pointer</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">      </span><span class="c1">//  类型为 void*。其实可设为 __list_node&lt;T&gt;*</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">void_pointer</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="p">};</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Ref</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">Ptr</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">20</span><span class="k">struct</span> <span class="nc">__list_iterator</span><span class="w"></span>
<span class="linenos">21</span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__list_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">iterator</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__list_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">self</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">bidirectional_iterator_tag</span><span class="w"> </span><span class="n">iterator_category</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">difference_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Ptr</span><span class="w"> </span><span class="n">pointer</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">Ref</span><span class="w"> </span><span class="n">reference</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">__list_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">link_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="w">    </span><span class="n">link_type</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w"> </span><span class="c1">// 迭代器内部当然要有一个普通指针，指向 list 的节点</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="c1">// constructor</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">__list_iterator</span><span class="p">(</span><span class="n">link_type</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="n">__list_iterator</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">39</span><span class="w">    </span><span class="n">__list_iterator</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">iterator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">node</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">42</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">node</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="c1">// 以下对迭代器取值（dereference），取的是节点的数据值</span>
<span class="linenos">45</span><span class="w">    </span><span class="n">reference</span><span class="w"> </span><span class="k">operator</span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">).</span><span class="n">data</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="c1">// 以下是迭代器成员存取（member access）运算子的标准做法</span>
<span class="linenos">48</span><span class="w">    </span><span class="n">pointer</span><span class="w"> </span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">operator</span><span class="o">*</span><span class="p">());</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="w">    </span><span class="c1">// 对迭代器累加 1 ，就是前进一个节点</span>
<span class="linenos">51</span><span class="w">    </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">++</span><span class="p">()</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">53</span><span class="w">        </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">link_type</span><span class="p">)((</span><span class="o">*</span><span class="n">node</span><span class="p">).</span><span class="n">next</span><span class="p">);</span><span class="w"></span>
<span class="linenos">54</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">55</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">56</span><span class="w">    </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="linenos">57</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">58</span><span class="w">        </span><span class="n">self</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">59</span><span class="w">        </span><span class="o">++*</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">61</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="c1">// 对迭代器递减 1 ，就是后退一个节点</span>
<span class="linenos">64</span><span class="w">    </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">--</span><span class="p">()</span><span class="w"></span>
<span class="linenos">65</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">66</span><span class="w">        </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">link_type</span><span class="p">)((</span><span class="o">*</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">);</span><span class="w"></span>
<span class="linenos">67</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">68</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">69</span><span class="w">    </span><span class="n">self</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">--</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="linenos">70</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">71</span><span class="w">        </span><span class="n">self</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">72</span><span class="w">        </span><span class="o">--*</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="linenos">73</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">74</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">75</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id237">
<h5>4.3.4 list 的数据结构<a class="headerlink" href="#id237" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id238">
<h5>4.3.5 list 的构造与内存管理<a class="headerlink" href="#id238" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id239">
<h5>4.3.6 list 的元素操作<a class="headerlink" href="#id239" title="永久链接至标题">¶</a></h5>
</div>
</div>
</div>
</div>
<div class="section" id="open-source-projects">
<h2>Open Source Projects<a class="headerlink" href="#open-source-projects" title="永久链接至标题">¶</a></h2>
<div class="section" id="id240">
<h3><a class="reference external" href="https://github.com/OneLoneCoder/olcPixelGameEngine">olcPixelGameEngine</a><a class="headerlink" href="#id240" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="c-templates">
<h2>C++ Templates<a class="headerlink" href="#c-templates" title="永久链接至标题">¶</a></h2>
<div class="section" id="i">
<h3>第Ⅰ部分 基础<a class="headerlink" href="#i" title="永久链接至标题">¶</a></h3>
<div class="section" id="id241">
<h4>第2章 函数模板<a class="headerlink" href="#id241" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li><p>模板函数为不同的模板实参定义了一个函数家族。</p></li>
<li><p>当你传递模板实参的时候，可以根据实参的类型来对函数模板进行实例化。</p></li>
<li><p>你可以显示指定模板参数。</p></li>
<li><p>你可以重载模板函数。</p></li>
<li><p>当重载模板的时候，把你的改变限制在：显示地指定模板参数。</p></li>
<li><p>一定要让函数模板的所有重载版本的声明都位于它们被调用的位置之前。</p></li>
</ul>
</div>
<div class="section" id="id242">
<h4>第3章 类模板<a class="headerlink" href="#id242" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li><p>类模板是具有以下性质的类：在类的实现中，可以有一个或多个类型还没有被指定。</p></li>
<li><p>为了使用类模板，你可以传入某个具体类型作为模板实参；然后编译器将会基于该类型
来实例化莫模板。</p></li>
<li><p>对于类模板而言，只有那些被调用的成员函数才会被实例化。</p></li>
<li><p>你可以用某种特定类型特化类模板。</p></li>
<li><p>你可以用某种特定类型局部特化类模板。</p></li>
<li><p>你可以为类模板的参数定义缺省值，这些值还可以引用之前的模板参数。</p></li>
</ul>
</div>
<div class="section" id="id243">
<h4>第4章 非类型模板参数<a class="headerlink" href="#id243" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li><p>模板可以具有值模板参数，而不仅仅是类型模板参数。</p></li>
<li><p>对于非类型模板参数，你不能使用浮点数、class 类型的对象和内部链接对象（例如
string）作为实参。</p></li>
</ul>
</div>
<div class="section" id="id244">
<h4>第5章 技巧性基础知识<a class="headerlink" href="#id244" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id245">
<h4>第6章 模板实战<a class="headerlink" href="#id245" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id246">
<h4>第7章 模板术语<a class="headerlink" href="#id246" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="ii">
<h3>第Ⅱ部分 深入模板<a class="headerlink" href="#ii" title="永久链接至标题">¶</a></h3>
<div class="section" id="id247">
<h4>第8章 深入模板基础<a class="headerlink" href="#id247" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id248">
<h4>第9章 模板中的名称<a class="headerlink" href="#id248" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id249">
<h4>第10章 实例化<a class="headerlink" href="#id249" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id250">
<h4>第11章 模板实参演绎<a class="headerlink" href="#id250" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id251">
<h4>第12章 特化与重载<a class="headerlink" href="#id251" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id252">
<h4>第13章 未来的方向<a class="headerlink" href="#id252" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="id253">
<h3>第Ⅲ部分 模板与设计<a class="headerlink" href="#id253" title="永久链接至标题">¶</a></h3>
<div class="section" id="id254">
<h4>第14章 模板的多态威力<a class="headerlink" href="#id254" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="trait-policy">
<h4>第15章 trait 与 policy 类<a class="headerlink" href="#trait-policy" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id255">
<h4>第16章 模板与继承<a class="headerlink" href="#id255" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="metaprogram">
<h4>第17章 metaprogram<a class="headerlink" href="#metaprogram" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id256">
<h4>第18章 表示式模板<a class="headerlink" href="#id256" title="永久链接至标题">¶</a></h4>
</div>
</div>
<div class="section" id="id257">
<h3>第Ⅳ部分 高级应用程序<a class="headerlink" href="#id257" title="永久链接至标题">¶</a></h3>
<div class="section" id="id258">
<h4>第19章 类型区分<a class="headerlink" href="#id258" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id259">
<h4>第20章 智能指针<a class="headerlink" href="#id259" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="tuple">
<h4>第21章 tuple<a class="headerlink" href="#tuple" title="永久链接至标题">¶</a></h4>
</div>
<div class="section" id="id260">
<h4>第22章 函数对象和回调<a class="headerlink" href="#id260" title="永久链接至标题">¶</a></h4>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Math.html" class="btn btn-neutral float-right" title="Math" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="CMake.html" class="btn btn-neutral float-left" title="CMake" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, horizonshd.

    </p>
  </div>
    
    
    
    利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    
    由 <a href="https://readthedocs.org">Read the Docs</a>开发. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>